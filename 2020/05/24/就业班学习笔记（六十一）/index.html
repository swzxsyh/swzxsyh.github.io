<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="二维码 微信开发平台——支付 统一下单——生成预交易链接 支付结果通知 支付状态查询">
<meta property="og:type" content="article">
<meta property="og:title" content="就业班学习笔记（六十一）">
<meta property="og:url" content="http://yoursite.com/2020/05/24/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="Swzxsyh">
<meta property="og:description" content="二维码 微信开发平台——支付 统一下单——生成预交易链接 支付结果通知 支付状态查询">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pay.weixin.qq.com/wiki/doc/api/img/chapter6_5_1.png">
<meta property="og:image" content="http://yoursite.com/2020/05/24/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%E4%B8%80%EF%BC%89/image-20200524114657431.png">
<meta property="og:image" content="http://yoursite.com/2020/05/24/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%E4%B8%80%EF%BC%89/image-20200524141817661.png">
<meta property="og:image" content="http://yoursite.com/2020/05/24/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%E4%B8%80%EF%BC%89/image-20200524145558471.png">
<meta property="article:published_time" content="2020-05-24T01:02:20.000Z">
<meta property="article:modified_time" content="2020-05-24T16:16:40.110Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pay.weixin.qq.com/wiki/doc/api/img/chapter6_5_1.png">

<link rel="canonical" href="http://yoursite.com/2020/05/24/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%E4%B8%80%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>就业班学习笔记（六十一） | Swzxsyh</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Swzxsyh</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">--学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/24/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="学习笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Swzxsyh">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          就业班学习笔记（六十一）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-24 09:02:20" itemprop="dateCreated datePublished" datetime="2020-05-24T09:02:20+08:00">2020-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-25 00:16:40" itemprop="dateModified" datetime="2020-05-25T00:16:40+08:00">2020-05-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>二维码</li>
<li>微信开发平台——支付</li>
<li>统一下单——生成预交易链接</li>
<li>支付结果通知</li>
<li>支付状态查询</li>
</ul>
<a id="more"></a>

<h1 id="一-二维码"><a href="#一-二维码" class="headerlink" title="一.二维码"></a>一.二维码</h1><h4 id="1-1-什么是二维码"><a href="#1-1-什么是二维码" class="headerlink" title="1.1 什么是二维码"></a>1.1 什么是二维码</h4><p>二维码又称QR Code，QR全称Quick Response，是一个近几年来移动设备上超流行的一种编码方式， 它比传统的Bar Code条形码能存更多的信息，也能表示更多的数据类型。</p>
<h4 id="1-2-二维码优势"><a href="#1-2-二维码优势" class="headerlink" title="1.2 二维码优势"></a>1.2 二维码优势</h4><ul>
<li><p>信息容量大, 可以容纳多达1850个大写字母或2710个数字或500多个汉字 </p>
</li>
<li><p>应用范围广, 支持文字,声音,图片,指纹等等</p>
</li>
<li><p>容错能力强, 即使图片出现部分破损也能使用</p>
</li>
<li><p>成本低, 容易制作</p>
</li>
</ul>
<h4 id="1-3-二维码容错级别"><a href="#1-3-二维码容错级别" class="headerlink" title="1.3 二维码容错级别"></a>1.3 二维码容错级别</h4><ul>
<li>L级(低) 7%的码字可以被恢复。 </li>
<li>M级(中) 15%的码字可以被恢复。 </li>
<li>Q级(四分)25%的码字可以被恢复。 </li>
<li>H级(高)30% 的码字可以被恢复。</li>
</ul>
<h4 id="1-4-二维码生成插件QR-Code"><a href="#1-4-二维码生成插件QR-Code" class="headerlink" title="1.4 二维码生成插件QR Code"></a>1.4 二维码生成插件QR Code</h4><p>就与jquery开发的一个插件，QRCode是一款基于HTML5 Canvas的纯JS二维码生成插件 下载地址:<a href="https://github.com/davidshimjs/qrcodejs">https://github.com/davidshimjs/qrcodejs</a></p>
<p>QRCode.js二维码插件的可用配置参数如下:</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>默认值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>text</td>
<td>String</td>
<td>“<a href="https://www.baidu.com&quot;">https://www.baidu.com&quot;</a></td>
<td>需要编码为二维码的值</td>
</tr>
<tr>
<td>width</td>
<td>Number</td>
<td>256</td>
<td>二维码的宽度，单位像素。</td>
</tr>
<tr>
<td>height</td>
<td>Number</td>
<td>256</td>
<td>二维码的高度，单位像素。</td>
</tr>
<tr>
<td>colorLight</td>
<td>String</td>
<td>“white”</td>
<td>二维码的背景颜色。</td>
</tr>
<tr>
<td>colorDark</td>
<td>String</td>
<td>“black”</td>
<td>二维码的前景颜色。</td>
</tr>
<tr>
<td>correctLevel</td>
<td>String</td>
<td>QRCode.CorrectLevel.L</td>
<td>二维码的误差校正级别(L, M, Q, H)。</td>
</tr>
</tbody></table>
<ul>
<li><p>快速入门</p>
<ul>
<li><p>从资料中将js文件复制到项目中</p>
</li>
<li><p>QRCodeTest.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../../../src/main/webapp/js/jquery-3.3.1.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../../../src/main/webapp/js/qrcode.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"qrcode"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        // 参数一 div的id ， 参数二 将xxxx生成二维码</span><br><span class="line">        // let qrCode = new QRCode('qrCode','https://www.baidu.com');</span><br><span class="line">    </span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">var</span> qrcode = <span class="keyword">new</span> QRCode(<span class="built_in">document</span>.getElementById(<span class="string">"qrcode"</span>), &#123;</span></span><br><span class="line"><span class="actionscript">            text: <span class="string">"http://jindo.dev.naver.com/collie"</span>,</span></span><br><span class="line">            width: 128,</span><br><span class="line">            height: 128,</span><br><span class="line"><span class="actionscript">            colorDark : <span class="string">"#000000"</span>,</span></span><br><span class="line"><span class="actionscript">            colorLight : <span class="string">"#ffffff"</span>,</span></span><br><span class="line">            correctLevel : QRCode.CorrectLevel.H</span><br><span class="line">          &#125;);</span><br><span class="line">      <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h1 id="二-微信扫描支付简介"><a href="#二-微信扫描支付简介" class="headerlink" title="二.微信扫描支付简介"></a>二.微信扫描支付简介</h1><h4 id="2-1-微信扫码支付申请"><a href="#2-1-微信扫码支付申请" class="headerlink" title="2.1 微信扫码支付申请"></a>2.1 微信扫码支付申请</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">微信扫码支付是商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。</span><br><span class="line">该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。</span><br><span class="line"></span><br><span class="line">申请步骤:</span><br><span class="line"></span><br><span class="line">- 第一步:注册公众号(类型须为:服务号)</span><br><span class="line"></span><br><span class="line">请根据营业执照类型选择以下主体注册:个体工商户| 企业&#x2F;公司| 政府| 媒体| 其他类型。</span><br><span class="line"></span><br><span class="line">- 第二步:认证公众号</span><br><span class="line"></span><br><span class="line">公众号认证后才可申请微信支付，认证费:300元&#x2F;次。</span><br><span class="line"></span><br><span class="line">- 第三步:提交资料申请微信支付</span><br><span class="line"></span><br><span class="line">登录公众平台，点击左侧菜单【微信支付】，开始填写资料等待审核，审核时间为1-5个工作日内。</span><br><span class="line"></span><br><span class="line">- 第四步:开户成功，登录商户平台进行验证</span><br><span class="line"></span><br><span class="line">资料审核通过后，请登录联系人邮箱查收商户号和密码，并登录商户平台填写财付通备付金打的小额资 金数额，完成账户验证。</span><br><span class="line"></span><br><span class="line">- 第五步:在线签署协议</span><br><span class="line"></span><br><span class="line">本协议为线上电子协议，签署后方可进行交易及资金结算，签署完立即生效。</span><br></pre></td></tr></table></figure>



<h4 id="2-2-开发文档"><a href="#2-2-开发文档" class="headerlink" title="2.2 开发文档"></a>2.2 开发文档</h4><ul>
<li><p>在线微信支付开发文档:</p>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/index.html">https://pay.weixin.qq.com/wiki/doc/api/index.html</a></p>
<img src="https://pay.weixin.qq.com/wiki/doc/api/img/chapter6_5_1.png"/>
</li>
<li><p>微信支付接口调用的整体思路:</p>
<ul>
<li><p>1、商户生成订单</p>
</li>
<li><p>2、商户调用微信下单接口，获取预交易的链接 </p>
</li>
<li><p>3、商户将链接生成二维码图片，展示给用户;</p>
</li>
<li><p>4、支付结果通知:</p>
<p>微信异步通知商户支付结果，商户告知微信支付接收情况</p>
<p>商户如果没有收到通知，可以调用接口，查询支付状态 </p>
</li>
<li><p>5、如果支付成功，发货，修改订单状态</p>
</li>
</ul>
</li>
</ul>
<h4 id="2-3-API"><a href="#2-3-API" class="headerlink" title="2.3 API"></a>2.3 API</h4><h5 id="2-3-1-统一下单"><a href="#2-3-1-统一下单" class="headerlink" title="2.3.1 统一下单"></a>2.3.1 统一下单</h5><ul>
<li><p>请求路径</p>
<p>POST , URL地址:<a href="https://api.mch.weixin.qq.com/pay/unifiedorder">https://api.mch.weixin.qq.com/pay/unifiedorder</a></p>
</li>
<li><p>请求参数</p>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1">https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1</a></p>
<table>
<thead>
<tr>
<th align="left">字段名</th>
<th>变量名</th>
<th>必填</th>
<th>类型</th>
<th>示例值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">公众账号ID</td>
<td>appid</td>
<td>是</td>
<td>String(32)</td>
<td>wxd678efh56</td>
<td>微信支付分配的公众账号ID</td>
</tr>
<tr>
<td align="left">商户号</td>
<td>mch_id</td>
<td>是</td>
<td>String(32)</td>
<td>1230000109</td>
<td>微信支付分配的商户号</td>
</tr>
<tr>
<td align="left">随机字符串</td>
<td>nonce_str</td>
<td>是</td>
<td>String(32)</td>
<td>5K8264ILT</td>
<td>随机字符串，长度要求在32位以内</td>
</tr>
<tr>
<td align="left">签名</td>
<td>sign</td>
<td>是</td>
<td>String(32)</td>
<td>C380BEC2B</td>
<td>通过签名算法计算得出的签名值</td>
</tr>
<tr>
<td align="left">商品描述</td>
<td>body</td>
<td>是</td>
<td>String(128)</td>
<td>华为手机</td>
<td>商品简单描述</td>
</tr>
<tr>
<td align="left">商户订单号</td>
<td>out_trade_no</td>
<td>是</td>
<td>String(32)</td>
<td>20150806125</td>
<td>商户系统内部订单号</td>
</tr>
<tr>
<td align="left">标价金额</td>
<td>total_fee</td>
<td>是</td>
<td>Int</td>
<td>88</td>
<td>订单总金额，单位为分</td>
</tr>
<tr>
<td align="left">终端IP</td>
<td>spbill_create_ip</td>
<td>是</td>
<td>String(16)</td>
<td>123.12.12.123</td>
<td>APP和网页支付提交用户端ip，Native支付填调用微信支付API的机器IP。</td>
</tr>
<tr>
<td align="left">通知地址</td>
<td>notify_url</td>
<td>是</td>
<td>String(256)</td>
<td><a href="http://www.weixin.qq.com/wxpay/pay.php">http://www.weixin.qq.com/wxpay/pay.php</a></td>
<td>异步接收微信支付结果通知的回调地址，通知url必须为外网可访问的url，不能携带参数。</td>
</tr>
<tr>
<td align="left">交易类型</td>
<td>trade_type</td>
<td>是</td>
<td>String(16)</td>
<td>JSAPI</td>
<td>JSAPI 公众号支付；NATIVE 扫码支付</td>
</tr>
</tbody></table>
</li>
<li><p>这些参数大致分成3类</p>
<ul>
<li>appid、mch_id、spbill_create_ip、notify_url、trade_type:是商家自己的信息或固定数据，可以提前配置，因此无需每次请求单独配置，而是统一设置好即可。</li>
<li>nonce_str、sign:是为了保证数据安全而添加的验证数据，根据算法去生成，每次请求自动生成 即可。</li>
<li>body、out_trade_no、total_fee:订单相关信息，需要我们自己填写。</li>
</ul>
</li>
</ul>
<h5 id="2-3-2-支付结果通知"><a href="#2-3-2-支付结果通知" class="headerlink" title="2.3.2 支付结果通知"></a>2.3.2 支付结果通知</h5><p>支付完成后，微信会把相关支付结果和用户信息发送给商户，商户需要接收处理，并返回应答。 </p>
<p>微信服务会自动向 notify_url 地址发起POST请求:</p>
<ul>
<li><p>通知参数</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>变量名</th>
<th>必填</th>
<th>类型</th>
<th>示例值</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>返回状态码</td>
<td>return_code</td>
<td>是</td>
<td>String(16)</td>
<td>SUCCESS</td>
<td>SUCCESS/FAIL此字段是通信标识，非交易标识，交易是否成功需要查看trade_state来判断</td>
</tr>
<tr>
<td>返回信息</td>
<td>return_msg</td>
<td>是</td>
<td>String(128)</td>
<td>OK</td>
<td>当return_code为FAIL时返回信息为错误原因 ，例如签名失败参数格式校验错误</td>
</tr>
</tbody></table>
<p>通信成功，会返回下面信息：</p>
<table>
<thead>
<tr>
<th align="left">字段名</th>
<th align="left">变量名</th>
<th align="left">必填</th>
<th align="left">类型</th>
<th align="left">示例值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">商户订单号</td>
<td align="left">out_trade_no</td>
<td align="left">是</td>
<td align="left">String(32)</td>
<td align="left">1212321</td>
<td align="left">商户系统内部订单号，要求32个字符内</td>
</tr>
<tr>
<td align="left">业务结果</td>
<td align="left">result_code</td>
<td align="left">是</td>
<td align="left">String(16)</td>
<td align="left">SUCCESS</td>
<td align="left">SUCCESS/FAIL</td>
</tr>
</tbody></table>
</li>
<li><p>我们需要返回给微信的参数</p>
<table>
<thead>
<tr>
<th align="left">字段名</th>
<th align="left">变量名</th>
<th align="left">必填</th>
<th align="left">类型</th>
<th align="left">示例值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">返回状态码</td>
<td align="left">return_code</td>
<td align="left">是</td>
<td align="left">String(16)</td>
<td align="left">SUCCESS</td>
<td align="left">请按示例值填写</td>
</tr>
<tr>
<td align="left">返回信息</td>
<td align="left">return_msg</td>
<td align="left">是</td>
<td align="left">String(128)</td>
<td align="left">OK</td>
<td align="left">请按示例值填写</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">return_code</span>&gt;</span>&lt;![CDATA[SUCCESS]]&gt;<span class="tag">&lt;/<span class="name">return_code</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">return_msg</span>&gt;</span>&lt;![CDATA[OK]]&gt;<span class="tag">&lt;/<span class="name">return_msg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<h4 id="2-4-SDK"><a href="#2-4-SDK" class="headerlink" title="2.4 SDK"></a>2.4 SDK</h4><ul>
<li><p>官方已经提供了SDK，供我们使用</p>
<p><a href="https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=11_1">https://pay.weixin.qq.com/wiki/doc/api/micropay.php?chapter=11_1</a></p>
</li>
<li><p>但是微信没有提供maven仓库坐标，因此我们必须下载使用</p>
<p>自定义PayConfig实现，定义:公众号id、商户号、账户签名，打包</p>
</li>
<li><p>打包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn <span class="built_in">source</span>:jar install -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在travel中引入坐标</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wxpay<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wxpay-sdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>简化API参数的Util</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> WXPay wxPay;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支付成功回调地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String notifyUrl = <span class="string">"自行定义"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化微信支付</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PayConfig payConfig = <span class="keyword">new</span> PayConfig();</span><br><span class="line">            payConfig.setAppID(<span class="string">"自行申请"</span>); <span class="comment">// 公众账号ID</span></span><br><span class="line">            payConfig.setMchID(<span class="string">"自行申请"</span>);<span class="comment">// 商户号</span></span><br><span class="line">            payConfig.setKey(<span class="string">"自行申请"</span>);<span class="comment">// 生成签名的密钥</span></span><br><span class="line">            wxPay = <span class="keyword">new</span> WXPay(payConfig);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// e.printStackTrace();</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成微信订单支付 url</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createOrder</span><span class="params">(String orderId, Integer totalPay)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// 商品描述</span></span><br><span class="line">        data.put(<span class="string">"body"</span>, <span class="string">"支付中心-商品支付"</span>);</span><br><span class="line">        <span class="comment">// 订单号</span></span><br><span class="line">        data.put(<span class="string">"out_trade_no"</span>, orderId);</span><br><span class="line">        <span class="comment">//金额，单位是分</span></span><br><span class="line">        data.put(<span class="string">"total_fee"</span>, totalPay.toString());</span><br><span class="line">        <span class="comment">//调用微信支付的终端IP</span></span><br><span class="line">        data.put(<span class="string">"spbill_create_ip"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line">        <span class="comment">//回调地址</span></span><br><span class="line">        data.put(<span class="string">"notify_url"</span>, notifyUrl);</span><br><span class="line">        <span class="comment">// 支付有效时间10分钟</span></span><br><span class="line">        Date now = <span class="keyword">new</span> Date();</span><br><span class="line">        Date now_10 = <span class="keyword">new</span> Date(now.getTime() + <span class="number">600000</span>); <span class="comment">//10分钟后的时间</span></span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMddHHmmss"</span>);<span class="comment">//可以方便地修改日期格式</span></span><br><span class="line">        String nowTime_10 = dateFormat.format(now_10);</span><br><span class="line">        data.put(<span class="string">"time_expire"</span>, nowTime_10);</span><br><span class="line">        <span class="comment">// 交易类型为扫码支付</span></span><br><span class="line">        data.put(<span class="string">"trade_type"</span>, <span class="string">"NATIVE"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 利用wxPay工具,完成下单</span></span><br><span class="line">        Map&lt;String, String&gt; result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = wxPay.unifiedOrder(data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"微信下单失败"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 校验业务状态</span></span><br><span class="line">        checkResultCode(result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下单成功，获取支付链接</span></span><br><span class="line">        String url = result.get(<span class="string">"code_url"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(url)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"微信下单失败，支付链接为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查业务状态</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkResultCode</span><span class="params">(Map&lt;String, String&gt; result)</span> </span>&#123;</span><br><span class="line">        String resultCode = result.get(<span class="string">"result_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"FAIL"</span>.equals(resultCode)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"【微信支付】微信支付业务失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="三-统一下单实现"><a href="#三-统一下单实现" class="headerlink" title="三.统一下单实现"></a>三.统一下单实现</h1><h4 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a>3.1 需求分析</h4><table>
<thead>
<tr>
<th>用户</th>
<th></th>
<th>Servet</th>
<th></th>
<th>微信平台</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>提交订单➡</td>
<td>OrderServlet<br>将订单和订单项保存到数据库<br>重定向到微信支付的Servlet</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>PayServlet<br/>接收参数:订单号和支付金额<br/>调用支付工具类，发送请求，生成预交易url<br/>将数据设置到request域<br/>转发到pay.jsp页面</td>
<td>➡发送xml数据<br/>⬅返回xml数据</td>
<td></td>
</tr>
<tr>
<td></td>
<td>⬅响应</td>
<td>Pay.jsp<br/>二维码å</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-2-代码实现"><a href="#3-2-代码实现" class="headerlink" title="3.2 代码实现"></a>3.2 代码实现</h4><ul>
<li><p>OrderServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createOrder</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">  Date orderDate = <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1.接收请求参数</span></span><br><span class="line">  String addressId = req.getParameter(<span class="string">"addressId"</span>);</span><br><span class="line">  <span class="comment">// 前端数据分割，分别为：收货人，收货地址，收货电话</span></span><br><span class="line">  String[] addressArray = addressId.split(<span class="string">","</span>);</span><br><span class="line">  <span class="comment">// 2.获取session中的user</span></span><br><span class="line">  User currentUser = (User) req.getSession().getAttribute(<span class="string">"currentUser"</span>);</span><br><span class="line">  <span class="comment">// 3.获取redis中cart</span></span><br><span class="line">  Cart cart = CartUtils.getCartForRedis(currentUser);</span><br><span class="line">  <span class="comment">// 4.创建订单，设置基础数据</span></span><br><span class="line">  Order order = <span class="keyword">new</span> Order();</span><br><span class="line">  <span class="comment">// 订单号</span></span><br><span class="line">  order.setOid(IdUtil.simpleUUID());</span><br><span class="line">  <span class="comment">// 下单时间</span></span><br><span class="line">  order.setOrdertime(orderDate);</span><br><span class="line">  <span class="comment">// 订单总金额</span></span><br><span class="line">  order.setTotal(cart.getCartTotal());</span><br><span class="line">  <span class="comment">// 未支付订单</span></span><br><span class="line">  order.setState(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 收货人</span></span><br><span class="line">  order.setContact(addressArray[<span class="number">0</span>]);</span><br><span class="line">  <span class="comment">// 收货地址</span></span><br><span class="line">  order.setAddress(addressArray[<span class="number">1</span>]);</span><br><span class="line">  <span class="comment">// 收货电话</span></span><br><span class="line">  order.setTelephone(addressArray[<span class="number">2</span>]);</span><br><span class="line">  <span class="comment">// 为了简化所属用户操作，我们可以直接设置uid</span></span><br><span class="line">  order.setUid(currentUser.getUid());</span><br><span class="line">  <span class="comment">// 5.遍历购物项，创建订单项</span></span><br><span class="line">  List&lt;OrderItem&gt; orderItemList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  OrderItem orderItem = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// 遍历购物项</span></span><br><span class="line">  <span class="keyword">for</span> (CartItem cartItem : cart.getCartItemMap().values()) &#123;</span><br><span class="line">    <span class="comment">// 创建订单项</span></span><br><span class="line">    orderItem = <span class="keyword">new</span> OrderItem();</span><br><span class="line">    <span class="comment">// 下单时间</span></span><br><span class="line">    orderItem.setItemtime(orderDate);</span><br><span class="line">    <span class="comment">// 未支付</span></span><br><span class="line">    orderItem.setState(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 数量</span></span><br><span class="line">    orderItem.setNum(cartItem.getNum());</span><br><span class="line">    <span class="comment">// 商品小计</span></span><br><span class="line">    orderItem.setSubtotal(cartItem.getSubTotal());</span><br><span class="line">    <span class="comment">// 商品rid ，简化数据库操作</span></span><br><span class="line">    orderItem.setRid(cartItem.getRoute().getRid());</span><br><span class="line">    <span class="comment">// 订单oid，简化数据操作</span></span><br><span class="line">    orderItem.setOid(order.getOid());</span><br><span class="line">    <span class="comment">// 添加到订单项集合中</span></span><br><span class="line">    orderItemList.add(orderItem);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将订单项集合关联到订单实体中</span></span><br><span class="line">  order.setOrderItemList(orderItemList);</span><br><span class="line">  <span class="comment">// 6.调用service，保存到数据库</span></span><br><span class="line">  orderService.save(order);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 7.清空购物车</span></span><br><span class="line">  Jedis jedis = JedisUtils.getJedis();</span><br><span class="line">  jedis.del(<span class="string">"cart_"</span>+currentUser.getUsername());</span><br><span class="line">  jedis.close();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 8.重定向支付页面</span></span><br><span class="line">  <span class="comment">//        resp.sendRedirect(req.getContextPath()+"/pay.jsp");</span></span><br><span class="line">  resp.sendRedirect(req.getContextPath()+<span class="string">"/PayServlet?action=createUrl&amp;oid="</span>+order.getOid()+<span class="string">"&amp;price="</span>+order.getTotal());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>PayServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(<span class="string">"/PayServlet"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayServlet</span> <span class="keyword">extends</span> <span class="title">BaseServlet</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">xx</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用微信平台，生成预交易链接</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createUrl</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 1.接收请求参数</span></span><br><span class="line">        String oid = req.getParameter(<span class="string">"oid"</span>);</span><br><span class="line">        String price = req.getParameter(<span class="string">"price"</span>);</span><br><span class="line">        <span class="comment">// 2.调用微信平台，生成预交易链接</span></span><br><span class="line">        String pay_url = PayUtils.createOrder(oid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.将数据设置到request域</span></span><br><span class="line">        req.setAttribute(<span class="string">"oid"</span>,oid);</span><br><span class="line">        req.setAttribute(<span class="string">"price"</span>,price);</span><br><span class="line">        req.setAttribute(<span class="string">"pay_url"</span>,pay_url);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.转发到支付页面</span></span><br><span class="line">        req.getRequestDispatcher(<span class="string">"/pay.jsp"</span>).forward(req,resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>pay.jsp</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"IE=edge"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/css/webbase.css"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/css/pages-weixinpay.css"</span>&gt;</span><br><span class="line">    &lt;title&gt;微信支付&lt;/title&gt;</span><br><span class="line">    &lt;script src="$&#123;pageContext.request.contextPath&#125;/js/qrcode.min.js"&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;!--引入头部--&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"header.jsp"</span>%&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container-fluid"</span>&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"cart py-container"</span>&gt;</span><br><span class="line">        &lt;!--主内容--&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"checkout py-container  pay"</span>&gt;</span><br><span class="line">          &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"checkout-tit"</span>&gt;</span><br><span class="line">            &lt;h4 class="fl tit-txt"&gt;&lt;span class="success-icon"&gt;&lt;/span&gt;&lt;span  class="success-info"&gt;订单提交成功，请您及时付款！订单号：$&#123;oid&#125;&lt;/span&gt;&lt;/h4&gt;</span><br><span class="line">            &lt;span class="fr"&gt;&lt;em class="sui-lead"&gt;应付金额：&lt;/em&gt;&lt;em  class="orange money"&gt;￥$&#123;price&#125;&lt;/em&gt;元&lt;/span&gt;</span><br><span class="line">            &lt;div class="clearfix"&gt;&lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"checkout-steps"</span>&gt;</span><br><span class="line">            &lt;div class="fl weixin"&gt;微信支付&lt;/div&gt;</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"fl sao"</span>&gt;</span><br><span class="line">              &lt;p class="red" style="padding-bottom: 40px"&gt;二维码已过期，刷新页面重新获取二维码。&lt;/p&gt;</span><br><span class="line">              &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"fl code"</span>&gt;</span><br><span class="line">                &lt;div id="qrCode"&gt;&lt;/div&gt;</span><br><span class="line">                &lt;script&gt;</span><br><span class="line">                  let qrCode=<span class="keyword">new</span> QRCode(<span class="string">'qrCode'</span>,<span class="string">'$&#123;pay_url&#125;'</span>)</span><br><span class="line">                &lt;/script&gt;</span><br><span class="line">                &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"saosao"</span>&gt;</span><br><span class="line">                  &lt;p&gt;请使用微信扫一扫&lt;/p&gt;</span><br><span class="line">                  &lt;p&gt;扫描二维码支付&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">              &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"fl"</span> style=<span class="string">"background:url(./img/phone-bg.png) no-repeat;width:350px;height:400px;margin-left:40px"</span>&gt;</span><br><span class="line"></span><br><span class="line">              &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class="clearfix"&gt;&lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;!--引入尾部--&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"footer.jsp"</span>%&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="四-支付结果通知实现"><a href="#四-支付结果通知实现" class="headerlink" title="四.支付结果通知实现"></a>四.支付结果通知实现</h1><h4 id="4-1-notify-url"><a href="#4-1-notify-url" class="headerlink" title="4.1 notify_url"></a>4.1 notify_url</h4><table>
<thead>
<tr>
<th>通知地址</th>
<th>notify_url</th>
<th>是</th>
<th>String(256)</th>
<th><a href="http://www.weixin.qq.com/wxpay/pay.php">http://www.weixin.qq.com/wxpay/pay.php</a></th>
<th>异步接收微信支付结果通知的回调地址，通知url必须为外网可访问的url，不能携带参数。</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>这个地址是在支付成功后的异步结果通知。</p>
<p>官网介绍如下: 支付完成后，微信会把相关支付结果和用户信息发送给商户，商户需要接收处理，并返回应答。 </p>
<p>所以，此处的地址必须是一个外网可访问地址，而且我们要定义好回调的处理接口。</p>
<p> <a href="http://localhost:8080/travel/pay/notify">http://localhost:8080/travel/pay/notify</a> </p>
<p><strong>注意</strong>:通知url必须为直接可访问的url，不能携带参数</p>
<h4 id="4-2-内网穿透"><a href="#4-2-内网穿透" class="headerlink" title="4.2 内网穿透"></a>4.2 内网穿透</h4><ul>
<li><p>内网穿透:</p>
<p>让外网能访问你本地的应用，例如在外网打开你本地<a href="http://127.0.0.1的指向Web站点">http://127.0.0.1的指向Web站点</a></p>
</li>
<li><p>配置url回调地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> WXPay wxPay;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支付成功回调地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String notifyUrl = <span class="string">"http://xxxxxxxx.xxxxx.xxx/travel/PayNotifyServlet"</span>;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="4-3-需求分析"><a href="#4-3-需求分析" class="headerlink" title="4.3 需求分析"></a>4.3 需求分析</h4><table>
<thead>
<tr>
<th>用户</th>
<th>➡</th>
<th>微信平台</th>
<th>➡</th>
<th><a href="http://xxxxxxxx.xxxxx.xxx/travel/PayNotifyServlet">http://xxxxxxxx.xxxxx.xxx/travel/PayNotifyServlet</a></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td>微信平台受到钱后，根据发送时指定的回调地址，返回支付成功信息</td>
<td></td>
<td>@WebServlet(“/PayNotifyServlet”)<br>接受请求xml，转为map<br/>调用service，修改订单状态<br/>返回接受成功ok消息</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td>OrderServlet<br>根据oid修改state(OrderDao)<br>根据oid修改state(OrderItemDao)</td>
</tr>
</tbody></table>
<h4 id="4-4-代码实现"><a href="#4-4-代码实现" class="headerlink" title="4.4 代码实现"></a>4.4 代码实现</h4><ul>
<li><p>PayNotifyServlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(<span class="string">"/PayNotifyServlet"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayNotifyServlet</span> <span class="keyword">extends</span> <span class="title">BaseServlet</span></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">xxx</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  OrderService orderService= (OrderService) BeanFactory.getBean(<span class="string">"orderService"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1.接收请求参数(xml)</span></span><br><span class="line">    ServletInputStream in = request.getInputStream();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.将xml转为java对象</span></span><br><span class="line">    XmlMapper xmlMapper = <span class="keyword">new</span> XmlMapper();</span><br><span class="line">    Map param = xmlMapper.readValue(in, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.调用orderService，修改订单状态</span></span><br><span class="line">    orderService.updateState(param);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.返回微信平台，接收成功</span></span><br><span class="line">    Map&lt;String , String &gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    result.put(<span class="string">"return_code"</span>,<span class="string">"SUCESS"</span>);</span><br><span class="line">    result.put(<span class="string">"return_msg"</span>,<span class="string">"OK"</span>);</span><br><span class="line"></span><br><span class="line">    String xml = xmlMapper.writeValueAsString(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将map转为xml</span></span><br><span class="line">    response.setContentType(<span class="string">"application/xml;charset=utf-8"</span>);</span><br><span class="line">    response.getWriter().write(xml);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>OrderService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateState</span><span class="params">(Map&lt;String, String&gt; param)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateState</span><span class="params">(Map&lt;String, String&gt; param)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1.获取订单号</span></span><br><span class="line">    String oid = param.get(<span class="string">"out_trade_no"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2.修改订单状态</span></span><br><span class="line">    SqlSession sqlSession = MyBatisUtils.openSession();</span><br><span class="line">    OrderDao orderDao = sqlSession.getMapper(OrderDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    OrderItemDao orderItemDao = sqlSession.getMapper(OrderItemDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改订单</span></span><br><span class="line">    orderDao.updateState(oid);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 修改订单项</span></span><br><span class="line">    orderItemDao.updateState(oid);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 关闭会话</span></span><br><span class="line">    MyBatisUtils.close(sqlSession);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>OrderDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateState</span><span class="params">(String oid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderDao.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.itheima.dao.OrderDao"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"save"</span>&gt;</span></span><br><span class="line">        INSERT INTO tab_order(oid,ordertime,total,state,address,contact,telephone,uid)</span><br><span class="line">        VALUES (#&#123;oid&#125;,#&#123;ordertime&#125;,#&#123;total&#125;,#&#123;state&#125;,#&#123;address&#125;,#&#123;contact&#125;,#&#123;telephone&#125;,#&#123;uid&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateState"</span>&gt;</span></span><br><span class="line">        UPDATE tab_order SET state=1 WHERE oid=#&#123;oid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>OrderItemDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderItemDao</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(OrderItem orderItem)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateState</span><span class="params">(String oid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderItemDao.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.itheima.dao.OrderItemDao"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"save"</span>&gt;</span></span><br><span class="line">        INSERT INTO tab_orderitem(itemtime,state,num,subtotal,rid,oid)</span><br><span class="line">        VALUES (#&#123;itemtime&#125;,#&#123;state&#125;,#&#123;num&#125;,#&#123;subtotal&#125;,#&#123;rid&#125;,#&#123;oid&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateState"</span>&gt;</span></span><br><span class="line">        UPDATE tab_orderitem SET state=1 WHERE oid =#&#123;oid&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="五-支付状态查询"><a href="#五-支付状态查询" class="headerlink" title="五.支付状态查询"></a>五.支付状态查询</h1><h4 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h4><p><img src="image-20200524114657431.png" alt=""></p>
<h4 id="5-2-代码实现"><a href="#5-2-代码实现" class="headerlink" title="5.2 代码实现"></a>5.2 代码实现</h4><ul>
<li><p>pay.jsp</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"IE=edge"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/css/webbase.css"</span>&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/css/pages-weixinpay.css"</span>&gt;</span><br><span class="line">    &lt;title&gt;微信支付&lt;/title&gt;</span><br><span class="line">    &lt;script src="$&#123;pageContext.request.contextPath&#125;/js/qrcode.min.js"&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;!--引入头部--&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"header.jsp"</span>%&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"container-fluid"</span>&gt;</span><br><span class="line">      &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"cart py-container"</span>&gt;</span><br><span class="line">        &lt;!--主内容--&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"checkout py-container  pay"</span>&gt;</span><br><span class="line">          &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"checkout-tit"</span>&gt;</span><br><span class="line">            &lt;h4 class="fl tit-txt"&gt;&lt;span class="success-icon"&gt;&lt;/span&gt;&lt;span  class="success-info"&gt;订单提交成功，请您及时付款！订单号：$&#123;oid&#125;&lt;/span&gt;&lt;/h4&gt;</span><br><span class="line">            &lt;span class="fr"&gt;&lt;em class="sui-lead"&gt;应付金额：&lt;/em&gt;&lt;em  class="orange money"&gt;￥$&#123;price&#125;&lt;/em&gt;元&lt;/span&gt;</span><br><span class="line">            &lt;div class="clearfix"&gt;&lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"checkout-steps"</span>&gt;</span><br><span class="line">            &lt;div class="fl weixin"&gt;微信支付&lt;/div&gt;</span><br><span class="line">            &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"fl sao"</span>&gt;</span><br><span class="line">              &lt;p class="red" style="padding-bottom: 40px"&gt;二维码已过期，刷新页面重新获取二维码。&lt;/p&gt;</span><br><span class="line">              &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"fl code"</span>&gt;</span><br><span class="line">                &lt;div id="qrCode"&gt;&lt;/div&gt;</span><br><span class="line">                &lt;script&gt;</span><br><span class="line">                  let qrCode=<span class="keyword">new</span> QRCode(<span class="string">'qrCode'</span>,<span class="string">'$&#123;pay_url&#125;'</span>)</span><br><span class="line">                &lt;/script&gt;</span><br><span class="line">                &lt;%--                        &lt;img src=<span class="string">"img/erweima.png"</span> alt=<span class="string">""</span>&gt;--%&gt;</span><br><span class="line">                &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"saosao"</span>&gt;</span><br><span class="line">                  &lt;p&gt;请使用微信扫一扫&lt;/p&gt;</span><br><span class="line">                  &lt;p&gt;扫描二维码支付&lt;/p&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">              &lt;/div&gt;</span><br><span class="line">              &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"fl"</span> style=<span class="string">"background:url(./img/phone-bg.png) no-repeat;width:350px;height:400px;margin-left:40px"</span>&gt;</span><br><span class="line"></span><br><span class="line">              &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class="clearfix"&gt;&lt;/div&gt;</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">      <span class="comment">// 每间隔五秒查询支付状态</span></span><br><span class="line">      setInterval(function () &#123;</span><br><span class="line">        <span class="comment">// 发送ajax请求</span></span><br><span class="line">        let url = <span class="string">'$&#123;pageContext.request.contextPath&#125;/OrderServlet'</span>;</span><br><span class="line">        let data = <span class="string">'action=findState&amp;oid=$&#123;oid&#125;'</span></span><br><span class="line">        $.post(url,data,function (resp) &#123;</span><br><span class="line">          <span class="keyword">if</span>(resp.success)&#123;</span><br><span class="line">            <span class="comment">// 支付成功</span></span><br><span class="line">            location.href=<span class="string">'$&#123;pageContext.request.contextPath&#125;/pay_success.jsp'</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果用户10分钟内未支付，则跳转失败页面</span></span><br><span class="line">      setTimeout(function () &#123;</span><br><span class="line">        location.href=<span class="string">'$&#123;pageContext.request.contextPath&#125;/pay_fail.jsp'</span>;</span><br><span class="line">      &#125;,<span class="number">1000</span>*<span class="number">10</span>*<span class="number">60</span>)</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;!--引入尾部--&gt;</span><br><span class="line">    &lt;%<span class="meta">@include</span> file=<span class="string">"footer.jsp"</span>%&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderSerlvet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询订单支付状态</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">findState</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">  <span class="comment">// 1.接收请求参数 oid</span></span><br><span class="line">  String oid = req.getParameter(<span class="string">"oid"</span>);</span><br><span class="line">  <span class="comment">// 2.调用service查询</span></span><br><span class="line">  ResultInfo resultInfo = orderService.findState(oid);</span><br><span class="line">  <span class="comment">// 3.转为json响应到客户的</span></span><br><span class="line">  javaToJsonWriteClient(resultInfo,resp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateState</span><span class="params">(Map&lt;String, String&gt; param)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ResultInfo <span class="title">findState</span><span class="params">(String oid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>OrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultInfo <span class="title">findState</span><span class="params">(String oid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取代理对象</span></span><br><span class="line">    SqlSession sqlSession = MyBatisUtils.openSession();</span><br><span class="line">    OrderDao orderDao = sqlSession.getMapper(OrderDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  </span><br><span class="line">    ResultInfo resultInfo = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 查询dao</span></span><br><span class="line">    Order order = orderDao.findByOid(oid);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span>(order.getState() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">// 未支付</span></span><br><span class="line">        resultInfo = <span class="keyword">new</span> ResultInfo(<span class="keyword">false</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 已支付</span></span><br><span class="line">        resultInfo = <span class="keyword">new</span> ResultInfo(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭会话</span></span><br><span class="line">    MyBatisUtils.close(sqlSession);</span><br><span class="line">    <span class="keyword">return</span> resultInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>OrderDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(Order order)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">updateState</span><span class="params">(String oid)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Order <span class="title">findByOid</span><span class="params">(String oid)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>OrderDao.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByOid"</span> <span class="attr">resultType</span>=<span class="string">"com.itheima.domain.Order"</span>&gt;</span></span><br><span class="line">  SELECT * FROM tab_order WHERE oid=#&#123;oid&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="六-日志记录功能"><a href="#六-日志记录功能" class="headerlink" title="六.日志记录功能"></a>六.日志记录功能</h1><h4 id="6-1-介绍"><a href="#6-1-介绍" class="headerlink" title="6.1 介绍"></a>6.1 介绍</h4><h4 id="6-2-方法增强"><a href="#6-2-方法增强" class="headerlink" title="6.2 方法增强"></a>6.2 方法增强</h4><ul>
<li>继承</li>
<li>装饰器模式:必须手动编写装饰器实现类，进行增强</li>
<li>代理模式:不需要手动编写增强的实现类</li>
</ul>
<h4 id="6-3-动态代理"><a href="#6-3-动态代理" class="headerlink" title="6.3 动态代理"></a>6.3 动态代理</h4><ul>
<li><p>jdk动态代理:要求目标对象和代理对象实现同一个接口【基于接口来创建代理类】</p>
</li>
<li><p>cglib动态代理:可以对任意的普通类创建出代理对象【基于继承的思想】</p>
<p><img src="image-20200524141817661.png" alt=""></p>
</li>
</ul>
<p>sun公司提供了一套工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Object proxy =</span><br><span class="line">  Proxy.newProxyInstance(ClassLoader loader, 类&lt;?&gt;[] interfaces,</span><br><span class="line">                         InvocationHandler h);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参数:</span></span><br><span class="line"><span class="comment">1.loader:使用目标对象的类加载器 2.interfaces:使用目标对象的实现接口数组 3.h:处理器接口(实现方法增强的业务逻辑细节)</span></span><br><span class="line"><span class="comment">匿名内部类、lambda表达式 返回值:代理对象</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>回顾动态代理的实现思路</p>
<ul>
<li><p>定义接口规范</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TargetInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sing</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<ul>
<li><p>定义目标对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiangLiang</span> <span class="keyword">implements</span> <span class="title">TargetInterface</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sing</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">"Singing...."</span>);</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>创建代理对象并测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 传统方式</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    TargetInterface liangLiang = <span class="keyword">new</span> LiangLiang();</span><br><span class="line">    liangLiang.sing(); &#125;</span><br><span class="line">  <span class="comment">// 动态代理</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建目标对象</span></span><br><span class="line">    TargetInterface liangLiang = <span class="keyword">new</span> LiangLiang(); <span class="comment">// 2.创建代理对象</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">1.loader:目标对象的类加载器 2.interfaces:目标对象实现接口数组 3.h:处理器接口(实现增强的方法细节)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    ClassLoader classLoader = liangLiang.getClass().getClassLoader(); Class&lt;?&gt;[] interfaces = liangLiang.getClass().getInterfaces(); TargetInterface xiaolu = (TargetInterface)</span><br><span class="line">      Proxy.newProxyInstance(classLoader, interfaces, <span class="keyword">new</span> InvocationHandler() &#123; <span class="comment">// 3.编写增强的实现逻辑(invoke是代理对象所有方法的入口)</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">参数:</span></span><br><span class="line"><span class="comment">1.proxy:工具类生产的代理对象(xiaolu) 2.method:当前用户执行的某个具体方法对象 3.args:当前用户执行某个具体方法传递的实际参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></span><br><span class="line"><span class="function">          <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 实现方法的增强</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="string">"sing"</span>.equals(method.getName())) &#123;</span><br><span class="line">            System.out.println(<span class="string">"小路晚上找你谈生意..."</span>); &#125;</span><br><span class="line">          <span class="comment">// 真正执行者还是目标哦对象</span></span><br><span class="line">          <span class="keyword">return</span> method.invoke(liangLiang, args); &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="comment">// 调用代理对象的方法(实现了对sing方法的增强)</span></span><br><span class="line">    xiaolu.sing(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="6-4-日志记录实现"><a href="#6-4-日志记录实现" class="headerlink" title="6.4 日志记录实现"></a>6.4 日志记录实现</h4><h5 id="6-4-1-分析"><a href="#6-4-1-分析" class="headerlink" title="6.4.1 分析"></a>6.4.1 分析</h5><p><img src="image-20200524145558471.png" alt=""></p>
<h5 id="6-4-2-实现"><a href="#6-4-2-实现" class="headerlink" title="6.4.2 实现"></a>6.4.2 实现</h5><ul>
<li><p>JdkProxyFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkProxyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提供一个生产日志记录的代理对象方法</span></span><br><span class="line">  <span class="comment">// target 目标对象</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">createProxy</span><span class="params">(Object target)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// proxy 代理对象</span></span><br><span class="line">    Object proxy = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据工具类，创建代理对象</span></span><br><span class="line">    ClassLoader classLoader = target.getClass().getClassLoader();</span><br><span class="line">    Class&lt;?&gt;[] interfaces = target.getClass().getInterfaces();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现对方法的增强</span></span><br><span class="line">    Proxy.newProxyInstance(classLoader, interfaces, <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 实现日志记录</span></span><br><span class="line">        StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        stringBuffer.append(<span class="string">"[Action Time]: "</span> + LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        stringBuffer.append(<span class="string">"[Implementation Target Class]"</span> + target.getClass().getName());</span><br><span class="line"></span><br><span class="line">        stringBuffer.append(<span class="string">"[Implementation Target Method]: "</span>+method.getName());</span><br><span class="line"></span><br><span class="line">        stringBuffer.append(<span class="string">"[Method Actual Args]: "</span>+ Arrays.toString(args));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先调用目标对象原有的功能</span></span><br><span class="line">        Object invoke = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          invoke = method.invoke(target,args);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">          stringBuffer.append(<span class="string">"[Exception Information]: "</span>+ e.getCause().getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将本次日志信息保存到日志文件</span></span><br><span class="line">        LocalDate localDate = LocalDate.now();</span><br><span class="line"></span><br><span class="line">        String format = localDate.format(DateTimeFormatter.ofPattern(<span class="string">"yyyy-M-dd"</span>));</span><br><span class="line"></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"/Users/swzxsyh/Program"</span> + format + <span class="string">".log"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用高效字符缓冲流 </span></span><br><span class="line">        BufferedWriter bufferedWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(file, <span class="keyword">true</span>), <span class="string">"UTF-8"</span>));</span><br><span class="line"></span><br><span class="line">        bufferedWriter.write(stringBuffer.toString());</span><br><span class="line">        bufferedWriter.newLine();</span><br><span class="line">        bufferedWriter.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> proxy;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>BeanFacotry</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Element;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        UserService userService = (UserService) BeanFactory.getBean(<span class="string">"userService"</span>);</span><br><span class="line">        System.out.println(userService.findByUsername(<span class="string">"swzxsyh"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        Object result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InputStream in = BeanFactory.class.getClassLoader().getResourceAsStream("beans.xml");</span><br><span class="line"></span><br><span class="line">            SAXReader saxReader = <span class="keyword">new</span> SAXReader();</span><br><span class="line"></span><br><span class="line">            Document document = saxReader.read(in);</span><br><span class="line"></span><br><span class="line">            String xpath = <span class="string">"//bean[@id='"</span> + id + <span class="string">"']"</span>;</span><br><span class="line"></span><br><span class="line">            Element element = (Element) document.selectSingleNode(xpath);</span><br><span class="line"></span><br><span class="line">            String className = element.attributeValue(<span class="string">"class"</span>);</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; clazz = Class.forName(className);</span><br><span class="line"></span><br><span class="line">            result = clazz.newInstance();</span><br><span class="line"></span><br><span class="line">            result = JdkProxyFactory.createLogProxy(result);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li>观察日志文件路径</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong># 微信支付&amp;日志记录</strong></p>
<p><strong>## 二维码</strong></p>
<p><strong>### QRCode二维码生成插件</strong></p>
<p><strong>## 微信扫码支付简介</strong></p>
<p><strong>### 申请商户号（略）</strong></p>
<p><strong>### 开发文档</strong></p>
<p>- 1、生成订单</p>
<p>- 2、调用微信下单接口，生成链接。</p>
<p>- 3、根据链接生成二维码图片</p>
<p>- 4、支付成功后修改订单状态</p>
<p><strong>### API</strong></p>
<p>- 统一下单</p>
<p>- 支付结果通知</p>
<p><strong>### SDK</strong></p>
<p>- 需要手动下载，安装到本地仓库</p>
<p>​    - 个别同学使用自己仓库，必须操作</p>
<p><strong>## 统一下单实现</strong></p>
<p><strong>### 写死1分钱</strong></p>
<p><strong>## 支付结果通知实现</strong></p>
<p><strong>### 内网穿透</strong></p>
<p>- NATAPP</p>
<p>​    - 注意：生成的外网地址，可能会随机切换</p>
<p><strong>## 支付状态查询</strong></p>
<p><strong>### 前端使用定时器</strong></p>
<p>- 用户支付，跳转到成功页面</p>
<p>- 超过10分钟未支付，跳转到失败页面</p>
<p><strong>## 日志记录功能</strong></p>
<p><strong>### 使用动态代理，实现对所有业务层方法增强，实现日志记录</strong></p>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/22/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%EF%BC%89/" rel="prev" title="就业班学习笔记（六十）">
      <i class="fa fa-chevron-left"></i> 就业班学习笔记（六十）
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/25/%E5%B0%B1%E4%B8%9A%E7%8F%AD%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%E5%8D%81%E4%BA%8C%EF%BC%89/" rel="next" title="就业班学习笔记（六十二）">
      就业班学习笔记（六十二） <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-二维码"><span class="nav-number">1.</span> <span class="nav-text">一.二维码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-什么是二维码"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">1.1 什么是二维码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-二维码优势"><span class="nav-number">1.0.0.2.</span> <span class="nav-text">1.2 二维码优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-二维码容错级别"><span class="nav-number">1.0.0.3.</span> <span class="nav-text">1.3 二维码容错级别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-二维码生成插件QR-Code"><span class="nav-number">1.0.0.4.</span> <span class="nav-text">1.4 二维码生成插件QR Code</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-微信扫描支付简介"><span class="nav-number">2.</span> <span class="nav-text">二.微信扫描支付简介</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-微信扫码支付申请"><span class="nav-number">2.0.0.1.</span> <span class="nav-text">2.1 微信扫码支付申请</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-开发文档"><span class="nav-number">2.0.0.2.</span> <span class="nav-text">2.2 开发文档</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-API"><span class="nav-number">2.0.0.3.</span> <span class="nav-text">2.3 API</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-1-统一下单"><span class="nav-number">2.0.0.3.1.</span> <span class="nav-text">2.3.1 统一下单</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-2-支付结果通知"><span class="nav-number">2.0.0.3.2.</span> <span class="nav-text">2.3.2 支付结果通知</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-SDK"><span class="nav-number">2.0.0.4.</span> <span class="nav-text">2.4 SDK</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-统一下单实现"><span class="nav-number">3.</span> <span class="nav-text">三.统一下单实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-需求分析"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">3.1 需求分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-代码实现"><span class="nav-number">3.0.0.2.</span> <span class="nav-text">3.2 代码实现</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-支付结果通知实现"><span class="nav-number">4.</span> <span class="nav-text">四.支付结果通知实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-notify-url"><span class="nav-number">4.0.0.1.</span> <span class="nav-text">4.1 notify_url</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-内网穿透"><span class="nav-number">4.0.0.2.</span> <span class="nav-text">4.2 内网穿透</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-需求分析"><span class="nav-number">4.0.0.3.</span> <span class="nav-text">4.3 需求分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-代码实现"><span class="nav-number">4.0.0.4.</span> <span class="nav-text">4.4 代码实现</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五-支付状态查询"><span class="nav-number">5.</span> <span class="nav-text">五.支付状态查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-需求分析"><span class="nav-number">5.0.0.1.</span> <span class="nav-text">5.1 需求分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-代码实现"><span class="nav-number">5.0.0.2.</span> <span class="nav-text">5.2 代码实现</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六-日志记录功能"><span class="nav-number">6.</span> <span class="nav-text">六.日志记录功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-介绍"><span class="nav-number">6.0.0.1.</span> <span class="nav-text">6.1 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-方法增强"><span class="nav-number">6.0.0.2.</span> <span class="nav-text">6.2 方法增强</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-动态代理"><span class="nav-number">6.0.0.3.</span> <span class="nav-text">6.3 动态代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-日志记录实现"><span class="nav-number">6.0.0.4.</span> <span class="nav-text">6.4 日志记录实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#6-4-1-分析"><span class="nav-number">6.0.0.4.1.</span> <span class="nav-text">6.4.1 分析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-4-2-实现"><span class="nav-number">6.0.0.4.2.</span> <span class="nav-text">6.4.2 实现</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description">学习笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">112</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
