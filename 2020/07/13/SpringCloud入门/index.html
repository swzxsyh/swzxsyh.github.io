<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="SpringCloud介绍：微服务架构 使用RestTemplate【httpclient】发送请求：feign 搭建Eureka注册中心 使用Ribbon实现Loading Balance 使用Hystrix熔断器【服务降级】 使用Feign进行远程调用 搭建Spring Cloud Gateway网关 搭建Spring Cloud Config配置中心 使用Spring Cloud Bus消">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud入门">
<meta property="og:url" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Swzxsyh">
<meta property="og:description" content="SpringCloud介绍：微服务架构 使用RestTemplate【httpclient】发送请求：feign 搭建Eureka注册中心 使用Ribbon实现Loading Balance 使用Hystrix熔断器【服务降级】 使用Feign进行远程调用 搭建Spring Cloud Gateway网关 搭建Spring Cloud Config配置中心 使用Spring Cloud Bus消">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/1562666010564.png">
<meta property="og:image" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/1562666652758.png">
<meta property="og:image" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/1563174971237.png">
<meta property="og:image" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/1563263071310.png">
<meta property="og:image" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/1563268861501.png">
<meta property="og:image" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/1594713897762.png">
<meta property="article:published_time" content="2020-07-13T15:23:07.000Z">
<meta property="article:modified_time" content="2020-07-15T08:22:52.283Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/1562666010564.png">

<link rel="canonical" href="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringCloud入门 | Swzxsyh</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Swzxsyh</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">--学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/13/SpringCloud%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="学习笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Swzxsyh">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringCloud入门
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-13 23:23:07" itemprop="dateCreated datePublished" datetime="2020-07-13T23:23:07+08:00">2020-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-15 16:22:52" itemprop="dateModified" datetime="2020-07-15T16:22:52+08:00">2020-07-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>SpringCloud介绍：微服务架构</li>
<li>使用RestTemplate【httpclient】发送请求：feign</li>
<li>搭建Eureka注册中心</li>
<li>使用Ribbon实现Loading Balance</li>
<li>使用Hystrix熔断器【服务降级】</li>
<li>使用Feign进行远程调用</li>
<li>搭建Spring Cloud Gateway网关</li>
<li>搭建Spring Cloud Config配置中心</li>
<li>使用Spring Cloud Bus消息总线</li>
</ul>
<a id="more"></a>

<h1 id="一-SpringCloud介绍"><a href="#一-SpringCloud介绍" class="headerlink" title="一.SpringCloud介绍"></a>一.SpringCloud介绍</h1><h4 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a>1.1 介绍</h4><p>Spring Cloud是在Spring Boot的基础上构建的，用于简化分布式系统构建的<strong>工具集</strong>。该工具集为微服务架构中所涉及的配置管理、服务发现、智能路由、熔断器、控制总线等操作提供了一种简单的开发方式。也就是说Spring Cloud把非常流行的微服务的技术（组件）整合到一起，方便开发。</p>
<ul>
<li>注册中心：Eureka</li>
<li>负载均衡：Ribbon</li>
<li>熔断器：Hystrix</li>
<li>服务通信：Feign</li>
<li>网关：Gateway</li>
<li>配置中心 ：config</li>
<li>消息总线：Bus</li>
</ul>
<h4 id="1-2-版本"><a href="#1-2-版本" class="headerlink" title="1.2 版本"></a>1.2 版本</h4><p>Spring Cloud的版本号是根据英文字母的顺序，采用伦敦的“地名+版本号”的方式来命名的，</p>
<h5 id="1-2-1-与SpringBoot版本匹配关系"><a href="#1-2-1-与SpringBoot版本匹配关系" class="headerlink" title="1.2.1 与SpringBoot版本匹配关系"></a>1.2.1 与SpringBoot版本匹配关系</h5><p>建议使用2.1.x版本，旧版本功能不全且bug多</p>
<table>
<thead>
<tr>
<th>SpringBoot</th>
<th>SpringCloud</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.x</td>
<td>Angel版本</td>
</tr>
<tr>
<td>1.3.x</td>
<td>Brixton版本</td>
</tr>
<tr>
<td>1.4.x</td>
<td>Camden版本</td>
</tr>
<tr>
<td>1.5.x</td>
<td>Dalston版本、Edgware</td>
</tr>
<tr>
<td>2.0.x</td>
<td>Finchley版本</td>
</tr>
<tr>
<td>2.1.x</td>
<td>Greenwich GA版本 (2019年2月发布)</td>
</tr>
</tbody></table>
<h1 id="二-使用RestTemplate发送请求"><a href="#二-使用RestTemplate发送请求" class="headerlink" title="二.使用RestTemplate发送请求"></a>二.使用RestTemplate发送请求</h1><h4 id="2-1-介绍"><a href="#2-1-介绍" class="headerlink" title="2.1 介绍"></a>2.1 介绍</h4><p>当A服务需要调用B服务的数据时，可以使用RestTemplate。</p>
<p>Spring RestTemplate 是 Spring 提供的用于访问 Rest 服务的客户端，RestTemplate 提供了多种便捷访问远程Http服务的方法，能够大大提高客户端的编写效率，所以很多客户端比如 Android或者第三方接口调用都可以使用 RestTemplate 请求 restful 服务。 它的底层是对<strong>HttpClient</strong>进行了封装。</p>
<ul>
<li>RestTemplate是Rest的HTTP客户端模板工具类</li>
<li>对基于Http的客户端进行封装</li>
<li>实现对象与JSON串的相互转换</li>
</ul>
<p>常见的HTTP客户端工具：<strong>HttpClient</strong>、OKHttp、URLConnection。</p>
<h4 id="2-2-HTTP客户端工具"><a href="#2-2-HTTP客户端工具" class="headerlink" title="2.2 HTTP客户端工具"></a>2.2 HTTP客户端工具</h4><h5 id="2-2-1-在工程中添加HttpClient依赖"><a href="#2-2-1-在工程中添加HttpClient依赖" class="headerlink" title="2.2.1 在工程中添加HttpClient依赖"></a>2.2.1 在工程中添加HttpClient依赖</h5><p>创建 springcloud-resttemplate 并添加依赖</p>
<ul>
<li><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!--httpclient依赖--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-2-在工程中添加HttpClient工具类"><a href="#2-2-2-在工程中添加HttpClient工具类" class="headerlink" title="2.2.2 在工程中添加HttpClient工具类"></a>2.2.2 在工程中添加HttpClient工具类</h5><ul>
<li><p>HttpClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClient</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String url;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String&gt; param;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> statusCode;</span><br><span class="line">	<span class="keyword">private</span> String content;</span><br><span class="line">	<span class="keyword">private</span> String xmlParam;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isHttps;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isHttps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isHttps;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHttps</span><span class="params">(<span class="keyword">boolean</span> isHttps)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.isHttps = isHttps;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getXmlParam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> xmlParam;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setXmlParam</span><span class="params">(String xmlParam)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.xmlParam = xmlParam;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HttpClient</span><span class="params">(String url, Map&lt;String, String&gt; param)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.url = url;</span><br><span class="line">		<span class="keyword">this</span>.param = param;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HttpClient</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.url = url;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">		param = map;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addParameter</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (param == <span class="keyword">null</span>)&#123;</span><br><span class="line">			param = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		param.put(key, value);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">()</span> <span class="keyword">throws</span> ClientProtocolException, IOException </span>&#123;</span><br><span class="line">		HttpPost http = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line">		setEntity(http);</span><br><span class="line">		execute(http);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">()</span> <span class="keyword">throws</span> ClientProtocolException, IOException </span>&#123;</span><br><span class="line">		HttpPut http = <span class="keyword">new</span> HttpPut(url);</span><br><span class="line">		setEntity(http);</span><br><span class="line">		execute(http);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> ClientProtocolException, IOException </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (param != <span class="keyword">null</span>) &#123;</span><br><span class="line">			StringBuilder url = <span class="keyword">new</span> StringBuilder(<span class="keyword">this</span>.url);</span><br><span class="line">			<span class="keyword">boolean</span> isFirst = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">for</span> (String key : param.keySet()) &#123;</span><br><span class="line">				<span class="keyword">if</span> (isFirst)&#123;</span><br><span class="line">					url.append(<span class="string">"?"</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					url.append(<span class="string">"&amp;"</span>);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				url.append(key).append(<span class="string">"="</span>).append(param.get(key));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.url = url.toString();</span><br><span class="line">		&#125;</span><br><span class="line">		HttpGet http = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">		execute(http);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * set http post,put param</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setEntity</span><span class="params">(HttpEntityEnclosingRequestBase http)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (param != <span class="keyword">null</span>) &#123;</span><br><span class="line">			List&lt;NameValuePair&gt; nvps = <span class="keyword">new</span> LinkedList&lt;NameValuePair&gt;();</span><br><span class="line">			<span class="keyword">for</span> (String key : param.keySet())&#123;</span><br><span class="line">				nvps.add(<span class="keyword">new</span> BasicNameValuePair(key, param.get(key))); <span class="comment">// 参数</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			http.setEntity(<span class="keyword">new</span> UrlEncodedFormEntity(nvps, Consts.UTF_8)); <span class="comment">// 设置参数</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (xmlParam != <span class="keyword">null</span>) &#123;</span><br><span class="line">			http.setEntity(<span class="keyword">new</span> StringEntity(xmlParam, Consts.UTF_8));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(HttpUriRequest http)</span> <span class="keyword">throws</span> ClientProtocolException,</span></span><br><span class="line"><span class="function">			IOException </span>&#123;</span><br><span class="line">		CloseableHttpClient httpClient = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (isHttps) &#123;</span><br><span class="line">				SSLContext sslContext = <span class="keyword">new</span> SSLContextBuilder()</span><br><span class="line">						.loadTrustMaterial(<span class="keyword">null</span>, <span class="keyword">new</span> TrustStrategy() &#123;</span><br><span class="line">							<span class="comment">// 信任所有</span></span><br><span class="line">							<span class="meta">@Override</span></span><br><span class="line">							<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTrusted</span><span class="params">(X509Certificate[] chain,</span></span></span><br><span class="line"><span class="function"><span class="params">									String authType)</span></span></span><br><span class="line"><span class="function">									<span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">								<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;).build();</span><br><span class="line">				SSLConnectionSocketFactory sslsf = <span class="keyword">new</span> SSLConnectionSocketFactory(</span><br><span class="line">						sslContext);</span><br><span class="line">				httpClient = HttpClients.custom().setSSLSocketFactory(sslsf)</span><br><span class="line">						.build();</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				httpClient = HttpClients.createDefault();</span><br><span class="line">			&#125;</span><br><span class="line">			CloseableHttpResponse response = httpClient.execute(http);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (response.getStatusLine() != <span class="keyword">null</span>)&#123;</span><br><span class="line">						statusCode = response.getStatusLine().getStatusCode();</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					HttpEntity entity = response.getEntity();</span><br><span class="line">					<span class="comment">// 响应内容</span></span><br><span class="line">					content = EntityUtils.toString(entity, Consts.UTF_8);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">				response.close();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			httpClient.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getStatusCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> statusCode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> <span class="keyword">throws</span> ParseException, IOException </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> content;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="2-2-3-测试"><a href="#2-2-3-测试" class="headerlink" title="2.2.3 测试"></a>2.2.3 测试</h5><p>开启一台之前创建的服务器，含有findusers方法的,如springboot中的mybatis服务</p>
<p>在test中创建测试类(需跟src中包名路径相同)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testHttpClient</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ParseException </span>&#123;</span><br><span class="line">        String url = <span class="string">"http://localhost:8080/user/findUsers"</span>;</span><br><span class="line">        HttpClient httpClient = <span class="keyword">new</span> HttpClient(url);</span><br><span class="line"></span><br><span class="line">        httpClient.get();</span><br><span class="line"></span><br><span class="line">        String content = httpClient.getContent();</span><br><span class="line">        System.out.println(content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以获取结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"username"</span>:<span class="string">"zhangsan"</span>,<span class="attr">"password"</span>:<span class="string">"123"</span>,<span class="attr">"address"</span>:<span class="string">"北京"</span>&#125;,&#123;<span class="attr">"id"</span>:<span class="number">2</span>,<span class="attr">"username"</span>:<span class="string">"lisi"</span>,<span class="attr">"password"</span>:<span class="string">"123"</span>,<span class="attr">"address"</span>:<span class="string">"上海"</span>&#125;]</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="2-3-RestTemplate入门程序"><a href="#2-3-RestTemplate入门程序" class="headerlink" title="2.3 RestTemplate入门程序"></a>2.3 RestTemplate入门程序</h4><h5 id="2-3-1-在springcloud-resttemplate添加依赖"><a href="#2-3-1-在springcloud-resttemplate添加依赖" class="headerlink" title="2.3.1 在springcloud-resttemplate添加依赖"></a>2.3.1 在springcloud-resttemplate添加依赖</h5><ul>
<li><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--web依赖中包含了RestTemplate--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="2-3-2-注入RestTemplate"><a href="#2-3-2-注入RestTemplate" class="headerlink" title="2.3.2 注入RestTemplate"></a>2.3.2 注入RestTemplate</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(RestTemplateApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注入RestTemplate</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-3-在测试类中测试"><a href="#2-3-3-在测试类中测试" class="headerlink" title="2.3.3 在测试类中测试"></a>2.3.3 在测试类中测试</h5><p>创建RestTemplateTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RestTemplateTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoad</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        String url = <span class="string">"http://localhost:8080/user/findUsers"</span>;</span><br><span class="line">        <span class="comment">//返回JSON格式</span></span><br><span class="line">        String json = restTemplate.getForObject(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(json);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取结果:</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"username"</span>:<span class="string">"zhangsan"</span>,<span class="attr">"password"</span>:<span class="string">"123"</span>,<span class="attr">"address"</span>:<span class="string">"北京"</span>&#125;,&#123;<span class="attr">"id"</span>:<span class="number">2</span>,<span class="attr">"username"</span>:<span class="string">"lisi"</span>,<span class="attr">"password"</span>:<span class="string">"123"</span>,<span class="attr">"address"</span>:<span class="string">"上海"</span>&#125;]</span><br></pre></td></tr></table></figure>

<h1 id="三-模拟服务调用"><a href="#三-模拟服务调用" class="headerlink" title="三.模拟服务调用"></a>三.模拟服务调用</h1><ul>
<li><p>创建两个服务</p>
<ul>
<li>服务提供方</li>
<li>服务消费方</li>
</ul>
</li>
<li><p>需求</p>
<p>根据id获取用户信息。</p>
</li>
<li><p>sql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE springcloud;</span><br><span class="line">USE springcloud;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;tb_user&#96; (</span><br><span class="line">  &#96;id&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;username&#96; varchar(100) DEFAULT NULL COMMENT &#39;用户名&#39;,</span><br><span class="line">  &#96;password&#96; varchar(100) DEFAULT NULL COMMENT &#39;密码&#39;,</span><br><span class="line">  &#96;name&#96; varchar(100) DEFAULT NULL COMMENT &#39;姓名&#39;,</span><br><span class="line">  &#96;age&#96; int(11) DEFAULT NULL COMMENT &#39;年龄&#39;,</span><br><span class="line">  &#96;sex&#96; int(11) DEFAULT NULL COMMENT &#39;性别，1男，2女&#39;,</span><br><span class="line">  &#96;birthday&#96; date DEFAULT NULL COMMENT &#39;出生日期&#39;,</span><br><span class="line">  &#96;created&#96; date DEFAULT NULL COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;updated&#96; date DEFAULT NULL COMMENT &#39;更新时间&#39;,</span><br><span class="line">  &#96;note&#96; varchar(1000) DEFAULT NULL COMMENT &#39;备注&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8 COMMENT&#x3D;&#39;用户信息表&#39;;</span><br><span class="line"></span><br><span class="line">INSERT INTO &#96;tb_user&#96; VALUES (&#39;1&#39;, &#39;zhangsan&#39;, &#39;123456&#39;, &#39;张三&#39;, &#39;13&#39;, &#39;1&#39;, &#39;2006-08-01&#39;, &#39;2019-05-16&#39;, &#39;2019-05-16&#39;, &#39;A&#39;);</span><br><span class="line">INSERT INTO &#96;tb_user&#96; VALUES (&#39;2&#39;, &#39;lisi&#39;, &#39;123456&#39;, &#39;李四&#39;, &#39;13&#39;, &#39;1&#39;, &#39;2006-08-01&#39;, &#39;2019-05-16&#39;, &#39;2019-05-16&#39;, &#39;B&#39;);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="3-1-创建服务提供方"><a href="#3-1-创建服务提供方" class="headerlink" title="3.1 创建服务提供方"></a>3.1 创建服务提供方</h4><h5 id="3-1-1-创建工程"><a href="#3-1-1-创建工程" class="headerlink" title="3.1.1 创建工程"></a>3.1.1 创建工程</h5><p>创建工程<code>&lt;springcloud-user-provider&gt;</code>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-1-2-创建pojo"><a href="#3-1-2-创建pojo" class="headerlink" title="3.1.2 创建pojo"></a>3.1.2 创建pojo</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer sex;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="keyword">private</span> Date created;</span><br><span class="line">    <span class="keyword">private</span> Date updated;</span><br><span class="line">    <span class="keyword">private</span> String note;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span>getters/setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-3-编写Dao层"><a href="#3-1-3-编写Dao层" class="headerlink" title="3.1.3 编写Dao层"></a>3.1.3 编写Dao层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Select</span>(<span class="string">"SELECT * FROM tb_user WHERE id = #&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function">User <span class="title">findById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-4-编写Service层"><a href="#3-1-4-编写Service层" class="headerlink" title="3.1.4 编写Service层"></a>3.1.4 编写Service层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">User <span class="title">findById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-5-编写Controller层"><a href="#3-1-5-编写Controller层" class="headerlink" title="3.1.5 编写Controller层"></a>3.1.5 编写Controller层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/findById/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span>Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-6-编写application-yml文件"><a href="#3-1-6-编写application-yml文件" class="headerlink" title="3.1.6 编写application.yml文件"></a>3.1.6 编写application.yml文件</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"><span class="comment"># DB 配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/springcloud?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>

<h5 id="3-1-7-编写启动类"><a href="#3-1-7-编写启动类" class="headerlink" title="3.1.7 编写启动类"></a>3.1.7 编写启动类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ProviderApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-1-8-发布程序并访问测试"><a href="#3-1-8-发布程序并访问测试" class="headerlink" title="3.1.8 发布程序并访问测试"></a>3.1.8 发布程序并访问测试</h5><p>访问 localhost:9091/api/user/findById/1</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"username"</span>: <span class="string">"zhangsan"</span>,</span><br><span class="line">  <span class="attr">"password"</span>: <span class="string">"123456"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"张三"</span>,</span><br><span class="line">  <span class="attr">"age"</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">"sex"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"birthday"</span>: <span class="string">"2006-08-01T00:00:00.000+0000"</span>,</span><br><span class="line">  <span class="attr">"created"</span>: <span class="string">"2019-05-16T00:00:00.000+0000"</span>,</span><br><span class="line">  <span class="attr">"updated"</span>: <span class="string">"2019-05-16T00:00:00.000+0000"</span>,</span><br><span class="line">  <span class="attr">"note"</span>: <span class="string">"好好学习"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-2-创建服务消费方"><a href="#3-2-创建服务消费方" class="headerlink" title="3.2 创建服务消费方"></a>3.2 创建服务消费方</h4><h5 id="3-2-1-创建工程"><a href="#3-2-1-创建工程" class="headerlink" title="3.2.1 创建工程"></a>3.2.1 创建工程</h5><p>创建工程springcloud-user-consumer 并且添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-2-2-编写启动类"><a href="#3-2-2-编写启动类" class="headerlink" title="3.2.2 编写启动类"></a>3.2.2 编写启动类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 注入RestTemplate</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-3-编写Controller层"><a href="#3-2-3-编写Controller层" class="headerlink" title="3.2.3 编写Controller层"></a>3.2.3 编写Controller层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/consumer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/findById/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        String url = <span class="string">"http://localhost:9091/api/user/findById/"</span> + id;</span><br><span class="line">        String json = restTemplate.getForObject(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-调用测试"><a href="#3-3-调用测试" class="headerlink" title="3.3 调用测试"></a>3.3 调用测试</h4><p>访问 localhost:8080/consumer/findById/1 同样可以获取</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"username"</span>: <span class="string">"zhangsan"</span>,</span><br><span class="line">  <span class="attr">"password"</span>: <span class="string">"123456"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"张三"</span>,</span><br><span class="line">  <span class="attr">"age"</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">"sex"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"birthday"</span>: <span class="string">"2006-08-01T00:00:00.000+0000"</span>,</span><br><span class="line">  <span class="attr">"created"</span>: <span class="string">"2019-05-16T00:00:00.000+0000"</span>,</span><br><span class="line">  <span class="attr">"updated"</span>: <span class="string">"2019-05-16T00:00:00.000+0000"</span>,</span><br><span class="line">  <span class="attr">"note"</span>: <span class="string">"好好学习"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-问题总结"><a href="#3-4-问题总结" class="headerlink" title="3.4 问题总结"></a>3.4 问题总结</h4><ul>
<li>目前硬编码服务器地址，需解耦</li>
<li>consumer无法判断provider是否存活</li>
<li>未配置负载均衡，无HA高可用</li>
</ul>
<h1 id="四-搭建Eureka注册中心"><a href="#四-搭建Eureka注册中心" class="headerlink" title="四.搭建Eureka注册中心"></a>四.搭建Eureka注册中心</h1><h4 id="4-1-Eureka介绍"><a href="#4-1-Eureka介绍" class="headerlink" title="4.1 Eureka介绍"></a>4.1 Eureka介绍</h4><p>类似于dubbo+zk，但不同的是dubbo以zk为注册中心，dubbo配置谁为provider，谁为consumer。</p>
<p>eureka默认有register，provider/consumer，但服务可能同时作为provider与consumer，相对于register都是client端。</p>
<p>Eureka是Netflix开发的一个服务发现框架，本身是一个基于REST的服务，主要用于定位运行在AWS（Amazon Web Services ）域中的中间层服务，以达到负载均衡和中间层服务故障转移的目的。Spring Cloud将其集成在自己的子项目Spring Cloud Netflix中，以实现Spring Cloud的服务发现功能。</p>
<p>Eureka的服务发现包含两大组件：服务端发现组件（Eureka Server）和客户端发现组件（Eureka Client）。服务端发现组件也被称之为服务注册中心，主要提供了服务的注册功能，而客户端发现组件主要用于处理服务的注册与发现。</p>
<p><img src="1562666010564.png" alt=""></p>
<p>当客户端服务通过注解等方式嵌入到程序的代码中运行时，客户端发现组件就会向注册中心注册自身提供的服务，并周期性地发送心跳来更新服务（默认时间为30s，如果连续三次心跳都不能够发现服务，那么Eureka就会将这个服务节点从服务注册表中移除）。与此同时，客户端发现组件还会从服务端查询当前注册的服务信息并缓存到本地，即使Eureka Server出现了问题，客户端组件也可以通过缓存中的信息调用服务节点的服务。各个服务之间会通过注册中心的注册信息以Rest方式来实现调用，并且也可以直接通过服务名进行调用。 </p>
<p><img src="1562666652758.png" alt=""></p>
<p>在Eureka的服务发现机制中，包含了3个角色：服务注册中心、服务提供方和服务消费方。</p>
<p>服务注册中心即Eureka Server，而服务提供者和服务消费者是Eureka Client。这里的服务提供者是指提供服务的应用，可以是Spring Boot应用，也可以是其他技术平台且遵循Eureka通信机制的应用，应用在运行时会自动的将自己提供的服务注册到Eureka Server以供其他应用发现。</p>
<p>服务消费者就是需要服务的应用，该服务在运行时会从服务注册中心获取服务列表，然后通过服务列表知道去何处调用其他服务。服务消费者会与服务注册中心保持心跳连接，一旦服务提供者的地址发生变更时，注册中心会通知服务消费者。</p>
<p>需要注意的是，Eureka服务提供者和服务消费者之间的角色是可以相互转换的，因为一个服务既可能是服务消费方，同时也可能是服务提供方。</p>
<h4 id="4-2-Eureka入门程序"><a href="#4-2-Eureka入门程序" class="headerlink" title="4.2 Eureka入门程序"></a>4.2 Eureka入门程序</h4><h5 id="4-2-1-创建parent工程"><a href="#4-2-1-创建parent工程" class="headerlink" title="4.2.1 创建parent工程"></a>4.2.1 创建parent工程</h5><p>创建一个maven工程springcloud-microservice，并将其作为父工程用来管理子工程（父工程，需要删src目录），因为需要创建Eureka的注册中心及Eureka提供方以及消费方，因此方便管理。</p>
<p>创建好的maven工程中需要添加如下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="4-2-2-创建Eureka服务-注册中心"><a href="#4-2-2-创建Eureka服务-注册中心" class="headerlink" title="4.2.2 创建Eureka服务-注册中心"></a>4.2.2 创建Eureka服务-注册中心</h5><h6 id="4-2-2-1-创建工程"><a href="#4-2-2-1-创建工程" class="headerlink" title="4.2.2.1 创建工程"></a>4.2.2.1 创建工程</h6><p>创建Eureka的服务（注册中心）eureka-server-registry工程并添加依赖</p>
<ul>
<li><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-microservice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-server-registry<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka服务端--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="4-2-2-2-编写启动类"><a href="#4-2-2-2-编写启动类" class="headerlink" title="4.2.2.2 编写启动类"></a>4.2.2.2 编写启动类</h6><p>在启动类中添加@EnableEurekaServer注解。申明该工程为Eureka的服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span>		<span class="comment">// 开启eureka注册中心服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(EurekaServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="4-2-2-3-编写application-yml文件"><a href="#4-2-2-3-编写application-yml文件" class="headerlink" title="4.2.2.3 编写application.yml文件"></a>4.2.2.3 编写application.yml文件</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10086</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">ip-address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>         <span class="comment"># 应用实例IP</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>   <span class="comment"># 是否将自己注册到eureka中</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>         <span class="comment"># 是否从eureka中获取信息</span></span><br><span class="line">    <span class="attr">service-url:</span>                  <span class="comment"># 注册中心地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br><span class="line"><span class="comment">#      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment"># 是否开启自我保护机制</span></span><br></pre></td></tr></table></figure>

<h6 id="4-2-2-4-访问注册中心-localhost-10086-可以看到控制面板"><a href="#4-2-2-4-访问注册中心-localhost-10086-可以看到控制面板" class="headerlink" title="4.2.2.4 访问注册中心 localhost:10086 可以看到控制面板"></a>4.2.2.4 访问注册中心 localhost:10086 可以看到控制面板</h6><h5 id="4-2-3-创建Eureka客户端-提供方"><a href="#4-2-3-创建Eureka客户端-提供方" class="headerlink" title="4.2.3 创建Eureka客户端-提供方"></a>4.2.3 创建Eureka客户端-提供方</h5><h6 id="4-2-3-1-创建工程"><a href="#4-2-3-1-创建工程" class="headerlink" title="4.2.3.1 创建工程"></a>4.2.3.1 创建工程</h6><p>创建服务提供方工程eureka-client-provider</p>
<ul>
<li><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-microservice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-client-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--eureka客户端--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="4-2-3-2-编写代码"><a href="#4-2-3-2-编写代码" class="headerlink" title="4.2.3.2 编写代码"></a>4.2.3.2 编写代码</h6><p>  将 springcloud-user-provider 的mvc和实体类搬运来</p>
<h6 id="4-2-3-3-编写启动类"><a href="#4-2-3-3-编写启动类" class="headerlink" title="4.2.3.3 编写启动类"></a>4.2.3.3 编写启动类</h6><p>  在启动类中添加注解，表明为eureka的客户端。@EnableEurekaClient</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span>     <span class="comment">// 开启eureka客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaProviderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(EurekaProviderApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="4-2-3-4-编写application-yml文件"><a href="#4-2-3-4-编写application-yml文件" class="headerlink" title="4.2.3.4 编写application.yml文件"></a>4.2.3.4 编写application.yml文件</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置应用基本信息和DB</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client-provider</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/springcloud?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line"><span class="comment"># 配置eureka server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>

<h6 id="4-2-3-5-发布工程"><a href="#4-2-3-5-发布工程" class="headerlink" title="4.2.3.5 发布工程"></a>4.2.3.5 发布工程</h6><p>发布工程后，进入register可查看到provider已注册</p>
<h5 id="4-2-4-创建Eureka客户端-消费方"><a href="#4-2-4-创建Eureka客户端-消费方" class="headerlink" title="4.2.4 创建Eureka客户端-消费方"></a>4.2.4 创建Eureka客户端-消费方</h5><h6 id="4-2-4-1-创建工程"><a href="#4-2-4-1-创建工程" class="headerlink" title="4.2.4.1 创建工程"></a>4.2.4.1 创建工程</h6><p>创建服务提供方工程eureka-client-consumer</p>
<ul>
<li><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-microservice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eureka-client-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="4-2-4-2-编写启动类"><a href="#4-2-4-2-编写启动类" class="headerlink" title="4.2.4.2 编写启动类"></a>4.2.4.2 编写启动类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(EurekaConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="4-2-4-3-编写Controller"><a href="#4-2-4-3-编写Controller" class="headerlink" title="4.2.4.3 编写Controller"></a>4.2.4.3 编写Controller</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/consumer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/findById/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">    String url = <span class="string">"http://localhost:9091/api/user/findById/"</span> + id;</span><br><span class="line">    String json = restTemplate.getForObject(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="4-2-4-4-配置application-yml文件"><a href="#4-2-4-4-配置application-yml文件" class="headerlink" title="4.2.4.4 配置application.yml文件"></a>4.2.4.4 配置application.yml文件</h6><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置应用基本信息</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client-consumer</span></span><br><span class="line"><span class="comment"># 配置eureka server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>

<h6 id="4-2-4-5-发布工程"><a href="#4-2-4-5-发布工程" class="headerlink" title="4.2.4.5 发布工程"></a>4.2.4.5 发布工程</h6><p>发布工程后，进入register可查看到consumer已注册</p>
<h5 id="4-2-5-调用测试"><a href="#4-2-5-调用测试" class="headerlink" title="4.2.5 调用测试"></a>4.2.5 调用测试</h5><p>在消费方中调用  localhost:8080/consumer/findById/1</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"id"</span>:<span class="number">1</span>,<span class="attr">"username"</span>:<span class="string">"zhangsan"</span>,<span class="attr">"password"</span>:<span class="string">"123456"</span>,<span class="attr">"name"</span>:<span class="string">"张三"</span>,<span class="attr">"age"</span>:<span class="number">13</span>,<span class="attr">"sex"</span>:<span class="number">1</span>,<span class="attr">"birthday"</span>:<span class="string">"2006-08-01T00:00:00.000+0000"</span>,<span class="attr">"created"</span>:<span class="string">"2019-05-16T00:00:00.000+0000"</span>,<span class="attr">"updated"</span>:<span class="string">"2019-05-16T00:00:00.000+0000"</span>,<span class="attr">"note"</span>:<span class="string">"好好学习"</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-2-6-Eureka其他（了解）"><a href="#4-2-6-Eureka其他（了解）" class="headerlink" title="4.2.6 Eureka其他（了解）"></a>4.2.6 Eureka其他（了解）</h5><h6 id="4-2-6-1-注解说明"><a href="#4-2-6-1-注解说明" class="headerlink" title="4.2.6.1 注解说明"></a>4.2.6.1 注解说明</h6><p>注册服务或者发现服务注解。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10086</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span>   <span class="comment"># 是否将自己注册到eureka中</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span>         <span class="comment"># 是否从eureka中获取信息</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka/</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span> <span class="comment"># 是否开启自我保护机制</span></span><br></pre></td></tr></table></figure>

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">系统在三种情况下会出现红色加粗的字体提示：</span></span><br><span class="line"></span><br><span class="line"><span class="attr">a.在配置上，自我保护机制关闭</span></span><br><span class="line"><span class="attr">RENEWALS</span> <span class="string">ARE LESSER THAN THE THRESHOLD. THE SELF PRESERVATION MODE IS TURNED OFF.THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK/OTHER PROBLEMS.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">b.自我保护机制开启了</span></span><br><span class="line"><span class="meta">EMERGENCY!</span> <span class="string">EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY'RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE</span></span><br><span class="line"><span class="attr">NOT</span> <span class="string">BEING EXPIRED JUST TO BE SAFE.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">c.在配置上，自我保护机制关闭了，但是一分钟内的续约数没有达到85%</span> <span class="string">， 可能发生了网络分区，会有如下提示</span></span><br><span class="line"><span class="attr">THE</span> <span class="string">SELF PRESERVATION MODE IS TURNED OFF.THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK/OTHER PROBLEMS.</span></span><br></pre></td></tr></table></figure>

<h6 id="4-2-6-3-eureka控制台说明"><a href="#4-2-6-3-eureka控制台说明" class="headerlink" title="4.2.6.3 eureka控制台说明"></a>4.2.6.3 eureka控制台说明</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">total-avail-memory</span> : <span class="string">总共可用的内存</span></span><br><span class="line"><span class="attr">environment</span> : <span class="string">环境名称，默认test</span></span><br><span class="line"><span class="meta">num-of-cpus</span> : <span class="string">CPU的个数</span></span><br><span class="line"><span class="meta">current-memory-usage</span> : <span class="string">当前已经使用内存的百分比</span></span><br><span class="line"><span class="meta">server-uptime</span> : <span class="string">服务启动时间</span></span><br><span class="line"><span class="meta">registered-replicas</span> : <span class="string">相邻集群复制节点</span></span><br><span class="line"><span class="meta">unavailable-replicas</span> <span class="string">：不可用的集群复制节点，如何确定不可用？ 主要是server1 向 server2和server3发送接口查询自身的注册信息，</span></span><br><span class="line"><span class="meta">如果查询不到，则默认为不可用，也就是说如果Eureka</span> <span class="string">Server自身不作为客户端注册到上面去，则相邻节点都会显示为不可用。</span></span><br><span class="line"><span class="meta">available-replicas</span> <span class="string">：可用的相邻集群复制节点</span></span><br></pre></td></tr></table></figure>

<h4 id="4-2-6-4-服务续约"><a href="#4-2-6-4-服务续约" class="headerlink" title="4.2.6.4 服务续约"></a>4.2.6.4 服务续约</h4><p>服务注册完成以后，服务提供者会维持一个<code>心跳</code>，保存服务处于存在状态。这个称之为服务续约(renew).服务超过90秒没有发生心跳，Eureka Server会将服务从列表移除。我们可以在eureka的客户端配置如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#向Eureka服务中心注册服务</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">  	<span class="comment"># 租约到期，服务时效时间，默认值90秒</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">90</span> </span><br><span class="line">    <span class="comment"># 租约续约间隔时间，默认30秒</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<h4 id="4-2-6-5-失效剔除"><a href="#4-2-6-5-失效剔除" class="headerlink" title="4.2.6.5 失效剔除"></a>4.2.6.5 失效剔除</h4><p>服务中心每隔一段时间(默认60秒)将清单中没有续约的服务剔除。通过<code>eviction-interval-timer-in-ms</code>配置可以对其进行修改，单位是秒。我们可以在eureka客户端程序中配置如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">  	<span class="comment"># 超过180秒没有续约的服务将被剔除</span></span><br><span class="line">  	<span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">180</span></span><br></pre></td></tr></table></figure>

<h1 id="五-使用Ribbon实现负载均衡"><a href="#五-使用Ribbon实现负载均衡" class="headerlink" title="五.使用Ribbon实现负载均衡"></a>五.使用Ribbon实现负载均衡</h1><h4 id="5-1-Ribbon介绍"><a href="#5-1-Ribbon介绍" class="headerlink" title="5.1 Ribbon介绍"></a>5.1 Ribbon介绍</h4><p>Spring Cloud Ribbon是一个基于HTTP和TCP的客户端负载均衡工具，它基于Netflix Ribbon实现。通过Spring Cloud的封装，可以让我们轻松地将面向服务的REST模版请求自动转换成客户端负载均衡的服务调用。Spring Cloud Ribbon虽然只是一个工具类框架，它不像服务注册中心、配置中心、API网关那样需要独立部署，但是它几乎存在于每一个Spring Cloud构建的微服务和基础设施中。因为微服务间的调用，API网关的请求转发等内容，实际上都是通过Ribbon来实现的，包括后续我们将要介绍的Feign，它也是基于Ribbon实现的工具。所以，对Spring Cloud Ribbon的理解和使用，对于我们使用Spring Cloud来构建微服务非常重要。</p>
<h4 id="5-2-入门程序"><a href="#5-2-入门程序" class="headerlink" title="5.2 入门程序"></a>5.2 入门程序</h4><p>场景说明：</p>
<ul>
<li>开启多个（本次两个）服务提供方；</li>
<li>启动消费方进行调用测试</li>
</ul>
<h5 id="5-2-1-启动两个提供方"><a href="#5-2-1-启动两个提供方" class="headerlink" title="5.2.1 启动两个提供方"></a>5.2.1 启动两个提供方</h5><h6 id="5-2-1-1-修改端口"><a href="#5-2-1-1-修改端口" class="headerlink" title="5.2.1.1 修改端口"></a>5.2.1.1 修改端口</h6><p>修改提供方配置文件端口：${port:9091}</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置应用基本信息和DB</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">$&#123;port:9091&#125;</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">eureka-client-provider</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/springcloud?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line"><span class="comment"># 配置eureka server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>

<h6 id="5-2-1-2-编辑启动应用配置"><a href="#5-2-1-2-编辑启动应用配置" class="headerlink" title="5.2.1.2 编辑启动应用配置"></a>5.2.1.2 编辑启动应用配置</h6><ul>
<li>修改发布的应用名称</li>
<li>修改发布的应用端口：-Dport=9091</li>
</ul>
<h6 id="5-2-1-3-复制一份新应用"><a href="#5-2-1-3-复制一份新应用" class="headerlink" title="5.2.1.3 复制一份新应用"></a>5.2.1.3 复制一份新应用</h6><ul>
<li><p>复制一份新的应用</p>
</li>
<li><p>修改端口以及名称</p>
</li>
</ul>
<h6 id="5-2-1-4-通过Eureka查看"><a href="#5-2-1-4-通过Eureka查看" class="headerlink" title="5.2.1.4 通过Eureka查看"></a>5.2.1.4 通过Eureka查看</h6><p>启动服务，通过eureka控制面板查看服务</p>
<h5 id="5-2-1-5-修改消费方"><a href="#5-2-1-5-修改消费方" class="headerlink" title="5.2.1.5 修改消费方"></a>5.2.1.5 修改消费方</h5><h6 id="5-2-1-6-添加-LoadBalanced注解"><a href="#5-2-1-6-添加-LoadBalanced注解" class="headerlink" title="5.2.1.6 添加@LoadBalanced注解"></a>5.2.1.6 添加@LoadBalanced注解</h6><p>在启动类的注入RestTemplate方法上添加客户端负载均衡的注解。<strong>@LoadBalanced</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaConsumerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="5-2-1-7-修改ConsumerController"><a href="#5-2-1-7-修改ConsumerController" class="headerlink" title="5.2.1.7 修改ConsumerController"></a>5.2.1.7 修改ConsumerController</h6><p>修改ConsumerController代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/consumer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/findById/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line"><span class="comment">//        String url = "http://localhost:9091/api/user/findById/" + id;</span></span><br><span class="line">        <span class="comment">// 通过服务名称调用</span></span><br><span class="line">        String url = <span class="string">"http://eureka-client-provider/api/user/findById/"</span> + id;</span><br><span class="line">        String json = restTemplate.getForObject(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="5-2-1-8-启动消费方"><a href="#5-2-1-8-启动消费方" class="headerlink" title="5.2.1.8 启动消费方"></a>5.2.1.8 启动消费方</h6><h5 id="5-2-1-9-访问测试"><a href="#5-2-1-9-访问测试" class="headerlink" title="5.2.1.9 访问测试"></a>5.2.1.9 访问测试</h5><ul>
<li>我们可以在提供方的controller中打印port：</li>
<li>刷新四次，console控制查看结果：（分别访问两次，默认走的负载均衡的策略为轮询）</li>
</ul>
<h5 id="5-2-2-坑"><a href="#5-2-2-坑" class="headerlink" title="5.2.2 坑"></a>5.2.2 坑</h5><p>使用ribbon实现负载均衡的时候，服务名称不能用下划线。</p>
<h4 id="5-3-Ribbon负载均衡策略"><a href="#5-3-Ribbon负载均衡策略" class="headerlink" title="5.3 Ribbon负载均衡策略"></a>5.3 Ribbon负载均衡策略</h4><h3 id="5-3-1-默认策略"><a href="#5-3-1-默认策略" class="headerlink" title="5.3.1 默认策略"></a>5.3.1 默认策略</h3><p>Ribbon默认的负载均衡策略是轮询。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改服务地址轮询策略，默认是轮询，配置之后变随机</span></span><br><span class="line"><span class="attr">eureka-client-provider:</span> <span class="comment"># 服务名称</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure>

<h5 id="5-3-2-Ribbon支持的轮询算法"><a href="#5-3-2-Ribbon支持的轮询算法" class="headerlink" title="5.3.2 Ribbon支持的轮询算法"></a>5.3.2 Ribbon支持的轮询算法</h5><table>
<thead>
<tr>
<th>RoundRobinRule</th>
<th>轮询规则（默认方法）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>RandomRule</strong></td>
<td><strong>随机</strong></td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，还有并发的连接数量超过阈值的服务，然后对剩余的服务进行轮询</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>根据平均响应时间计算服务的权重。统计信息不足时会按照轮询，统计信息足够会按照响应的时间选择服务</td>
</tr>
<tr>
<td>RetryRule</td>
<td>正常时按照轮询选择服务，若过程中有服务出现故障，在轮询一定次数后依然故障，则会跳过故障的服务继续轮询</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</td>
</tr>
<tr>
<td>ZoneAvoidanceRule</td>
<td>默认规则，符合判断server所在的区域的性能和server的可用性选择服务</td>
</tr>
</tbody></table>
<h1 id="六-使用Hystrix熔断器"><a href="#六-使用Hystrix熔断器" class="headerlink" title="六.使用Hystrix熔断器"></a>六.使用Hystrix熔断器</h1><h4 id="6-1-Hystrix介绍"><a href="#6-1-Hystrix介绍" class="headerlink" title="6.1 Hystrix介绍"></a>6.1 Hystrix介绍</h4><ul>
<li>Hystrix，英文意思是豪猪，全身是刺，刺是一种保护机制。Hystrix也是Netflix公司的一款组件。</li>
<li>Hystrix是Netflix开源的一个延迟和容错库，用于隔离访问远程服务、第三方库、防止出现级联失败也就是雪崩效应。</li>
</ul>
<h4 id="6-2-雪崩效应"><a href="#6-2-雪崩效应" class="headerlink" title="6.2 雪崩效应"></a>6.2 雪崩效应</h4><ul>
<li>微服务中，一个请求可能需要多个微服务接口才能实现，会形成复杂的调用链路。</li>
<li>如果某服务出现异常，请求阻塞，用户得不到响应，容器中线程不会释放，于是越来越多用户请求堆积，越来越多线程阻塞。</li>
<li>单服务器支持线程和并发数有限，请求如果一直阻塞，会导致服务器资源耗尽，从而导致所有其他服务都不可用，从而形成雪崩效应。</li>
</ul>
<h4 id="6-3-熔断器原理"><a href="#6-3-熔断器原理" class="headerlink" title="6.3 熔断器原理"></a>6.3 熔断器原理</h4><h5 id="6-3-1-熔断器"><a href="#6-3-1-熔断器" class="headerlink" title="6.3.1 熔断器"></a>6.3.1 熔断器</h5><p>在Spring Cloud中，Spring Cloud Hystrix就是用来实现断路器、线程隔离等服务保护功能的。Spring Cloud Hystrix是基于Netflix的开源框架Hystrix实现的，该框架的使用目标在于通过控制那些访问远程系统、服务和第三方库的节点，从而对延迟和故障提供更强大的容错能力。</p>
<h6 id="6-3-1-1-熔断器状态"><a href="#6-3-1-1-熔断器状态" class="headerlink" title="6.3.1.1 熔断器状态"></a>6.3.1.1 熔断器状态</h6><p>断路器是可以实现弹性容错的，在一定条件下它能够自动打开和关闭，其使用时主要有三种状态。</p>
<ul>
<li>Closed：关闭状态（<strong>前健康状况高于设定阈值</strong>），所有请求正常访问</li>
<li>Open：打开状态（<strong>当前健康状况低于设定阈值</strong>），所有请求静止通过，如果设置了fallback方法，则进入该流程</li>
<li>Half Open：半开状态（<strong>当断路器开关处于打开状态，经过一段时间后，断路器会自动进入半开状态。这时断路器只允许一个请求通过；当该请求调用成功时，断路器恢复到关闭状态；若该请求失败，断路器继续保持打开状态，接下来的请求会被禁止通过</strong>）</li>
</ul>
<p>断路器的开关由关闭到打开的状态是通过当前服务健康状况（服务的健康状况=请求失败数/请求总数）和设定阈值（默认为5秒内的20次故障）比较决定的。当断路器开关关闭时，请求被允许通过断路器，如果当前健康状况高于设定阈值，开关继续保持关闭；如果当前健康状况低于设定阈值，开关则切换为打开状态。当断路器开关打开时，请求被禁止通过；如果设置了fallback方法，则会进入fallback的流程。当断路器开关处于打开状态，经过一段时间后，断路器会自动进入半开状态，这时断路器只允许一个请求通过；当该请求调用成功时，断路器恢复到关闭状态；若该请求失败，断路器继续保持打开状态，接下来的请求会被禁止通过。</p>
<h4 id="6-3-1-2-服务降级方法"><a href="#6-3-1-2-服务降级方法" class="headerlink" title="6.3.1.2 服务降级方法"></a>6.3.1.2 服务降级方法</h4><p>pring Cloud Hystrix能保证服务调用者在调用异常服务时快速的返回结果，避免大量的同步等待，这是通过HystrixCommand的fallback方法实现的。</p>
<p><strong>熔断器的核心：线程隔离和服务降级。</strong></p>
<ul>
<li>线程隔离：是指Hystrix为每个依赖服务调用一个小的线程池，如果线程池用尽，调用立即被拒绝，默认不采用排队。</li>
<li>服务降级(兜底方法)：优先保证核心服务，而非核心服务不可用或弱可用。触发Hystrix服务降级的情况：线程池已满、请求超时。</li>
</ul>
<p>虽然A服务仍然不可用，但采用fallback的方式可以给用户一个友好的提示结果，这样就避免了其他服务的崩溃问题。 </p>
<h4 id="6-4-入门程序"><a href="#6-4-入门程序" class="headerlink" title="6.4 入门程序"></a>6.4 入门程序</h4><p>目标：服务提供者的服务出现了故障，服务消费者快速失败给用户友好提示。体验服务降级好处。</p>
<h5 id="6-4-1-添加依赖"><a href="#6-4-1-添加依赖" class="headerlink" title="6.4.1 添加依赖"></a>6.4.1 添加依赖</h5><p>在服务消费方工程（eureka-client-consumer）添加hystrix依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--熔断器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="6-4-2-开启熔断器注解"><a href="#6-4-2-开启熔断器注解" class="headerlink" title="6.4.2 开启熔断器注解"></a>6.4.2 开启熔断器注解</h5><p>在消费方工程的启动类中添加开启熔断器的注解：<strong>@EnableCircuitBreaker</strong>；</p>
<p>或者直接添加一个组合注解：<strong>@SpringCloudApplication</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="comment">//@SpringCloudApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaConsumerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-4-3-编写服务降级方法"><a href="#6-4-3-编写服务降级方法" class="headerlink" title="6.4.3 编写服务降级方法"></a>6.4.3 编写服务降级方法</h5><!--注意：因为熔断的降级逻辑方法跟正常逻辑方法一样，必须保证相同的参数列表和返回值相同-->

<h6 id="6-4-3-1-作用在方法-类-上"><a href="#6-4-3-1-作用在方法-类-上" class="headerlink" title="6.4.3.1 作用在方法 / 类 上"></a>6.4.3.1 作用在方法 / 类 上</h6><p>在消费方工程的controller中，添加服务降级方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/consumer"</span>)</span><br><span class="line"><span class="comment">//作用在类上，就近原则，如果方法上已有，则以方法为准</span></span><br><span class="line"><span class="meta">@DefaultProperties</span>(defaultFallback = <span class="string">"defaultFallBackMethod"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/findById/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="comment">//作用在方法上，就近原则</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"fallBackFindById"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line"><span class="comment">//        String url = "http://localhost:9091/api/user/findById/" + id;</span></span><br><span class="line">      <span class="comment">//添加使用register+lb后，必修使用定义的名称，不可再使用写死的IP</span></span><br><span class="line">        String url = <span class="string">"http://eureka-client-provider/api/user/findById/"</span> + id;</span><br><span class="line">        String json = restTemplate.getForObject(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/testFallBack/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="comment">//需要添加该注解，实现类的兜底方法</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testEurekaById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        String url = <span class="string">"http://eureka-client-provider/api/user/findById/"</span> + id;</span><br><span class="line">        String json = restTemplate.getForObject(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(json);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//针对方法的，参数等必须相同</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fallBackFindById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Sorry..."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//针对类上的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">defaultFallBackMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"default Fall Back Method"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-5-熔断策略"><a href="#6-5-熔断策略" class="headerlink" title="6.5 熔断策略"></a>6.5 熔断策略</h4><h5 id="6-5-1-常见熔断策略"><a href="#6-5-1-常见熔断策略" class="headerlink" title="6.5.1 常见熔断策略"></a>6.5.1 常见熔断策略</h5><p>常见熔断策略配置：</p>
<ul>
<li>熔断后休眠时间：sleepWindowInMilliseconds</li>
<li>熔断触发最小请求次数：requestVolumeThreshold</li>
<li>熔断触发错误比例阈值：errorThresholdPercentage</li>
<li>熔断超时时间：timeoutInMilliseconds<br><strong>信号量隔离：strategy: SEMAPHORE</strong>    <ul>
<li>与调用线程相同 </li>
<li>无线程切换，开销低 </li>
<li>异步：不支持 </li>
<li>并发支持：</li>
</ul>
</li>
</ul>
<h5 id="6-5-2-配置熔断策略"><a href="#6-5-2-配置熔断策略" class="headerlink" title="6.5.2 配置熔断策略"></a>6.5.2 配置熔断策略</h5><p>在服务<strong>消费方工程【eureka-client-consumer】</strong>配置如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置熔断策略：</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line">  <span class="attr">command:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">circuitBreaker:</span></span><br><span class="line">        <span class="comment"># 触发熔断错误比例阈值，默认值50%</span></span><br><span class="line">        <span class="attr">errorThresholdPercentage:</span> <span class="number">50</span></span><br><span class="line">        <span class="comment"># 熔断后休眠时长，默认值5秒</span></span><br><span class="line">        <span class="attr">sleepWindowInMilliseconds:</span> <span class="number">5000</span></span><br><span class="line">        <span class="comment"># 熔断触发最小请求次数，默认值是20</span></span><br><span class="line">        <span class="attr">requestVolumeThreshold:</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">execution:</span></span><br><span class="line">        <span class="attr">isolation:</span></span><br><span class="line">          <span class="attr">thread:</span></span><br><span class="line">            <span class="comment"># 熔断超时设置，默认为1秒</span></span><br><span class="line">            <span class="attr">timeoutInMilliseconds:</span> <span class="number">2000</span></span><br></pre></td></tr></table></figure>

<h3 id="6-5-3-测试熔断超时时间"><a href="#6-5-3-测试熔断超时时间" class="headerlink" title="6.5.3 测试熔断超时时间"></a>6.5.3 测试熔断超时时间</h3><p>在服务提供方，让线程休眠超过2秒中（例如休息5秒中），这个时候会走Fallback方法（因为在熔断策略配置当中，我们配置了熔断超时时间为2秒中，一旦超过2秒，则认为被调用的服务挂了，因此走Fallback【兜底】方法）。</p>
<h3 id="5-5-4-测试熔断错误比例"><a href="#5-5-4-测试熔断错误比例" class="headerlink" title="5.5.4 测试熔断错误比例"></a>5.5.4 测试熔断错误比例</h3><ul>
<li><p><strong>把提供方线程休眠的代码删除</strong></p>
</li>
<li><p>在<strong>服务消费方</strong>编写抛出异常的代码   1    2</p>
</li>
<li><p>如何测试：</p>
<p>访问<code>&lt;http://localhost:8080/consumer/findById/2&gt;</code> 访问3（50%）次以上，那么这个时候访问id=1的用户信息无法访问到，需要等待熔断休眠后（默认5秒），就可以正常访问id=1的用户了。</p>
</li>
</ul>
<h3 id="RPC与HTTP区别"><a href="#RPC与HTTP区别" class="headerlink" title="RPC与HTTP区别"></a>RPC与HTTP区别</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">1、传输协议</span></span><br><span class="line"><span class="attr">RPC，可以基于TCP协议，也可以基于HTTP协议</span></span><br><span class="line"><span class="attr">HTTP，基于HTTP协议</span></span><br><span class="line"></span><br><span class="line"><span class="attr">2、传输效率</span></span><br><span class="line"><span class="attr">RPC，使用自定义的TCP协议，可以让请求报文体积更小，或者使用HTTP2协议，也可以很好的减少报文的体积，提高传输效率</span></span><br><span class="line"><span class="attr">HTTP，如果是基于HTTP1.1的协议，请求中会包含很多无用的内容，如果是基于HTTP2.0，那么简单的封装一下是可以作为一个RPC来使用的，这时标准RPC框架更多的是服务治理</span></span><br><span class="line"></span><br><span class="line"><span class="attr">3、性能消耗，主要在于序列化和反序列化的耗时</span></span><br><span class="line"><span class="attr">RPC，可以基于thrift实现高效的二进制传输</span></span><br><span class="line"><span class="meta">HTTP，大部分是通过json来实现的，字节大小和序列化耗时都比thrift要更消耗性能</span>   <span class="string"></span></span><br><span class="line"><span class="attr">WebService：数据的传输xml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">4、负载均衡</span></span><br><span class="line"><span class="attr">RPC，基本都自带了负载均衡策略</span></span><br><span class="line"><span class="attr">HTTP，需要配置Nginx（10w），HAProxy、LVS（阿里2000年）来实现</span></span><br><span class="line"></span><br><span class="line"><span class="attr">5、服务治理</span></span><br><span class="line"><span class="attr">RPC，能做到自动通知，不影响上游（MQ）</span></span><br><span class="line"><span class="attr">HTTP，需要事先通知，修改Nginx/HAProxy配置</span></span><br><span class="line"></span><br><span class="line"><span class="attr">总结：</span></span><br><span class="line"><span class="attr">RPC主要用于公司内部的服务调用，性能消耗低，传输效率高，服务治理方便。HTTP主要用于对外的异构环境，浏览器接口调用，APP接口调用，第三方接口调用、支付接口调用等。</span></span><br></pre></td></tr></table></figure>

<h1 id="七-Feign进行远程调用"><a href="#七-Feign进行远程调用" class="headerlink" title="七.Feign进行远程调用"></a>七.Feign进行远程调用</h1><h4 id="7-1-介绍"><a href="#7-1-介绍" class="headerlink" title="7.1 介绍"></a>7.1 介绍</h4><p>Feign 的英文表意为“假装，伪装，变形”， 是一个<strong>http请求调用的轻量级框架</strong>，可以以Java接口注解的方式调用Http请求，而不用像Java中通过封装HTTP请求报文的方式直接调用。Feign通过处理注解，将请求模板化，当实际调用的时候，传入参数，根据参数再应用到请求上，进而转化成真正的请求，这种请求相对而言比较直观。<strong>Feign被广泛应用在Spring Cloud 的解决方案中</strong>，是学习基于Spring Cloud 微服务架构不可或缺的重要组件。</p>
<p><img src="1563174971237.png" alt=""></p>
<p>Feign是声明式的web service客户端，它<strong>让微服务之间的调用变得更简单了，类似controller调用service</strong>。Spring Cloud集成了Ribbon和Eureka，可在使用Feign时提供负载均衡的http客户端。 </p>
<h5 id="7-1-1-小结"><a href="#7-1-1-小结" class="headerlink" title="7.1.1 小结"></a>7.1.1 小结</h5><ul>
<li>集成Ribbon的负载均衡功能</li>
<li>集成Eureka服务注册与发现功能</li>
<li>集成了Hystrix的熔断器功能</li>
<li>支持请求压缩</li>
<li>Feign以更加优雅的方式编写远程调用代码，并简化重复代码</li>
</ul>
<h4 id="7-2-入门程序"><a href="#7-2-入门程序" class="headerlink" title="7.2 入门程序"></a>7.2 入门程序</h4><h5 id="7-2-1-需求"><a href="#7-2-1-需求" class="headerlink" title="7.2.1 需求"></a>7.2.1 需求</h5><p>使用Feign替代RestTemplate发送Rest请求</p>
<p>使用Feign编写程序的基本模板：</p>
<p>1、在消费方添加feign的依赖</p>
<p>2、编写XxxFeign</p>
<p>3、在启动类中要开启Feign</p>
<p>4、在Controller中注入Feign，完成调用</p>
<h5 id="7-2-2-代码实现"><a href="#7-2-2-代码实现" class="headerlink" title="7.2.2 代码实现"></a>7.2.2 代码实现</h5><h6 id="7-2-2-1-添加依赖"><a href="#7-2-2-1-添加依赖" class="headerlink" title="7.2.2.1 添加依赖"></a>7.2.2.1 添加依赖</h6><p>在<strong>服务消费方</strong>【本次工程：eureka-client-consumer】添加Feign依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--feign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="7-2-2-2-编写Feign"><a href="#7-2-2-2-编写Feign" class="headerlink" title="7.2.2.2 编写Feign"></a>7.2.2.2 编写Feign</h6><p>在服务消费方编写Feign客户端接口UserFeign，用于发送请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"eureka-client-provsider"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeign</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/api/user/findById/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function">String <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="7-2-2-3-编写Controller"><a href="#7-2-2-3-编写Controller" class="headerlink" title="7.2.2.3 编写Controller"></a>7.2.2.3 编写Controller</h6><p>在服务消费方编写FeignConsumerController，注入UserFeign并发送请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/feign"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConsumerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span>(required = <span class="keyword">false</span>)</span><br><span class="line">  <span class="keyword">private</span> UserFeign userFeign;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/findById/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">    String json = userFeign.findById(id);</span><br><span class="line">    <span class="keyword">return</span> json;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="7-2-2-4-开启Feign功能"><a href="#7-2-2-4-开启Feign功能" class="headerlink" title="7.2.2.4 开启Feign功能"></a>7.2.2.4 开启Feign功能</h6><p>在启动类中添加<strong>@EnableFeignClients注解</strong>，开启Feign功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringCloudApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span>	<span class="comment">// 开启Feign客户端功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClientConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(EurekaClientConsumerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@LoadBalanced</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="7-2-2-5-测试"><a href="#7-2-2-5-测试" class="headerlink" title="7.2.2.5 测试"></a>7.2.2.5 测试</h6><p>启动服务并且进行访问测试 localhost:8080/feign/findById/1</p>
<h6 id="7-2-2-6-注意"><a href="#7-2-2-6-注意" class="headerlink" title="7.2.2.6 注意"></a>7.2.2.6 注意</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">使用Feign的时候,如果参数中带有@PathVariable形式的参数,则要用value属性去指定。</span></span><br><span class="line"><span class="meta">标明对应的参数,否则会抛出IllegalStateException异常，异常信息：Feign</span> <span class="string">PathVariable annotation was empty on param 0.</span></span><br></pre></td></tr></table></figure>

<h4 id="7-3-负载均衡"><a href="#7-3-负载均衡" class="headerlink" title="7.3 负载均衡"></a>7.3 负载均衡</h4><p>Feign本身集成了Ribbon依赖和自动配置，因此不需要额外引入依赖，也不需要再注入RestTemplate对象。Feign内置的ribbon默认设置了请求超时时长，默认是1000ms，可以修改ribbon内部有重试机制，一旦超时，会自动重新发起请求。如果不希望重试可以关闭配置。</p>
<p>我们可以在服务消费方application.yml中配置如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置负载均衡</span></span><br><span class="line"><span class="attr">eureka-client-consumer:</span></span><br><span class="line">  <span class="attr">ribbon:</span></span><br><span class="line">    <span class="attr">NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span> <span class="comment"># 配置为随机</span></span><br><span class="line">    <span class="attr">ConnectTimeout:</span> <span class="number">1000</span> <span class="comment"># 指的是建立连接所用的时间</span></span><br><span class="line">    <span class="attr">ReadTimeout:</span> <span class="number">2000</span>    <span class="comment"># 指的是建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">    <span class="attr">MaxAutoRetries:</span> <span class="number">0</span>    <span class="comment"># 最大重试次数(第一个服务)</span></span><br><span class="line">    <span class="attr">MaxAutoRetriesNextServer:</span> <span class="number">0</span>     <span class="comment"># 最大重试下一个服务次数(集群的情况才会用到)</span></span><br><span class="line">    <span class="attr">OkToRetryOnAllOperations:</span> <span class="literal">false</span> <span class="comment"># 是否对所有的请求都重试</span></span><br></pre></td></tr></table></figure>

<h4 id="7-4-熔断支持-Feign默认对Hystrix支持"><a href="#7-4-熔断支持-Feign默认对Hystrix支持" class="headerlink" title="7.4 熔断支持(Feign默认对Hystrix支持)"></a>7.4 熔断支持(Feign默认对Hystrix支持)</h4><p>代码模板：</p>
<p>1、在配置文件中开启熔断</p>
<p>2、在@FeignClient注解指定fallback属性=T.class</p>
<p>3、定义该类：需要实现UserFeign接口</p>
<h5 id="7-4-1-需求"><a href="#7-4-1-需求" class="headerlink" title="7.4.1 需求"></a>7.4.1 需求</h5><p>调用服务时，如果服务出现宕机，给用户响应一个友好提示。</p>
<h5 id="7-4-2-代码实现"><a href="#7-4-2-代码实现" class="headerlink" title="7.4.2 代码实现"></a>7.4.2 代码实现</h5><h6 id="7-4-2-1-开起Feign对熔断器支持"><a href="#7-4-2-1-开起Feign对熔断器支持" class="headerlink" title="7.4.2.1 开起Feign对熔断器支持"></a>7.4.2.1 开起Feign对熔断器支持</h6><p>开启Feign对熔断器支持，默认是关闭的。在服务消费方的application.yml文件中配置如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h6 id="7-4-2-2-编写Fallback处理类"><a href="#7-4-2-2-编写Fallback处理类" class="headerlink" title="7.4.2.2 编写Fallback处理类"></a>7.4.2.2 编写Fallback处理类</h6><p>创建熔断器的处理类，需要实现Feign客户端的接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFeignFallback</span> <span class="keyword">implements</span> <span class="title">UserFeign</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ERROR"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="7-4-2-3-调用Fallback"><a href="#7-4-2-3-调用Fallback" class="headerlink" title="7.4.2.3 调用Fallback"></a>7.4.2.3 调用Fallback</h6><p>在Feign客户端需要调用熔断器的处理类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"eureka-client-provider"</span>, fallback = UserFeignFallback<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">UserFeign</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/api/user/findById/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">String <span class="title">findById</span><span class="params">(@PathVariable(value = <span class="string">"id"</span>)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="7-4-2-4-测试"><a href="#7-4-2-4-测试" class="headerlink" title="7.4.2.4 测试"></a>7.4.2.4 测试</h6><p>PS：在消费方的controller中就无需添加@HystrixCommand、@DefaultProperties相关注解了。</p>
<p>停止服务提供方程序，发送请求 localhost:8080/feign/findById/1 可以查看到输出“ERROR”</p>
<h4 id="7-5-日志配置"><a href="#7-5-日志配置" class="headerlink" title="7.5 日志配置"></a>7.5 日志配置</h4><h5 id="7-5-1-介绍"><a href="#7-5-1-介绍" class="headerlink" title="7.5.1 介绍"></a>7.5.1 介绍</h5><p>Feign 提供了日志打印功能，可以通过配置来调整日志级别，从而了解 Feign 中 Http 请求的细节。 说白了就是对接口的调用情况进行监控和输出 。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">日志级别： </span></span><br><span class="line"><span class="meta"> </span> <span class="string">        NONE: 默认的，不显示任何日志</span></span><br><span class="line"></span><br><span class="line"><span class="meta"> </span> <span class="string">        BASIC：仅记录请求方法、URL、响应状态码以及执行时间</span></span><br><span class="line"></span><br><span class="line"><span class="meta"> </span> <span class="string">        HEADERS：除了BASIC中定义的信息以外，还有请求和响应的头信息</span></span><br><span class="line"></span><br><span class="line"><span class="meta"> </span> <span class="string">        FULL： 除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据</span></span><br></pre></td></tr></table></figure>

<h3 id="7-5-2-代码实现"><a href="#7-5-2-代码实现" class="headerlink" title="7.5.2 代码实现"></a>7.5.2 代码实现</h3><ul>
<li><p>创建Feign的配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在配置文件中开Feign客户端日志</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启Feign客户端日志  也可以直接扫feign包 </span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.test.feign.UserFeign:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="7-5-3-测试"><a href="#7-5-3-测试" class="headerlink" title="7.5.3 测试"></a>7.5.3 测试</h3><p>重启消费方并发送请求，可在idea的控制台查看log日志</p>
<h2 id="7-6-请求压缩"><a href="#7-6-请求压缩" class="headerlink" title="7.6 请求压缩"></a>7.6 请求压缩</h2><p>对文件上传、下载进行<strong>压缩【gzip     xxx.tar.gz/bz2】</strong>，指定文件上传大小。</p>
<p>SpringCloudFeign支持对请求和响应进行GZIP压缩，以减少通信过程中的性能损耗。通过配置开启请求与响应的压缩功能：</p>
<ul>
<li>开启压缩功能</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">	<span class="attr">compression:</span></span><br><span class="line">        <span class="attr">request:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启请求压缩</span></span><br><span class="line">        <span class="attr">response:</span></span><br><span class="line">            <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启响应压缩</span></span><br></pre></td></tr></table></figure>

<ul>
<li>对请求类型以及压缩大小进行限制</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无注释版</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">	<span class="attr">compression:</span></span><br><span class="line">		<span class="attr">request:</span></span><br><span class="line">			<span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">			<span class="attr">mime-types:</span>	<span class="string">text/html,application/xml,application/json</span></span><br><span class="line">			<span class="attr">min-request-size:</span> <span class="number">2048</span> </span><br><span class="line"><span class="comment">#  Feign配置</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">	<span class="attr">compression:</span></span><br><span class="line">		<span class="attr">request:</span></span><br><span class="line">			<span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启请求压缩</span></span><br><span class="line">			<span class="attr">mime-types:</span>	<span class="string">text/html,application/xml,application/json</span> <span class="comment"># 设置压缩的数据类型</span></span><br><span class="line">			<span class="attr">min-request-size:</span> <span class="number">2048</span> <span class="comment"># 设置触发压缩的大小下限</span></span><br><span class="line">			<span class="comment">#以上数据类型，压缩大小下限均为默认值</span></span><br></pre></td></tr></table></figure>

<h1 id="八-Spring-Cloud-Gateway网关"><a href="#八-Spring-Cloud-Gateway网关" class="headerlink" title="八.Spring Cloud Gateway网关"></a>八.Spring Cloud Gateway网关</h1><h4 id="8-1-API网关"><a href="#8-1-API网关" class="headerlink" title="8.1 API网关"></a>8.1 API网关</h4><p>API 网关出现的原因是微服务架构（分布式、soa）的出现，不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，会有以下的问题： </p>
<ul>
<li>客户端会多次请求不同的微服务，增加了客户端的复杂性。</li>
<li>存在跨域请求（CORS     A服务器—-&gt;B服务器资源），在一定场景下处理相对复杂。<ul>
<li><strong>CSRF：跨站的请求伪造</strong></li>
</ul>
</li>
<li>认证复杂，每个服务都需要独立认证。  url ：token（令牌or票据）</li>
<li>难以重构，随着项目的迭代，可能需要重新划分微服务。</li>
<li>某些微服务可能使用了不友好的协议，直接访问会有一定的困难。</li>
</ul>
<p>以上这些问题可以借助 API 网关解决。API 网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过 API 网关这一层。也就是说，API 的实现方面更多的考虑业务逻辑，而安全、性能、监控可以交由 API 网关来做，这样既提高业务灵活性又不缺安全性</p>
<p>使用 API 网关后的优点如下：</p>
<ul>
<li>易于监控。可以在网关收集监控数据并将其推送到外部系统进行分析。</li>
<li>易于认证。可以在网关上进行认证，然后再将请求转发到后端的微服务，而无须在每个微服务中进行认证。</li>
<li>减少了客户端与各个微服务之间的交互次数。</li>
</ul>
<h4 id="8-2-网关选型"><a href="#8-2-网关选型" class="headerlink" title="8.2 网关选型"></a>8.2 网关选型</h4><h5 id="8-2-1-网关选型"><a href="#8-2-1-网关选型" class="headerlink" title="8.2.1 网关选型"></a>8.2.1 网关选型</h5><ul>
<li>常用网关<ul>
<li>nginx</li>
<li>zuul</li>
<li>Spring cloud gateway</li>
</ul>
</li>
</ul>
<h5 id="8-2-2-Spring-Cloud-Gateway"><a href="#8-2-2-Spring-Cloud-Gateway" class="headerlink" title="8.2.2 Spring Cloud Gateway"></a>8.2.2 Spring Cloud Gateway</h5><h6 id="8-2-2-1-介绍"><a href="#8-2-2-1-介绍" class="headerlink" title="8.2.2.1 介绍"></a>8.2.2.1 介绍</h6><p>Spring Cloud Gateway 是 Spring Cloud 的一个<strong>全新项目</strong>，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。并且基于 Filter 链的方式提供了网关基本的功能，例如：安全、监控、限流等。</p>
<h6 id="2-2-2-2-术语"><a href="#2-2-2-2-术语" class="headerlink" title="2.2.2.2 术语"></a>2.2.2.2 术语</h6><ul>
<li><strong>Route（路由）</strong>：这是网关的基本构建块。它由一个 ID，一个目标 URI，一组断言和一组过滤器定义。如果断言为真，则路由匹配。</li>
<li><strong>Predicate（断言）</strong>：这是一个 <a href="http://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html">Java 8 的 Predicate</a>。输入类型是一个 <a href="https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/ServerWebExchange.html"><code>ServerWebExchange</code></a>。我们可以使用它来匹配来自 HTTP 请求的任何内容，例如 headers 或参数。    请求做一些配置</li>
<li><strong>Filter（过滤器）</strong>：这是<code>org.springframework.cloud.gateway.filter.GatewayFilter</code>的实例，我们可以使用它修改请求和响应</li>
</ul>
<h6 id="8-2-2-3-流程"><a href="#8-2-2-3-流程" class="headerlink" title="8.2.2.3 流程"></a>8.2.2.3 流程</h6><p>客户端向 Spring Cloud Gateway 发出请求。然后在 Gateway Handler Mapping 中找到与请求相匹配的路由，将其发送到 Gateway Web Handler。Handler 再通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑，然后返回。 过滤器之间用虚线分开是因为过滤器可能会在发送代理请求之前（“pre”）或之后（“post”）执行业务逻辑。</p>
<p><img src="1563263071310.png" alt=""></p>
<h4 id="8-3-入门程序"><a href="#8-3-入门程序" class="headerlink" title="8.3 入门程序"></a>8.3 入门程序</h4><h5 id="8-3-1-创建maven工程"><a href="#8-3-1-创建maven工程" class="headerlink" title="8.3.1 创建maven工程"></a>8.3.1 创建maven工程</h5><p>在springcloud-microservice工程下创建api-gateway子工程，并且添加需要的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="8-3-2-编写启动类"><a href="#8-3-2-编写启动类" class="headerlink" title="8.3.2 编写启动类"></a>8.3.2 编写启动类</h5><p>创建的工程也属于一个服务，因此我们也需要启动并且交个Eureka注册中心管理。在启动类中添加@EnableDiscoveryClient注解或者@EnableEurekaClient。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiGatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ApiGatewayApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-3-编写application-yml文件"><a href="#8-3-3-编写application-yml文件" class="headerlink" title="8.3.3 编写application.yml文件"></a>8.3.3 编写application.yml文件</h3><ul>
<li><p>配置Eureka</p>
</li>
<li><p>配置api的路由规则</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 路由(集合， - 代表集合)</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">eureka-client-provider-route</span>  <span class="comment"># id唯一标识，(可自定义)</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://127.0.0.1:9091</span>        <span class="comment"># 路由服务提供方地址</span></span><br><span class="line">          <span class="attr">predicates:</span>                       <span class="comment"># 路由拦截地址的规则(断言)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/user/**</span>             <span class="comment"># 拦截以/api/user开头请求的url</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="8-3-4-测试"><a href="#8-3-4-测试" class="headerlink" title="8.3.4 测试"></a>8.3.4 测试</h5><p>启动所有服务，访问测试 localhost:10010/api/user/findById/1 会拦截以/api/user/开头的url</p>
<h4 id="8-4-动态路由（LB）"><a href="#8-4-动态路由（LB）" class="headerlink" title="8.4 动态路由（LB）"></a>8.4 动态路由（LB）</h4><ul>
<li><p>刚才路由规则中，我们把路径对应服务地址写死了！如果服务提供者集群的话，这样做不合理。应该是<strong>根据服务名称</strong>，去Eureka注册中心查找服务对应的所有实例列表，然后进行动态路由！配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#          uri: http://127.0.0.1:9091</span></span><br><span class="line"><span class="attr">uri:</span> <span class="string">lb://eureka-client-provider</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动网关服务再次访问 localhost:10010/api/user/findById/1，配置了lb会路由不到不同的服务提供方    </p>
<p>PS：不同的负载均衡策略可能查看的结果不一样</p>
</li>
</ul>
<h4 id="8-5-过滤器"><a href="#8-5-过滤器" class="headerlink" title="8.5 过滤器"></a>8.5 过滤器</h4><p>由filter工作流程点，可以知道filter有着非常重要的作用，在“pre”类型的过滤器可以做参数校验、权限校验、流量监控、日志输出、协议转换等，在“post”类型的过滤器中可以做响应内容、响应头的修改，日志的输出，流量监控等。 (类似于spring webmvc的interceptor)</p>
<p>当我们有很多个服务时，就出现了许多重复的工作。</p>
<p>在微服务的上一层加一个全局的权限控制、限流、日志输出的Api Gatewat服务，起到一个服务边界的作用，外接的请求访问系统，必须先通过网关层，抽出并解决了重复工作。</p>
<p>SpringCloud Gateway过滤器：</p>
<ul>
<li>默认提供的过滤器-可以直接使用（出厂自带）</li>
<li>自定义过滤器</li>
</ul>
<p>在Spring Cloud Gateway中，filter从作用范围可分为另外两种，一种是针对于单个路由的gateway filter，它在配置文件中的写法同predict类似；另外一种是针对于所有路由的global gateway filer。</p>
<ul>
<li><p>自定义全局过滤器</p>
<ul>
<li><p>要求</p>
<ul>
<li><p>要实现GlobalFilter接口，还可以实现Ordered接口（指定过滤器的执行顺序）</p>
</li>
<li><p>编写的过滤器需要交给spring管理：@Component注解</p>
</li>
<li><p>需求：访问服务提供方需要认证的（登录成功后生成一个token）</p>
</li>
<li><p>代码实现：编写过滤器完成业务处理</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>自定义局部过滤器</p>
<ul>
<li><p>要求</p>
<ul>
<li><p>需要：extends AbstractGatewayFilterFactory</p>
</li>
<li><p>自定义的局部过滤器类名有要求的：XxxGatewayFilterFactory</p>
</li>
<li><p>需求：访问服务提供方的ip地址必须是本地的（ip限制）</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>如何指定启动顺序</p>
<ul>
<li>yaml文件中按照filter书写顺序执行</li>
<li>在方法中@Order注解设定顺序</li>
</ul>
</li>
</ul>
<h5 id="8-5-1-过滤器分类"><a href="#8-5-1-过滤器分类" class="headerlink" title="8.5.1 过滤器分类"></a>8.5.1 过滤器分类</h5><ul>
<li>默认过滤器：出厂自带，实现好了拿来就用，不需要实现<ul>
<li>全局默认过滤器</li>
<li>局部默认过滤器</li>
</ul>
</li>
<li>自定义过滤器：根据需求自己实现，实现后需配置，然后才能用。<ul>
<li>全局过滤器：作用在所有路由上。</li>
<li>局部过滤器：配置在具体路由下，只作用在当前路由上。</li>
</ul>
</li>
</ul>
<p>默认过滤器几十个，常见如下：</p>
<table>
<thead>
<tr>
<th>过滤器名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>AddRequestHeader</td>
<td>对匹配上的请求加上Header</td>
</tr>
<tr>
<td>AddRequestParameters</td>
<td>对匹配上的请求路由</td>
</tr>
<tr>
<td>AddResponseHeader</td>
<td>对从网关返回的响应添加Header</td>
</tr>
<tr>
<td>StripPrefix</td>
<td>对匹配上的请求路径去除前缀</td>
</tr>
</tbody></table>
<h5 id="8-5-2-配置过滤器"><a href="#8-5-2-配置过滤器" class="headerlink" title="8.5.2 配置过滤器"></a>8.5.2 配置过滤器</h5><h6 id="8-5-2-1-配置全局过滤器"><a href="#8-5-2-1-配置全局过滤器" class="headerlink" title="8.5.2.1 配置全局过滤器"></a>8.5.2.1 配置全局过滤器</h6><p>例：设置响应的头信息</p>
<ul>
<li><p>修改application.yml文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 路由(集合， - 代表集合)</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">eureka-client-provider-route</span>  <span class="comment"># id唯一标识，(可自定义)</span></span><br><span class="line"><span class="comment">#          uri: http://127.0.0.1:9091        # 路由服务提供方地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://eureka-client-provider</span>   <span class="comment"># 动态路由</span></span><br><span class="line">          <span class="attr">predicates:</span>                       <span class="comment"># 路由拦截地址的规则(断言)</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/user/**</span>             <span class="comment"># 拦截以/api/user开头请求的url</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Default-MyName,testGloble</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过浏览器F12查看</p>
<p>Network——1——Response Headers——X-Response-Default-MyName</p>
</li>
</ul>
<h6 id="8-5-2-2-配置局部过滤器"><a href="#8-5-2-2-配置局部过滤器" class="headerlink" title="8.5.2.2 配置局部过滤器"></a>8.5.2.2 配置局部过滤器</h6><ul>
<li><p>添加请求路径前缀</p>
<ul>
<li><p>修改application.yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 路由(集合， - 代表集合)</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">eureka-client-provider-route</span>  <span class="comment"># id唯一标识，(可自定义)</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://eureka-client-provider</span>  <span class="comment"># 动态路由</span></span><br><span class="line">          <span class="attr">predicates:</span>                       <span class="comment"># 路由拦截地址的规则(断言)</span></span><br><span class="line"><span class="comment">#            - Path=/api/user/**            # 拦截以/api/user开头请求的url</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/**</span>                      <span class="comment"># 匹配多级目录</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">PrefixPath=/api/user/findById</span> <span class="comment"># 指定请求的前缀，我们在访问的时候就不需要添加了</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Default-MyName,testGloble</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<ul>
<li><p>重启网关服务</p>
</li>
<li><p>测试 localhost:10010/1</p>
</li>
<li><ul>
<li><p>路由说明：</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>访问api网关地址</th>
<th>路由地址</th>
</tr>
</thead>
<tbody><tr>
<td>PrefixPath=/user</td>
<td><a href="http://localhost:10010/8">http://localhost:10010/8</a></td>
<td><a href="http://localhost:9091/user/8">http://localhost:9091/user/8</a></td>
</tr>
<tr>
<td>PrefixPath=/user/abc</td>
<td><a href="http://localhost:10010/8">http://localhost:10010/8</a></td>
<td><a href="http://localhost:9091/user/abc/8">http://localhost:9091/user/abc/8</a></td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>去除请求路径前缀</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">在gateway中通过配置路由过滤器StripPrefix，来指定路由要去掉的前缀个数。以实现映射路径中地址的去除。</span></span><br><span class="line"><span class="meta">例1：StripPrefix</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">路径/api/user/1将会被路由到/user/1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">例2：StripPrefix</span>=<span class="string">2</span></span><br><span class="line"><span class="attr">路径/api/user/1将会被路由到/1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改application.yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注释</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">10010</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 路由(集合， - 代表集合)</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">eureka-client-provider-route</span>  <span class="comment"># id唯一标识，(可自定义)</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://eureka-client-provider</span>  <span class="comment"># 动态路由</span></span><br><span class="line">          <span class="attr">predicates:</span>                       <span class="comment"># 路由拦截地址的规则(断言)</span></span><br><span class="line"><span class="comment">#            - Path=/api/user/**            # 拦截以/api/user开头请求的url</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/**</span>                      <span class="comment"># 匹配多级目录</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">PrefixPath=/api/user/findById</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span>                 <span class="comment"># 带前缀</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddResponseHeader=X-Response-Default-MyName,testGloble</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重启网关服务</p>
</li>
<li><p>测试 localhost:10010/xxx/api/user/findById/1</p>
</li>
<li><p>路由说明</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>访问网关地址</th>
<th>路由地址（提供方）</th>
</tr>
</thead>
<tbody><tr>
<td>StripPrefix=1</td>
<td><a href="http://localhost:1001/api/user/1">http://localhost:1001/api/user/1</a></td>
<td><a href="http://localhost:9091/user/1">http://localhost:9091/user/1</a></td>
</tr>
<tr>
<td>StripPrefix=2</td>
<td><a href="http://localhost:10010/api/user/1">http://localhost:10010/api/user/1</a></td>
<td><a href="http://localhost:9091/1">http://localhost:9091/1</a></td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<h5 id="8-5-3-自定义过滤器"><a href="#8-5-3-自定义过滤器" class="headerlink" title="8.5.3 自定义过滤器"></a>8.5.3 自定义过滤器</h5><p>自定义过滤器：参考官方的文档</p>
<ul>
<li><p>自定义全局的过滤器：必须实现接口：GlobalFilter、可以实现Ordered接口（指定该过滤器的执行顺序)</p>
<ul>
<li>需求：发送的请求中，必须携带令牌（无法访问）</li>
</ul>
</li>
<li><p>自定义局部的过滤器：必须实现接口：AbstractGatewayFilterFactory </p>
<ul>
<li>需求：限定请求的ip（A  可以访问    其他公司：不能访问）</li>
<li>自定义局部过滤器类的名称：不能随便写     XxxGatewayFilterFactory</li>
</ul>
</li>
</ul>
<h6 id="8-5-3-1-自定义全局过滤器"><a href="#8-5-3-1-自定义全局过滤器" class="headerlink" title="8.5.3.1 自定义全局过滤器"></a>8.5.3.1 自定义全局过滤器</h6><p>Spring Cloud 中常见的内置过滤器如下</p>
<p><img src="1563268861501.png" alt=""></p>
<p>如果要自定义全局过滤，我们需要实现GlobalFilter接口（也可以实现Ordered接口，该接口中的方法代表该过滤器执行的优先级，值越小，优先级越高）。</p>
<p><strong>PS：如果不会自定义全局过滤器，可以参考官方已实现的过滤器</strong>。（<code>https://cloud.spring.io/spring-cloud-static/Greenwich.SR2/single/spring-cloud.html</code>）[120 Developer Guide]</p>
<h6 id="8-5-3-1-1-需求"><a href="#8-5-3-1-1-需求" class="headerlink" title="8.5.3.1.1 需求"></a>8.5.3.1.1 需求</h6><p>判断请求是否包含了请求参数“token”，如果不包含请求参数“token”则不转发路由，否则执行正常的业务逻辑。 </p>
<h6 id="8-5-3-1-2-自定义全局过滤器"><a href="#8-5-3-1-2-自定义全局过滤器" class="headerlink" title="8.5.3.1.2 自定义全局过滤器"></a>8.5.3.1.2 自定义全局过滤器</h6><p>在网关服务工程中（在com.itheima.filter包下），自定义全局过滤器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 判断请求中是否携带token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange 封装了request和response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chain 过滤器链</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> reactor.core.publisher.Mono&lt;java.lang.Void&gt;</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1、获取request和response</span></span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        <span class="comment">// 2、判断请求参数是否携带token</span></span><br><span class="line">        String token = request.getQueryParams().getFirst(<span class="string">"token"</span>);</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"token is empty!!!"</span>);</span><br><span class="line">            response.setStatusCode(HttpStatus.UNAUTHORIZED);    <span class="comment">// 设置响应状态码</span></span><br><span class="line">            <span class="comment">// 不放行</span></span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 放行，加入过滤器链中</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">// @Description 指定过滤器的执行顺序，值越小优先级越高</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PS：方法参数说明</span><br><span class="line">ServerWebExchange exchange：Contract <span class="keyword">for</span> an HTTP request-response interaction. Provides access to the HTTP request and response and also exposes additional server-side processing related properties and features such as request attributes（官方）</span><br><span class="line">ServerWebExchange是一个HTTP请求-响应交互的契约。提供对HTTP请求和响应的访问，并公开额外的 服务器 端处理相关属性和特性，如请求属性。（存放着重要的请求-响应属性、请求实例和响应实例等等，有点像 Context 的角色）</span><br><span class="line"></span><br><span class="line">GatewayFilterChain chain：过滤器链（将所有的过滤器加入该链中，相当于我们之前学习的springmvc的拦截器链）</span><br></pre></td></tr></table></figure>

<h6 id="8-5-3-1-3-测试"><a href="#8-5-3-1-3-测试" class="headerlink" title="8.5.3.1.3 测试"></a>8.5.3.1.3 测试</h6><p>启动网关服务，发送请求：</p>
<ul>
<li><p>不携带token请求 localhost:10010/xxx/api/user/findById/1</p>
<p>返回401错误</p>
</li>
<li><p>携带token请求  localhost:10010/xxx/api/user/findById/1?token=666</p>
<p>正常访问</p>
</li>
</ul>
<h6 id="8-5-3-2-自定义局部过滤器"><a href="#8-5-3-2-自定义局部过滤器" class="headerlink" title="8.5.3.2 自定义局部过滤器"></a>8.5.3.2 自定义局部过滤器</h6><p>创建自定义局部过滤器，代码实现如下：（定义局部过滤器时，要求过滤器类的名称有一定的规范性。XxxGatewayFilterFactory ）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IpForbidGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">IpForbidGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IpForbidGatewayFilterFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Config<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//指定字段的顺序（必须）</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">"ip"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// grab configuration from Config object</span></span><br><span class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 1、获取request和response</span></span><br><span class="line">            ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">            ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">            <span class="comment">// 2、获取服务器端ip</span></span><br><span class="line">            String hostAddress = request.getRemoteAddress().getAddress().getHostAddress();</span><br><span class="line">            <span class="comment">// 3、获取配置文件中的ip</span></span><br><span class="line">            String ip = config.getIp();</span><br><span class="line">            System.out.println(ip);</span><br><span class="line">            <span class="keyword">if</span> (ip.equals(hostAddress))&#123;</span><br><span class="line">                <span class="comment">// 放行</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置响应的状态码</span></span><br><span class="line">            response.setStatusCode(HttpStatus.FORBIDDEN);</span><br><span class="line">            <span class="keyword">return</span> response.setComplete();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//将配置文件中的局部过滤器的值映射到该属性上</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> ip;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIp</span><span class="params">(String ip)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.ip = ip;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="8-5-3-2-3-配置局部过滤器（坑）"><a href="#8-5-3-2-3-配置局部过滤器（坑）" class="headerlink" title="8.5.3.2.3 配置局部过滤器（坑）"></a>8.5.3.2.3 配置局部过滤器（坑）</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">坑：在定义局部过滤器时，要求过滤器类的名称有一定的规范性。例如：XxxGatewayFilterFactory。配置局部过滤的名称时，并不是任意写，默认截取该类的XxxGatewayFilterFactory的GatewayFilterFactory前半部分，例如为Xxx。</span></span><br></pre></td></tr></table></figure>

<h6 id="8-5-3-2-4-测试"><a href="#8-5-3-2-4-测试" class="headerlink" title="8.5.3.2.4 测试"></a>8.5.3.2.4 测试</h6><p>启动网关服务，发送请求  localhost:10010/xxx/api/user/findById/1?token=666</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">温馨提示：</span></span><br><span class="line"><span class="attr">JAVA</span> <span class="string">Web开发过程中,很多场景下需要获取访问终端的IP,对应方法getRemoteAddress。0:0:0:0:0:0:0:1，这个是IPv6地址,当前互联网环境下仍以ipv4为主。在较高版本的操作系统，Win7/Win10等启用了ipv6，大家需要手工禁止，或者通过参数控制。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">在jvm命令行添加以下参数</span></span><br><span class="line"><span class="meta">-Djava.net.preferIPv4Stack</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h1 id="九-Spring-Cloud-Config配置中心"><a href="#九-Spring-Cloud-Config配置中心" class="headerlink" title="九.Spring Cloud Config配置中心"></a>九.Spring Cloud Config配置中心</h1><h4 id="9-1-介绍"><a href="#9-1-介绍" class="headerlink" title="9.1 介绍"></a>9.1 介绍</h4><p>分布式系统中，由于服务数量非常多，配置文件分散在不同微服务项目中，管理极其不方便。为了便于集中配置的统一管理，在分布式架构中通常会使用分布式配置中心组件。Spring Cloud Config最大的优势就是和Spring的无缝集成，对于已有的Spring应用程序的迁移成本非常低，结合Spring Boot可使项目有更加统一的标准（包括依赖版本和约束规范），避免了因集成不同开发软件造成的版本依赖冲突等问题 。也支持配置文件放在远程仓库Git(GitHub、<strong>码云</strong>)。配置中心本质上是一个微服务，同样需要注册到Eureka服务中心！</p>
<h4 id="9-2-GIT远程仓库配置"><a href="#9-2-GIT远程仓库配置" class="headerlink" title="9.2 GIT远程仓库配置"></a>9.2 GIT远程仓库配置</h4><h5 id="9-2-1-创建远程仓库"><a href="#9-2-1-创建远程仓库" class="headerlink" title="9.2.1 创建远程仓库"></a>9.2.1 创建远程仓库</h5><h5 id="9-2-2-创建配置文件"><a href="#9-2-2-创建配置文件" class="headerlink" title="9.2.2 创建配置文件"></a>9.2.2 创建配置文件</h5><ul>
<li><p>第一步：创建配置文件：统一管理</p>
<ul>
<li>配置文件命名规则：{application}-{profile}.yml或{application}-{profile}.properties<ul>
<li>application：应用名称，例如：user</li>
<li>profile：指定应用环境，例如：开发环境dev，测试环境test，生产环境pro等<ul>
<li>开发环境 user-dev.yml</li>
<li>测试环境 user-test.yml</li>
<li>生产环境 user-pro.yml</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>第二步：创建配置文件并提交：将工程服务提供方工程【eureka-client-provider】下的配置文件内容复制过来</p>
</li>
</ul>
<h4 id="9-3-搭建配置中心服务"><a href="#9-3-搭建配置中心服务" class="headerlink" title="9.3 搭建配置中心服务"></a>9.3 搭建配置中心服务</h4><h5 id="9-3-1-创建工程"><a href="#9-3-1-创建工程" class="headerlink" title="9.3.1 创建工程"></a>9.3.1 创建工程</h5><p>在父工程 springcloud-microservice 下继续创建配置中心服务工程config-center-server，并且需要注册到注册中心，因此需要添加如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置中心--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="9-3-2-编写启动类"><a href="#9-3-2-编写启动类" class="headerlink" title="9.3.2 编写启动类"></a>9.3.2 编写启动类</h5><p>在启动类中添加<strong>@EnableConfigServer</strong>、<strong>@EnableDiscoveryClient</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span>	<span class="comment">// 开启eureka</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span> <span class="comment">// 开启config服务支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigCenterServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(ConfigCenterServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="9-3-3-编写配置文件"><a href="#9-3-3-编写配置文件" class="headerlink" title="9.3.3 编写配置文件"></a>9.3.3 编写配置文件</h5><ul>
<li><p>application.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">12000</span> <span class="comment"># 端口号</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">config-server</span> <span class="comment"># 应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="comment"># 配置gitee的仓库地址</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://gitee.com/projectname/project-spring-cloud-config.git</span></span><br><span class="line"><span class="comment"># Eureka服务中心配置</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment"># 注册Eureka Server集群</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br><span class="line"><span class="comment"># com.itheima 包下的日志级别都为Debug</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h5 id="9-3-4-启动测试"><a href="#9-3-4-启动测试" class="headerlink" title="9.3.4 启动测试"></a>9.3.4 启动测试</h5><ul>
<li>启动注册中心服务以及该服务进行测试 localhost:12000/user-dev.yml</li>
</ul>
<h4 id="9-4-服务获取配置中心配置信息"><a href="#9-4-服务获取配置中心配置信息" class="headerlink" title="9.4 服务获取配置中心配置信息"></a>9.4 服务获取配置中心配置信息</h4><h5 id="9-4-1-需求"><a href="#9-4-1-需求" class="headerlink" title="9.4.1 需求"></a>9.4.1 需求</h5><p>服务提供方工程中，配置文件内容不在由该服务自己去提供，而是从配置中心上获取。</p>
<h5 id="9-4-2-添加依赖"><a href="#9-4-2-添加依赖" class="headerlink" title="9.4.2 添加依赖"></a>9.4.2 添加依赖</h5><p>在<strong>服务提供方</strong>【eureka-client-provider】添加Spring Cloud Config依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring cloud 配置中心--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="9-4-3-修改配置"><a href="#9-4-3-修改配置" class="headerlink" title="9.4.3 修改配置"></a>9.4.3 修改配置</h5><ul>
<li><p>删除提供方application.yml文件；   </p>
</li>
<li><p>添加bootstrap.yml文件，配置内容如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">user</span> <span class="comment"># 与远程仓库中的配置文件的application保持一致，&#123;application&#125;-&#123;profile&#125;.yml</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span> <span class="comment"># 远程仓库中的配置文件的profile保持一致</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span> <span class="comment"># 远程仓库中的版本保持一致</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 使用配置中心</span></span><br><span class="line">        <span class="attr">service-id:</span> <span class="string">config-server</span> <span class="comment"># 配置中心服务id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#向Eureka服务中心集群注册服务</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://127.0.0.1:10086/eureka</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>当使用 Spring Cloud 的时候，配置信息一般是从 config server 加载的，为了取得配置信息（比如密码等），你需要一些提早的或引导配置。因此，把 config server 信息放在 bootstrap.yml，用来加载真正需要的配置信息。 </p>
</li>
<li><p>application.yml和bootstrap.yml文件的说明</p>
<ul>
<li>bootstrap.yml文件是SpringBoot的默认配置文件，而且其加载时间相比于application.yml优先级更高（优先加载）</li>
<li>bootstrap.yml（系统级别）可以理解成系统级别的一些参数配置，一般不会变动</li>
<li>application.yml（应用级别）用来定义应用级别的参数</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="9-4-4-启动测试"><a href="#9-4-4-启动测试" class="headerlink" title="9.4.4 启动测试"></a>9.4.4 启动测试</h5><p>启动注册中心、服务提供方、网关服务、配置中心服务，判断是否能够进行调用</p>
<h1 id="十-Spring-Cloud-Bus消息总线"><a href="#十-Spring-Cloud-Bus消息总线" class="headerlink" title="十.Spring Cloud Bus消息总线"></a>十.Spring Cloud Bus消息总线</h1><p>消息总线：修改配置文件后，程序无需重新启动。</p>
<p>Bus集成的：MQ（RabbitMQ            常见的消息队列ActiveMQ、kafka【大数据】、RocketMQ）</p>
<p>目前并不完全自动化，需要：手动的进行广播</p>
<p>建议使用zookeeper：watch 等其他工具</p>
<h4 id="10-1-Spring-Cloud-Bus介绍"><a href="#10-1-Spring-Cloud-Bus介绍" class="headerlink" title="10.1 Spring Cloud Bus介绍"></a>10.1 Spring Cloud Bus介绍</h4><p>Spring Cloud Bus是用轻量的消息代理将分布式的节点连接起来,可以用于<strong>广播</strong>配置文件的更改或者服务的监控管理。一个关键的思想就是,消息总线可以为微服务做监控,也可以实现应用程序之间相互通信。 Spring Cloud Bus可选的消息代理线线泡括RabbitMQ、Kaka等。本次我们用 RabbitMQ作为 Spring Cloud的消息组件去刷新更改微服务的配置文件。</p>
<p>Spring Cloud Bus的一个功能就是让这个过程变得简单,当远程Git仓库的配置更改后,只需要向某一个微服务实例发送一个<strong>Post请求</strong>,通过消息组件通知其他微 服务实例重新拉取配置文件。 </p>
<h4 id="10-2-入门程序"><a href="#10-2-入门程序" class="headerlink" title="10.2 入门程序"></a>10.2 入门程序</h4><h5 id="10-2-1-安装RabbitMQ"><a href="#10-2-1-安装RabbitMQ" class="headerlink" title="10.2.1 安装RabbitMQ"></a>10.2.1 安装RabbitMQ</h5><h5 id="10-2-2-更新配置中心服务"><a href="#10-2-2-更新配置中心服务" class="headerlink" title="10.2.2 更新配置中心服务"></a>10.2.2 更新配置中心服务</h5><ul>
<li><p>在工程中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--消息总线依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--RabbitMQ依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改application.yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rabbitmq的配置信息；如下配置的rabbit都是默认值，其实可以完全不配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line"><span class="comment"># 暴露触发消息总线的地址</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="comment"># 暴露触发消息总线的地址</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">bus-refresh</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="10-2-3-更新服务提供方服务"><a href="#10-2-3-更新服务提供方服务" class="headerlink" title="10.2.3 更新服务提供方服务"></a>10.2.3 更新服务提供方服务</h5><ul>
<li><p>在工程中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--消息总线依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-bus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--RabbitMQ依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-stream-binder-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--健康监控依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改bootstrap.yml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改UserController，添加<strong>@RefreshScope</strong>注解，刷新配置。</p>
</li>
</ul>
<h5 id="10-2-4-启动相关服务测试"><a href="#10-2-4-启动相关服务测试" class="headerlink" title="10.2.4 启动相关服务测试"></a>10.2.4 启动相关服务测试</h5><p>广播：发送POST请求，地址 127.0.0.1:12000/actuator/bus-refresh 再测试</p>
<h1 id="总结-Spring-Cloud总架构"><a href="#总结-Spring-Cloud总架构" class="headerlink" title="总结 Spring Cloud总架构"></a>总结 Spring Cloud总架构</h1><p><img src="1594713897762.png" alt=""></p>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/07/11/SpringBoot%E5%85%A5%E9%97%A8/" rel="prev" title="SpringBoot入门">
      <i class="fa fa-chevron-left"></i> SpringBoot入门
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/07/15/RabbitMQ%E5%85%A5%E9%97%A8/" rel="next" title="RabbitMQ入门">
      RabbitMQ入门 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-SpringCloud介绍"><span class="nav-number">1.</span> <span class="nav-text">一.SpringCloud介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-介绍"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">1.1 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-版本"><span class="nav-number">1.0.0.2.</span> <span class="nav-text">1.2 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-1-与SpringBoot版本匹配关系"><span class="nav-number">1.0.0.2.1.</span> <span class="nav-text">1.2.1 与SpringBoot版本匹配关系</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-使用RestTemplate发送请求"><span class="nav-number">2.</span> <span class="nav-text">二.使用RestTemplate发送请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-介绍"><span class="nav-number">2.0.0.1.</span> <span class="nav-text">2.1 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-HTTP客户端工具"><span class="nav-number">2.0.0.2.</span> <span class="nav-text">2.2 HTTP客户端工具</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-在工程中添加HttpClient依赖"><span class="nav-number">2.0.0.2.1.</span> <span class="nav-text">2.2.1 在工程中添加HttpClient依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-在工程中添加HttpClient工具类"><span class="nav-number">2.0.0.2.2.</span> <span class="nav-text">2.2.2 在工程中添加HttpClient工具类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-测试"><span class="nav-number">2.0.0.2.3.</span> <span class="nav-text">2.2.3 测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-RestTemplate入门程序"><span class="nav-number">2.0.0.3.</span> <span class="nav-text">2.3 RestTemplate入门程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-1-在springcloud-resttemplate添加依赖"><span class="nav-number">2.0.0.3.1.</span> <span class="nav-text">2.3.1 在springcloud-resttemplate添加依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-2-注入RestTemplate"><span class="nav-number">2.0.0.3.2.</span> <span class="nav-text">2.3.2 注入RestTemplate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-3-在测试类中测试"><span class="nav-number">2.0.0.3.3.</span> <span class="nav-text">2.3.3 在测试类中测试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-模拟服务调用"><span class="nav-number">3.</span> <span class="nav-text">三.模拟服务调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-创建服务提供方"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">3.1 创建服务提供方</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-1-创建工程"><span class="nav-number">3.0.0.1.1.</span> <span class="nav-text">3.1.1 创建工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-2-创建pojo"><span class="nav-number">3.0.0.1.2.</span> <span class="nav-text">3.1.2 创建pojo</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-3-编写Dao层"><span class="nav-number">3.0.0.1.3.</span> <span class="nav-text">3.1.3 编写Dao层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-4-编写Service层"><span class="nav-number">3.0.0.1.4.</span> <span class="nav-text">3.1.4 编写Service层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-5-编写Controller层"><span class="nav-number">3.0.0.1.5.</span> <span class="nav-text">3.1.5 编写Controller层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-6-编写application-yml文件"><span class="nav-number">3.0.0.1.6.</span> <span class="nav-text">3.1.6 编写application.yml文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-7-编写启动类"><span class="nav-number">3.0.0.1.7.</span> <span class="nav-text">3.1.7 编写启动类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-8-发布程序并访问测试"><span class="nav-number">3.0.0.1.8.</span> <span class="nav-text">3.1.8 发布程序并访问测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-创建服务消费方"><span class="nav-number">3.0.0.2.</span> <span class="nav-text">3.2 创建服务消费方</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-1-创建工程"><span class="nav-number">3.0.0.2.1.</span> <span class="nav-text">3.2.1 创建工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-2-编写启动类"><span class="nav-number">3.0.0.2.2.</span> <span class="nav-text">3.2.2 编写启动类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-3-编写Controller层"><span class="nav-number">3.0.0.2.3.</span> <span class="nav-text">3.2.3 编写Controller层</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-调用测试"><span class="nav-number">3.0.0.3.</span> <span class="nav-text">3.3 调用测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-问题总结"><span class="nav-number">3.0.0.4.</span> <span class="nav-text">3.4 问题总结</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-搭建Eureka注册中心"><span class="nav-number">4.</span> <span class="nav-text">四.搭建Eureka注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-Eureka介绍"><span class="nav-number">4.0.0.1.</span> <span class="nav-text">4.1 Eureka介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-Eureka入门程序"><span class="nav-number">4.0.0.2.</span> <span class="nav-text">4.2 Eureka入门程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-1-创建parent工程"><span class="nav-number">4.0.0.2.1.</span> <span class="nav-text">4.2.1 创建parent工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-2-创建Eureka服务-注册中心"><span class="nav-number">4.0.0.2.2.</span> <span class="nav-text">4.2.2 创建Eureka服务-注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-2-1-创建工程"><span class="nav-number">4.0.0.2.2.1.</span> <span class="nav-text">4.2.2.1 创建工程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-2-2-编写启动类"><span class="nav-number">4.0.0.2.2.2.</span> <span class="nav-text">4.2.2.2 编写启动类</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-2-3-编写application-yml文件"><span class="nav-number">4.0.0.2.2.3.</span> <span class="nav-text">4.2.2.3 编写application.yml文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-2-4-访问注册中心-localhost-10086-可以看到控制面板"><span class="nav-number">4.0.0.2.2.4.</span> <span class="nav-text">4.2.2.4 访问注册中心 localhost:10086 可以看到控制面板</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-3-创建Eureka客户端-提供方"><span class="nav-number">4.0.0.2.3.</span> <span class="nav-text">4.2.3 创建Eureka客户端-提供方</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-3-1-创建工程"><span class="nav-number">4.0.0.2.3.1.</span> <span class="nav-text">4.2.3.1 创建工程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-3-2-编写代码"><span class="nav-number">4.0.0.2.3.2.</span> <span class="nav-text">4.2.3.2 编写代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-3-3-编写启动类"><span class="nav-number">4.0.0.2.3.3.</span> <span class="nav-text">4.2.3.3 编写启动类</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-3-4-编写application-yml文件"><span class="nav-number">4.0.0.2.3.4.</span> <span class="nav-text">4.2.3.4 编写application.yml文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-3-5-发布工程"><span class="nav-number">4.0.0.2.3.5.</span> <span class="nav-text">4.2.3.5 发布工程</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-4-创建Eureka客户端-消费方"><span class="nav-number">4.0.0.2.4.</span> <span class="nav-text">4.2.4 创建Eureka客户端-消费方</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-4-1-创建工程"><span class="nav-number">4.0.0.2.4.1.</span> <span class="nav-text">4.2.4.1 创建工程</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-4-2-编写启动类"><span class="nav-number">4.0.0.2.4.2.</span> <span class="nav-text">4.2.4.2 编写启动类</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-4-3-编写Controller"><span class="nav-number">4.0.0.2.4.3.</span> <span class="nav-text">4.2.4.3 编写Controller</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-4-4-配置application-yml文件"><span class="nav-number">4.0.0.2.4.4.</span> <span class="nav-text">4.2.4.4 配置application.yml文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-4-5-发布工程"><span class="nav-number">4.0.0.2.4.5.</span> <span class="nav-text">4.2.4.5 发布工程</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-5-调用测试"><span class="nav-number">4.0.0.2.5.</span> <span class="nav-text">4.2.5 调用测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-6-Eureka其他（了解）"><span class="nav-number">4.0.0.2.6.</span> <span class="nav-text">4.2.6 Eureka其他（了解）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-6-1-注解说明"><span class="nav-number">4.0.0.2.6.1.</span> <span class="nav-text">4.2.6.1 注解说明</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-2-6-3-eureka控制台说明"><span class="nav-number">4.0.0.2.6.2.</span> <span class="nav-text">4.2.6.3 eureka控制台说明</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-6-4-服务续约"><span class="nav-number">4.0.0.3.</span> <span class="nav-text">4.2.6.4 服务续约</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-6-5-失效剔除"><span class="nav-number">4.0.0.4.</span> <span class="nav-text">4.2.6.5 失效剔除</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五-使用Ribbon实现负载均衡"><span class="nav-number">5.</span> <span class="nav-text">五.使用Ribbon实现负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-1-Ribbon介绍"><span class="nav-number">5.0.0.1.</span> <span class="nav-text">5.1 Ribbon介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-2-入门程序"><span class="nav-number">5.0.0.2.</span> <span class="nav-text">5.2 入门程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-1-启动两个提供方"><span class="nav-number">5.0.0.2.1.</span> <span class="nav-text">5.2.1 启动两个提供方</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-1-修改端口"><span class="nav-number">5.0.0.2.1.1.</span> <span class="nav-text">5.2.1.1 修改端口</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-2-编辑启动应用配置"><span class="nav-number">5.0.0.2.1.2.</span> <span class="nav-text">5.2.1.2 编辑启动应用配置</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-3-复制一份新应用"><span class="nav-number">5.0.0.2.1.3.</span> <span class="nav-text">5.2.1.3 复制一份新应用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-4-通过Eureka查看"><span class="nav-number">5.0.0.2.1.4.</span> <span class="nav-text">5.2.1.4 通过Eureka查看</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-1-5-修改消费方"><span class="nav-number">5.0.0.2.2.</span> <span class="nav-text">5.2.1.5 修改消费方</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-6-添加-LoadBalanced注解"><span class="nav-number">5.0.0.2.2.1.</span> <span class="nav-text">5.2.1.6 添加@LoadBalanced注解</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-7-修改ConsumerController"><span class="nav-number">5.0.0.2.2.2.</span> <span class="nav-text">5.2.1.7 修改ConsumerController</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-2-1-8-启动消费方"><span class="nav-number">5.0.0.2.2.3.</span> <span class="nav-text">5.2.1.8 启动消费方</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-1-9-访问测试"><span class="nav-number">5.0.0.2.3.</span> <span class="nav-text">5.2.1.9 访问测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-2-2-坑"><span class="nav-number">5.0.0.2.4.</span> <span class="nav-text">5.2.2 坑</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-3-Ribbon负载均衡策略"><span class="nav-number">5.0.0.3.</span> <span class="nav-text">5.3 Ribbon负载均衡策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-默认策略"><span class="nav-number">5.0.1.</span> <span class="nav-text">5.3.1 默认策略</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#5-3-2-Ribbon支持的轮询算法"><span class="nav-number">5.0.1.0.1.</span> <span class="nav-text">5.3.2 Ribbon支持的轮询算法</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六-使用Hystrix熔断器"><span class="nav-number">6.</span> <span class="nav-text">六.使用Hystrix熔断器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-Hystrix介绍"><span class="nav-number">6.0.0.1.</span> <span class="nav-text">6.1 Hystrix介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-雪崩效应"><span class="nav-number">6.0.0.2.</span> <span class="nav-text">6.2 雪崩效应</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-熔断器原理"><span class="nav-number">6.0.0.3.</span> <span class="nav-text">6.3 熔断器原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#6-3-1-熔断器"><span class="nav-number">6.0.0.3.1.</span> <span class="nav-text">6.3.1 熔断器</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#6-3-1-1-熔断器状态"><span class="nav-number">6.0.0.3.1.1.</span> <span class="nav-text">6.3.1.1 熔断器状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-2-服务降级方法"><span class="nav-number">6.0.0.4.</span> <span class="nav-text">6.3.1.2 服务降级方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-入门程序"><span class="nav-number">6.0.0.5.</span> <span class="nav-text">6.4 入门程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#6-4-1-添加依赖"><span class="nav-number">6.0.0.5.1.</span> <span class="nav-text">6.4.1 添加依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-4-2-开启熔断器注解"><span class="nav-number">6.0.0.5.2.</span> <span class="nav-text">6.4.2 开启熔断器注解</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-4-3-编写服务降级方法"><span class="nav-number">6.0.0.5.3.</span> <span class="nav-text">6.4.3 编写服务降级方法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#6-4-3-1-作用在方法-类-上"><span class="nav-number">6.0.0.5.3.1.</span> <span class="nav-text">6.4.3.1 作用在方法 &#x2F; 类 上</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5-熔断策略"><span class="nav-number">6.0.0.6.</span> <span class="nav-text">6.5 熔断策略</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#6-5-1-常见熔断策略"><span class="nav-number">6.0.0.6.1.</span> <span class="nav-text">6.5.1 常见熔断策略</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-5-2-配置熔断策略"><span class="nav-number">6.0.0.6.2.</span> <span class="nav-text">6.5.2 配置熔断策略</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-3-测试熔断超时时间"><span class="nav-number">6.0.1.</span> <span class="nav-text">6.5.3 测试熔断超时时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-4-测试熔断错误比例"><span class="nav-number">6.0.2.</span> <span class="nav-text">5.5.4 测试熔断错误比例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RPC与HTTP区别"><span class="nav-number">6.0.3.</span> <span class="nav-text">RPC与HTTP区别</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七-Feign进行远程调用"><span class="nav-number">7.</span> <span class="nav-text">七.Feign进行远程调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-介绍"><span class="nav-number">7.0.0.1.</span> <span class="nav-text">7.1 介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#7-1-1-小结"><span class="nav-number">7.0.0.1.1.</span> <span class="nav-text">7.1.1 小结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-入门程序"><span class="nav-number">7.0.0.2.</span> <span class="nav-text">7.2 入门程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#7-2-1-需求"><span class="nav-number">7.0.0.2.1.</span> <span class="nav-text">7.2.1 需求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-2-2-代码实现"><span class="nav-number">7.0.0.2.2.</span> <span class="nav-text">7.2.2 代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-2-1-添加依赖"><span class="nav-number">7.0.0.2.2.1.</span> <span class="nav-text">7.2.2.1 添加依赖</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-2-2-编写Feign"><span class="nav-number">7.0.0.2.2.2.</span> <span class="nav-text">7.2.2.2 编写Feign</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-2-3-编写Controller"><span class="nav-number">7.0.0.2.2.3.</span> <span class="nav-text">7.2.2.3 编写Controller</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-2-4-开启Feign功能"><span class="nav-number">7.0.0.2.2.4.</span> <span class="nav-text">7.2.2.4 开启Feign功能</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-2-5-测试"><span class="nav-number">7.0.0.2.2.5.</span> <span class="nav-text">7.2.2.5 测试</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-2-2-6-注意"><span class="nav-number">7.0.0.2.2.6.</span> <span class="nav-text">7.2.2.6 注意</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-负载均衡"><span class="nav-number">7.0.0.3.</span> <span class="nav-text">7.3 负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-熔断支持-Feign默认对Hystrix支持"><span class="nav-number">7.0.0.4.</span> <span class="nav-text">7.4 熔断支持(Feign默认对Hystrix支持)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#7-4-1-需求"><span class="nav-number">7.0.0.4.1.</span> <span class="nav-text">7.4.1 需求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-4-2-代码实现"><span class="nav-number">7.0.0.4.2.</span> <span class="nav-text">7.4.2 代码实现</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#7-4-2-1-开起Feign对熔断器支持"><span class="nav-number">7.0.0.4.2.1.</span> <span class="nav-text">7.4.2.1 开起Feign对熔断器支持</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-4-2-2-编写Fallback处理类"><span class="nav-number">7.0.0.4.2.2.</span> <span class="nav-text">7.4.2.2 编写Fallback处理类</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-4-2-3-调用Fallback"><span class="nav-number">7.0.0.4.2.3.</span> <span class="nav-text">7.4.2.3 调用Fallback</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#7-4-2-4-测试"><span class="nav-number">7.0.0.4.2.4.</span> <span class="nav-text">7.4.2.4 测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-日志配置"><span class="nav-number">7.0.0.5.</span> <span class="nav-text">7.5 日志配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#7-5-1-介绍"><span class="nav-number">7.0.0.5.1.</span> <span class="nav-text">7.5.1 介绍</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-2-代码实现"><span class="nav-number">7.0.1.</span> <span class="nav-text">7.5.2 代码实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-3-测试"><span class="nav-number">7.0.2.</span> <span class="nav-text">7.5.3 测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-6-请求压缩"><span class="nav-number">7.1.</span> <span class="nav-text">7.6 请求压缩</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#八-Spring-Cloud-Gateway网关"><span class="nav-number">8.</span> <span class="nav-text">八.Spring Cloud Gateway网关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-API网关"><span class="nav-number">8.0.0.1.</span> <span class="nav-text">8.1 API网关</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-网关选型"><span class="nav-number">8.0.0.2.</span> <span class="nav-text">8.2 网关选型</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-1-网关选型"><span class="nav-number">8.0.0.2.1.</span> <span class="nav-text">8.2.1 网关选型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-2-2-Spring-Cloud-Gateway"><span class="nav-number">8.0.0.2.2.</span> <span class="nav-text">8.2.2 Spring Cloud Gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#8-2-2-1-介绍"><span class="nav-number">8.0.0.2.2.1.</span> <span class="nav-text">8.2.2.1 介绍</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-2-2-2-术语"><span class="nav-number">8.0.0.2.2.2.</span> <span class="nav-text">2.2.2.2 术语</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-2-2-3-流程"><span class="nav-number">8.0.0.2.2.3.</span> <span class="nav-text">8.2.2.3 流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-入门程序"><span class="nav-number">8.0.0.3.</span> <span class="nav-text">8.3 入门程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-1-创建maven工程"><span class="nav-number">8.0.0.3.1.</span> <span class="nav-text">8.3.1 创建maven工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-2-编写启动类"><span class="nav-number">8.0.0.3.2.</span> <span class="nav-text">8.3.2 编写启动类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-3-编写application-yml文件"><span class="nav-number">8.0.1.</span> <span class="nav-text">8.3.3 编写application.yml文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-4-测试"><span class="nav-number">8.0.1.0.1.</span> <span class="nav-text">8.3.4 测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-动态路由（LB）"><span class="nav-number">8.0.1.1.</span> <span class="nav-text">8.4 动态路由（LB）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-5-过滤器"><span class="nav-number">8.0.1.2.</span> <span class="nav-text">8.5 过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-5-1-过滤器分类"><span class="nav-number">8.0.1.2.1.</span> <span class="nav-text">8.5.1 过滤器分类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-5-2-配置过滤器"><span class="nav-number">8.0.1.2.2.</span> <span class="nav-text">8.5.2 配置过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-2-1-配置全局过滤器"><span class="nav-number">8.0.1.2.2.1.</span> <span class="nav-text">8.5.2.1 配置全局过滤器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-2-2-配置局部过滤器"><span class="nav-number">8.0.1.2.2.2.</span> <span class="nav-text">8.5.2.2 配置局部过滤器</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-5-3-自定义过滤器"><span class="nav-number">8.0.1.2.3.</span> <span class="nav-text">8.5.3 自定义过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-3-1-自定义全局过滤器"><span class="nav-number">8.0.1.2.3.1.</span> <span class="nav-text">8.5.3.1 自定义全局过滤器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-3-1-1-需求"><span class="nav-number">8.0.1.2.3.2.</span> <span class="nav-text">8.5.3.1.1 需求</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-3-1-2-自定义全局过滤器"><span class="nav-number">8.0.1.2.3.3.</span> <span class="nav-text">8.5.3.1.2 自定义全局过滤器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-3-1-3-测试"><span class="nav-number">8.0.1.2.3.4.</span> <span class="nav-text">8.5.3.1.3 测试</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-3-2-自定义局部过滤器"><span class="nav-number">8.0.1.2.3.5.</span> <span class="nav-text">8.5.3.2 自定义局部过滤器</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-3-2-3-配置局部过滤器（坑）"><span class="nav-number">8.0.1.2.3.6.</span> <span class="nav-text">8.5.3.2.3 配置局部过滤器（坑）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#8-5-3-2-4-测试"><span class="nav-number">8.0.1.2.3.7.</span> <span class="nav-text">8.5.3.2.4 测试</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#九-Spring-Cloud-Config配置中心"><span class="nav-number">9.</span> <span class="nav-text">九.Spring Cloud Config配置中心</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-介绍"><span class="nav-number">9.0.0.1.</span> <span class="nav-text">9.1 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-GIT远程仓库配置"><span class="nav-number">9.0.0.2.</span> <span class="nav-text">9.2 GIT远程仓库配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#9-2-1-创建远程仓库"><span class="nav-number">9.0.0.2.1.</span> <span class="nav-text">9.2.1 创建远程仓库</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-2-2-创建配置文件"><span class="nav-number">9.0.0.2.2.</span> <span class="nav-text">9.2.2 创建配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-3-搭建配置中心服务"><span class="nav-number">9.0.0.3.</span> <span class="nav-text">9.3 搭建配置中心服务</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#9-3-1-创建工程"><span class="nav-number">9.0.0.3.1.</span> <span class="nav-text">9.3.1 创建工程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-3-2-编写启动类"><span class="nav-number">9.0.0.3.2.</span> <span class="nav-text">9.3.2 编写启动类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-3-3-编写配置文件"><span class="nav-number">9.0.0.3.3.</span> <span class="nav-text">9.3.3 编写配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-3-4-启动测试"><span class="nav-number">9.0.0.3.4.</span> <span class="nav-text">9.3.4 启动测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-4-服务获取配置中心配置信息"><span class="nav-number">9.0.0.4.</span> <span class="nav-text">9.4 服务获取配置中心配置信息</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#9-4-1-需求"><span class="nav-number">9.0.0.4.1.</span> <span class="nav-text">9.4.1 需求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-4-2-添加依赖"><span class="nav-number">9.0.0.4.2.</span> <span class="nav-text">9.4.2 添加依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-4-3-修改配置"><span class="nav-number">9.0.0.4.3.</span> <span class="nav-text">9.4.3 修改配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#9-4-4-启动测试"><span class="nav-number">9.0.0.4.4.</span> <span class="nav-text">9.4.4 启动测试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十-Spring-Cloud-Bus消息总线"><span class="nav-number">10.</span> <span class="nav-text">十.Spring Cloud Bus消息总线</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#10-1-Spring-Cloud-Bus介绍"><span class="nav-number">10.0.0.1.</span> <span class="nav-text">10.1 Spring Cloud Bus介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-2-入门程序"><span class="nav-number">10.0.0.2.</span> <span class="nav-text">10.2 入门程序</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#10-2-1-安装RabbitMQ"><span class="nav-number">10.0.0.2.1.</span> <span class="nav-text">10.2.1 安装RabbitMQ</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-2-2-更新配置中心服务"><span class="nav-number">10.0.0.2.2.</span> <span class="nav-text">10.2.2 更新配置中心服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-2-3-更新服务提供方服务"><span class="nav-number">10.0.0.2.3.</span> <span class="nav-text">10.2.3 更新服务提供方服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#10-2-4-启动相关服务测试"><span class="nav-number">10.0.0.2.4.</span> <span class="nav-text">10.2.4 启动相关服务测试</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结-Spring-Cloud总架构"><span class="nav-number">11.</span> <span class="nav-text">总结 Spring Cloud总架构</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description">学习笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">112</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
