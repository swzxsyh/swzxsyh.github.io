<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="了解zookeeper 了解zookeeper的应用场景 了解zookeeper的基本概念和数据模型 能够搭建和配置zookeeper 熟练操作zookeeper服务端和客户端命令 能够使用java api 操作zookeeper 理解zookeeper watch机制 能搭建zookeeper集群">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookepper 初识">
<meta property="og:url" content="http://yoursite.com/2020/06/16/Zookepper%20%E5%88%9D%E8%AF%86/index.html">
<meta property="og:site_name" content="Swzxsyh">
<meta property="og:description" content="了解zookeeper 了解zookeeper的应用场景 了解zookeeper的基本概念和数据模型 能够搭建和配置zookeeper 熟练操作zookeeper服务端和客户端命令 能够使用java api 操作zookeeper 理解zookeeper watch机制 能搭建zookeeper集群">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2020/06/16/Zookepper%20%E5%88%9D%E8%AF%86/1572831517484.png">
<meta property="og:image" content="http://yoursite.com/2020/06/16/Zookepper%20%E5%88%9D%E8%AF%86/1573197592193.png">
<meta property="og:image" content="http://yoursite.com/2020/06/16/Zookepper%20%E5%88%9D%E8%AF%86/1573475887256.png">
<meta property="article:published_time" content="2020-06-16T05:00:10.000Z">
<meta property="article:modified_time" content="2020-08-03T15:02:43.461Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/06/16/Zookepper%20%E5%88%9D%E8%AF%86/1572831517484.png">

<link rel="canonical" href="http://yoursite.com/2020/06/16/Zookepper%20%E5%88%9D%E8%AF%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Zookepper 初识 | Swzxsyh</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Swzxsyh</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">--学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/16/Zookepper%20%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="学习笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Swzxsyh">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Zookepper 初识
        </h1>

        <div class="post-meta">

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>了解zookeeper</li>
<li>了解zookeeper的应用场景</li>
<li>了解zookeeper的基本概念和数据模型</li>
<li>能够搭建和配置zookeeper</li>
<li>熟练操作zookeeper服务端和客户端命令</li>
<li>能够使用java api 操作zookeeper</li>
<li>理解zookeeper watch机制</li>
<li>能搭建zookeeper集群</li>
</ul>
<a id="more"></a>

<h1 id="一-介绍zookeeper"><a href="#一-介绍zookeeper" class="headerlink" title="一. 介绍zookeeper"></a>一. 介绍zookeeper</h1><ul>
<li>目标<ul>
<li>了解Zookeeper的概念</li>
<li>了解分布式的概念</li>
</ul>
</li>
<li>学习路径<ul>
<li>Zookeeper概述</li>
<li>Zookeeper的发展历程</li>
<li>什么是分布式</li>
<li>Zookeeper的应用场景</li>
</ul>
</li>
</ul>
<h4 id="1-1-zookeeper概述"><a href="#1-1-zookeeper概述" class="headerlink" title="1.1 zookeeper概述"></a>1.1 zookeeper概述</h4><p>Apache ZooKeeper的系统为分布式协调是构建分布式应用的高性能服务。<br>    ZooKeeper 本质上是一个分布式的小文件存储系统。提供基于类似于文件系统的目录树方式的数据存储，并且可以对树中的节点进行有效管理。从而用来维护和监控你存储的数据的状态变化。通过监控这些数据状态的变化，从而可以达到基于数据的集群管理。<br>    ZooKeeper 适用于存储和协同相关的关键数据，不适合用于大数据量存储。</p>
<h4 id="1-2-zookeeper被大量使用"><a href="#1-2-zookeeper被大量使用" class="headerlink" title="1.2 zookeeper被大量使用"></a>1.2 zookeeper被大量使用</h4><ul>
<li>Hadoop：使用ZooKeeper 做Namenode 的高可用。</li>
<li>HBase：保证集群中只有一个master，保存hbase:meta表的位置，保存集群中的RegionServer列表。</li>
<li>Kafka：集群成员管理，controller 节点选举。</li>
</ul>
<h4 id="1-3-什么是分布式"><a href="#1-3-什么是分布式" class="headerlink" title="1.3 什么是分布式"></a>1.3 什么是分布式</h4><h5 id="1-3-1-集中式系统"><a href="#1-3-1-集中式系统" class="headerlink" title="1.3.1 集中式系统"></a>1.3.1 集中式系统</h5><p>集中式系统，集中式系统中整个项目就是一个独立的应用，整个应用也就是整个项目，所有的东西都在一个应用里面。部署到一个服务器上。<br>布署项目时，放到一个tomcat里的。也称为单体架构</p>
<h4 id="1-3-2-分布式系统"><a href="#1-3-2-分布式系统" class="headerlink" title="1.3.2 分布式系统"></a>1.3.2 分布式系统</h4><ul>
<li>多台计算机构成</li>
<li>计算机之间通过网络进行通信 </li>
<li>彼此进行交互 </li>
<li>共同目标 </li>
</ul>
<h5 id="1-3-3-小结"><a href="#1-3-3-小结" class="headerlink" title="1.3.3 小结"></a>1.3.3 小结</h5><p>集中式：开发项目时都是在同一个应用里，布署到同一个tomcat，只有一个tomcat即可</p>
<p>分布：分多个工程开发，布署多个tomcat里</p>
<h4 id="1-4-zookeeper的应用场景"><a href="#1-4-zookeeper的应用场景" class="headerlink" title="1.4 zookeeper的应用场景"></a>1.4 zookeeper的应用场景</h4><h5 id="1-4-1-注册中心"><a href="#1-4-1-注册中心" class="headerlink" title="1.4.1 注册中心"></a>1.4.1 注册中心</h5><p>分布式应用中，通常需要有一套完整的命名规则，既能够产生唯一的名称又便于人识别和记住，通常情况下用树形的名称结构是一个理想的选择，树形的名称结构是一个有层次的目录结构。通过调用Zookeeper提供的创建节点的API，能够很容易创建一个全局唯一的path，这个path就可以作为一个名称。<br>Dubbo中使用ZooKeeper来作为其命名服务，维护全局的服务地址列表。</p>
<h5 id="1-4-2-配置中心"><a href="#1-4-2-配置中心" class="headerlink" title="1.4.2 配置中心"></a>1.4.2 配置中心</h5><p>​    数据发布/订阅即所谓的配置中心：发布者将数据发布到ZooKeeper一系列节点上面，订阅者进行数据订阅，当数据有变化时，可以及时得到数据的变化通知，达到<strong>动态获取数据</strong>的目的。</p>
<p>ZooKeeper 采用的是<strong>推拉结合</strong>的方式。</p>
<ul>
<li><p>推: 服务端会推给注册了监控节点的客户端 Wathcer 事件通知</p>
</li>
<li><p>拉: 客户端获得通知后，然后主动到服务端拉取最新的数据</p>
</li>
</ul>
<h5 id="1-4-3-分布式锁——非公平锁"><a href="#1-4-3-分布式锁——非公平锁" class="headerlink" title="1.4.3 分布式锁——非公平锁"></a>1.4.3 分布式锁——非公平锁</h5><p>分布式锁是控制分布式系统之间同步访问共享资源的一种方式。在分布式系统中，常常需要协调他们的动作。如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要互斥来防止彼此干扰来保证一致性，在这种情况下，便需要使用到分布式锁。</p>
<h5 id="1-4-4-分布式队列——公平锁"><a href="#1-4-4-分布式队列——公平锁" class="headerlink" title="1.4.4 分布式队列——公平锁"></a>1.4.4 分布式队列——公平锁</h5><p>在传统的单进程编程中，我们使用队列来存储一些数据结构，用来在多线程之间共享或传递数据。分布式环境下，我们同样需要一个类似单进程队列的组件，用来实现跨进程、跨主机、跨网络的数据共享和数据传递，这就是我们的分布式队列。</p>
<h5 id="1-4-5-负载均衡"><a href="#1-4-5-负载均衡" class="headerlink" title="1.4.5 负载均衡"></a>1.4.5 负载均衡</h5><p>负载均衡是通过负载均衡算法，用来把对某种资源的访问分摊给不同的设备，从而<strong>减轻单点</strong>的压力。</p>
<p>每台工作服务器在启动时都会去ZooKeeper的servers节点下注册临时节点，每台客户端在启动时都会去servers节点下取得所有可用的工作服务器列表，并通过一定的负载均衡算法计算得出一台工作服务器，并与之建立网络连接</p>
<h5 id="1-4-6-小结"><a href="#1-4-6-小结" class="headerlink" title="1.4.6 小结"></a>1.4.6 小结</h5><ul>
<li>Zookeeper概述</li>
<li>Zookeeper的发展历程</li>
<li>什么是分布式  应用是布署多台服务器上(多个tomcat)</li>
<li>Zookeeper的应用场景<ul>
<li>注册中心（房产中介）</li>
<li>配置中心（多台应用(服务) 修改配置文件，不需要重启）</li>
<li>分布式锁  多个应用（服务）同一时刻，只有一个服务能够执行某个操作</li>
<li>分布式队列：使得多进程、多服务间可以同步数据、传输数据、协同工作</li>
<li>负载均衡：使用多应用的调用频率比较平均</li>
</ul>
</li>
</ul>
<h1 id="二-zookeeper环境搭建"><a href="#二-zookeeper环境搭建" class="headerlink" title="二.zookeeper环境搭建"></a>二.zookeeper环境搭建</h1><ul>
<li><p>目标</p>
<p>安装Zookeeper</p>
</li>
<li><p>学习路径</p>
<ul>
<li>Zookeeper的发展历程</li>
<li>什么是分布式</li>
<li>Zookeeper的应用场景</li>
</ul>
</li>
</ul>
<h4 id="2-1-前提"><a href="#2-1-前提" class="headerlink" title="2.1 前提"></a>2.1 前提</h4><p>安装Docker</p>
<h4 id="2-2安装zookeeper"><a href="#2-2安装zookeeper" class="headerlink" title="2.2安装zookeeper"></a>2.2安装zookeeper</h4><h5 id="2-2-1-下载"><a href="#2-2-1-下载" class="headerlink" title="2.2.1 下载"></a>2.2.1 下载</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Docker拉取镜像</span></span><br><span class="line">$ docker pull zookeeper</span><br><span class="line"><span class="comment">#查看镜像文件</span></span><br><span class="line">$ docker images  </span><br><span class="line">REPOSITORY    TAG        IMAGE ID       CREATED      SIZE</span><br><span class="line">zookeeper    latest     454af3da184c   6 days ago    252MB</span><br></pre></td></tr></table></figure>

<h5 id="2-2-2-修改配置文件"><a href="#2-2-2-修改配置文件" class="headerlink" title="2.2.2 修改配置文件"></a>2.2.2 修改配置文件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用一个目录，创建zk配置文件/数据/日志目录</span></span><br><span class="line">$ mkdir conf  data <span class="built_in">log</span></span><br><span class="line">$ tree zk           </span><br><span class="line">zk</span><br><span class="line">├── conf</span><br><span class="line">├── data</span><br><span class="line">└── <span class="built_in">log</span></span><br><span class="line"><span class="comment"># 暂时启动zookeeper</span></span><br><span class="line">$ docker run -d --name zk --restart always zookeeper</span><br><span class="line"><span class="comment"># 复制配置文件</span></span><br><span class="line">$ docker cp -a zk:/conf/zoo.cfg ~/Program/zk/conf/zoo.cfg    </span><br><span class="line">$ cat ~/Program/zk/conf/zoo.cfg    </span><br><span class="line"></span><br><span class="line">dataDir=/data</span><br><span class="line">dataLogDir=/datalog</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=5</span><br><span class="line">syncLimit=2</span><br><span class="line">autopurge.snapRetainCount=3</span><br><span class="line">autopurge.purgeInterval=0</span><br><span class="line">maxClientCnxns=60</span><br><span class="line">standaloneEnabled=<span class="literal">true</span></span><br><span class="line">admin.enableServer=<span class="literal">true</span></span><br><span class="line">server.1=localhost:2888:3888;2181</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止并删除未配置的zookeeper容器</span></span><br><span class="line">$ docker stop zk &amp;&amp; docker rm zk</span><br><span class="line"><span class="comment"># 指定保存数据的目录：data目录</span></span><br><span class="line"><span class="comment"># 如果需要日志，可以创建log文件夹，指定dataLogDir属性</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-3-启动zookeeper"><a href="#2-2-3-启动zookeeper" class="headerlink" title="2.2.3 启动zookeeper"></a>2.2.3 启动zookeeper</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name zk --restart always \  </span><br><span class="line">-p 2181:2181 -p 2888:2888 -p 3888:3888 \</span><br><span class="line">-v /Users/swzxsyh/Program/zk/conf/zoo.cfg:/conf/zoo.cfg \</span><br><span class="line">-v /Users/swzxsyh/Program/zk/data:/data \</span><br><span class="line">-v /Users/swzxsyh/Program/zk/<span class="built_in">log</span>:/datalog \</span><br><span class="line">zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment">#zookeeper客户端端口，跟随端口，选择端口</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-4-启动客户端测试"><a href="#2-2-4-启动客户端测试" class="headerlink" title="2.2.4 启动客户端测试"></a>2.2.4 启动客户端测试</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载客户端，启动</span></span><br><span class="line">$ ./zkCli.sh     </span><br><span class="line">/usr/bin/java</span><br><span class="line">2020-06-16 17:13:31,750 [myid:] - INFO  [main:ClientCnxn@1653] - zookeeper.request.timeout value is 0. feature enabled=</span><br><span class="line"><span class="comment"># 省略中间输出...</span></span><br><span class="line"><span class="comment"># 出现此行即说明连接成功</span></span><br><span class="line">Welcome to ZooKeeper!</span><br><span class="line">2020-06-16 17:13:31,757 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn<span class="variable">$SendThread</span>@1112] - Opening socket connection to server localhost/127.0.0.1:2181. Will not attempt to authenticate using SASL (unknown error)</span><br><span class="line">JLine support is enabled</span><br><span class="line">2020-06-16 17:13:31,834 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn<span class="variable">$SendThread</span>@959] - Socket connection established, initiating session, client: /127.0.0.1:64028, server: localhost/127.0.0.1:2181</span><br><span class="line">[zk: localhost:2181(CONNECTING) 0] 2020-06-16 17:13:31,896 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):ClientCnxn<span class="variable">$SendThread</span>@1394] - Session establishment complete on server localhost/127.0.0.1:2181, sessionid = 0x100014a6eed0000, negotiated timeout = 30000</span><br><span class="line"></span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:None path:null</span><br><span class="line">[zk: localhost:2181(CONNECTED) 0]</span><br></pre></td></tr></table></figure>



<h5 id="2-2-5-小结"><a href="#2-2-5-小结" class="headerlink" title="2.2.5 小结"></a>2.2.5 小结</h5><ul>
<li>pull镜像</li>
<li>创建data/conf/log目录</li>
<li>复制zoo.cfg文件并加载启动</li>
</ul>
<h1 id="三-zookeeper基本操作"><a href="#三-zookeeper基本操作" class="headerlink" title="三.zookeeper基本操作"></a>三.zookeeper基本操作</h1><ul>
<li><p>目标</p>
<ul>
<li>Zookeeper的客户端命令</li>
<li>Zookeeper的java的api操作</li>
</ul>
</li>
<li><p>学习路径</p>
<ul>
<li><p>Zookeeper的数据结构</p>
</li>
<li><p>节点的分类</p>
<ul>
<li>持久性</li>
<li>临时性</li>
</ul>
</li>
<li><p>客户端命令（创建、查询、修改、删除）</p>
</li>
<li><p>Zookeeper的java的api介绍（创建、查询、修改、删除）</p>
</li>
<li><p>Zookeeper的watch机制</p>
<ul>
<li>NodeCache</li>
<li>PathChildrenCache</li>
<li>TreeCache</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="3-1-zookeeper数据结构"><a href="#3-1-zookeeper数据结构" class="headerlink" title="3.1 zookeeper数据结构"></a>3.1 zookeeper数据结构</h4><p>ZooKeeper 的数据模型是层次模型。层次模型常见于文件系统。</p>
<p>每个目录下面可以创建文件，也可以创建子目录，最终构成了一个树型结构。通过这种树型结构的目录，可以将文件分门别类的进行存放，方便我们后期查找。</p>
<ul>
<li>层次模型和key-value 模型是两种主流的数据模型。ZooKeeper 使用文件系统模型主要基于以下两点考虑<ul>
<li>文件系统的树形结构便于表达数据之间的层次关系。</li>
<li>文件系统的树形结构便于为不同的应用分配独立的命名空间（namespace 路径url）</li>
</ul>
</li>
</ul>
<p>ZooKeeper 的层次模型称作data tree。Datatree 的每个节点叫作znode（Zookeeper node）。不同于文件系统，每个节点都可以保存数据。每个节点都有一个版本(version)。版本从0 开始计数。</p>
<p><img src="1572831517484.png" alt=""></p>
<p>如图所示，data tree中有两个子树，用于应用1( /app1)和应用2（/app2）。</p>
<p>每个客户端进程pi 创建一个znode节点 p_i 在 /app1下， /app1/p_1就代表一个客户端在运行。</p>
<h4 id="3-2-节点的分类"><a href="#3-2-节点的分类" class="headerlink" title="3.2 节点的分类"></a>3.2 节点的分类</h4><ul>
<li>一个znode可以是持久性的，也可以是临时性的<ul>
<li>持久性znode[PERSISTENT]，这个znode一旦创建不会丢失，无论是zookeeper宕机，还是client宕机。</li>
<li>临时性的znode[EPHEMERAL]，如果zookeeper宕机了，或者client在指定的timeout时间内没有连接server，都会被认为丢失。 -e</li>
</ul>
</li>
<li>znode也可以是顺序性的，每一个顺序性的znode关联一个唯一的单调递增整数。这个单调递增整数是znode名字的后缀。<ul>
<li>持久顺序性的znode(PERSISTENT_SEQUENTIAL):znode 处理具备持久性的znode的特点之外，znode的名称具备顺序性。 -s</li>
<li>临时顺序性的znode(EPHEMERAL_SEQUENTIAL):znode处理具备临时性的znode特点，znode的名称具备顺序性。-s</li>
</ul>
</li>
</ul>
<h4 id="3-3-客户端命令"><a href="#3-3-客户端命令" class="headerlink" title="3.3 客户端命令"></a>3.3 客户端命令</h4><h5 id="3-3-1-查询所有命令"><a href="#3-3-1-查询所有命令" class="headerlink" title="3.3.1 查询所有命令"></a>3.3.1 查询所有命令</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 8] <span class="built_in">help</span></span><br><span class="line">ZooKeeper -server host:port cmd args</span><br><span class="line">addauth scheme auth</span><br><span class="line">close </span><br><span class="line">config [-c] [-w] [-s]</span><br><span class="line">connect host:port</span><br><span class="line">create [-s] [-e] [-c] [-t ttl] path [data] [acl]</span><br><span class="line">delete [-v version] path</span><br><span class="line">deleteall path</span><br><span class="line">delquota [-n|-b] path</span><br><span class="line">get [-s] [-w] path</span><br><span class="line">getAcl [-s] path</span><br><span class="line"><span class="built_in">history</span> </span><br><span class="line">listquota path</span><br><span class="line">ls [-s] [-w] [-R] path</span><br><span class="line">ls2 path [watch]</span><br><span class="line">printwatches on|off</span><br><span class="line">quit </span><br><span class="line">reconfig [-s] [-v version] [[-file path] | [-members serverID=host:port1:port2;port3[,...]*]] | [-add serverId=host:port1:port2;port3[,...]]* [-remove serverId[,...]*]</span><br><span class="line">redo cmdno</span><br><span class="line">removewatches path [-c|-d|-a] [-l]</span><br><span class="line">rmr path</span><br><span class="line"><span class="built_in">set</span> [-s] [-v version] path data</span><br><span class="line">setAcl [-s] [-v version] [-R] path acl</span><br><span class="line">setquota -n|-b val path</span><br><span class="line"><span class="built_in">stat</span> [-w] path</span><br><span class="line">sync path</span><br></pre></td></tr></table></figure>

<h5 id="3-3-2-查询根路径下的节点"><a href="#3-3-2-查询根路径下的节点" class="headerlink" title="3.3.2 查询根路径下的节点"></a>3.3.2 查询根路径下的节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 9] ls /zookeeper</span><br><span class="line">[config, quota]</span><br></pre></td></tr></table></figure>

<h5 id="3-3-3-创建普通永久节点"><a href="#3-3-3-创建普通永久节点" class="headerlink" title="3.3.3 创建普通永久节点"></a>3.3.3 创建普通永久节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建HelloZK节点，值为Hello,Zookeeper</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 10] create /HelloZK <span class="string">"Hello,Zookeeper"</span></span><br><span class="line">Created /HelloZK</span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] ls /HelloZK</span><br><span class="line">[]</span><br></pre></td></tr></table></figure>

<h5 id="3-3-4-创建带序号永久节点"><a href="#3-3-4-创建带序号永久节点" class="headerlink" title="3.3.4 创建带序号永久节点"></a>3.3.4 创建带序号永久节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 13] create -s /HelloZK_SEQ <span class="string">"ZK With SEQUENCE"</span></span><br><span class="line">Created /HelloZK_SEQ0000000001</span><br></pre></td></tr></table></figure>

<h5 id="3-3-5-创建普通临时节点"><a href="#3-3-5-创建普通临时节点" class="headerlink" title="3.3.5 创建普通临时节点"></a>3.3.5 创建普通临时节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -e:表示普通临时节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 17] create -e /Hello_ZK_Normal <span class="string">"Normal Node"</span></span><br><span class="line">Created /Hello_ZK_Normal</span><br><span class="line">[zk: localhost:2181(CONNECTED) 19] ls /</span><br><span class="line">[HelloZK, HelloZK_SEQ0000000001, Hello_ZK_Normal, zookeeper]</span><br><span class="line"><span class="comment"># 关闭客户端，再次打开查看 Hello_ZK_Normal 节点消失</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] ls /</span><br><span class="line">[HelloZK, HelloZK_SEQ0000000001, zookeeper]</span><br></pre></td></tr></table></figure>

<h5 id="3-3-6-创建带序号临时节点"><a href="#3-3-6-创建带序号临时节点" class="headerlink" title="3.3.6 创建带序号临时节点"></a>3.3.6 创建带序号临时节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -e:表示普通临时节点</span></span><br><span class="line"><span class="comment"># -s:表示带序号节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] create -e -s /Hello_ZK_SEQ_TEMP <span class="string">"Temp And Sequence"</span></span><br><span class="line">Created /Hello_ZK_SEQ_TEMP0000000003</span><br><span class="line"><span class="comment"># 关闭客户端，再次打开查看 Hello_ZK_SEQ_TEMP 节点消失</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] ls /</span><br><span class="line">[HelloZK, HelloZK_SEQ0000000001, zookeeper]</span><br></pre></td></tr></table></figure>

<h5 id="3-3-7-查询节点数据"><a href="#3-3-7-查询节点数据" class="headerlink" title="3.3.7 查询节点数据"></a>3.3.7 查询节点数据</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 7] get -s /HelloZK </span><br><span class="line">Hello,Zookeeper</span><br><span class="line">cZxid = 0x2</span><br><span class="line">ctime = Tue Jun 16 17:28:46 CST 2020</span><br><span class="line">mZxid = 0x2</span><br><span class="line">mtime = Tue Jun 16 17:28:46 CST 2020</span><br><span class="line">pZxid = 0x2</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 15</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># ­­­­­­­­­­­节点的状态信息，也称为stat结构体­­­­­­­­­­­­­­­­­­­</span><br><span class="line"># 创建该znode的事务的zxid(ZooKeeper Transaction ID)</span><br><span class="line"># 事务ID是ZooKeeper为每次更新操作&#x2F;事务操作分配一个全局唯一的id，表示zxid，值越小，表示越先执行</span><br><span class="line">cZxid &#x3D; 0x4454 # 0x0表示十六进制数0</span><br><span class="line">ctime &#x3D; Thu Jan 01 08:00:00 CST 1970  # 创建时间</span><br><span class="line">mZxid &#x3D; 0x4454 						  # 最后一次更新的zxid</span><br><span class="line">mtime &#x3D; Thu Jan 01 08:00:00 CST 1970  # 最后一次更新的时间</span><br><span class="line">pZxid &#x3D; 0x4454 						  # 最后更新的子节点的zxid</span><br><span class="line">cversion &#x3D; 5 						  # 子节点的变化号，表示子节点被修改的次数</span><br><span class="line">dataVersion &#x3D; 0 					  # 表示当前节点的数据变化号，0表示当前节点从未被修改过</span><br><span class="line">aclVersion &#x3D; 0  					  # 访问控制列表的变化号 access control list</span><br><span class="line"># 如果临时节点，表示当前节点的拥有者的sessionId</span><br><span class="line">ephemeralOwner &#x3D; 0x0				  # 如果不是临时节点，则值为0</span><br><span class="line">dataLength &#x3D; 13 					  # 数据长度</span><br><span class="line">numChildren &#x3D; 1 					  # 子节点的数量</span><br></pre></td></tr></table></figure>

<h5 id="3-3-8-修改节点数据"><a href="#3-3-8-修改节点数据" class="headerlink" title="3.3.8 修改节点数据"></a>3.3.8 修改节点数据</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 9] <span class="built_in">set</span>  /HelloZK <span class="string">"Modify HelloZK"</span></span><br><span class="line"></span><br><span class="line">WATCHER::</span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:NodeDataChanged path:/HelloZK</span><br><span class="line">[zk: localhost:2181(CONNECTED) 10] </span><br><span class="line">[zk: localhost:2181(CONNECTED) 10] get -s /HelloZK</span><br><span class="line">Modify HelloZK</span><br><span class="line">cZxid = 0x2</span><br><span class="line">ctime = Tue Jun 16 17:28:46 CST 2020</span><br><span class="line">mZxid = 0xc</span><br><span class="line">mtime = Tue Jun 16 17:40:47 CST 2020</span><br><span class="line">pZxid = 0x2</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 14</span><br><span class="line">numChildren = 0</span><br></pre></td></tr></table></figure>

<h5 id="3-3-9-创建子节点"><a href="#3-3-9-创建子节点" class="headerlink" title="3.3.9 创建子节点"></a>3.3.9 创建子节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 36] create /TestDelete</span><br><span class="line">Created /TestDelete</span><br><span class="line">[zk: localhost:2181(CONNECTED) 37] create /TestDelete/RMR</span><br><span class="line">Created /TestDelete/RMR</span><br><span class="line">[zk: localhost:2181(CONNECTED) 38]</span><br></pre></td></tr></table></figure>

<h5 id="3-3-10-删除节点"><a href="#3-3-10-删除节点" class="headerlink" title="3.3.10 删除节点"></a>3.3.10 删除节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 11] delete /HelloZK_SEQ0000000001</span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] ls /</span><br><span class="line">[HelloZK, zookeeper]</span><br></pre></td></tr></table></figure>

<h5 id="3-3-11-递归删除节点"><a href="#3-3-11-递归删除节点" class="headerlink" title="3.3.11 递归删除节点"></a>3.3.11 递归删除节点</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有子节点的使用delete会提示目录非空</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 39] delete /TestDelete</span><br><span class="line">Node not empty: /TestDelete</span><br><span class="line"><span class="comment"># 需用rmr命令删除，现已更新为deleteall</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] rmr /TestDelete</span><br><span class="line">The <span class="built_in">command</span> <span class="string">'rmr'</span> has been deprecated. Please use <span class="string">'deleteall'</span> instead.</span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] ls /</span><br><span class="line">[jsodjsd0000000011, sjdiosdjsoi, zookeeper]</span><br></pre></td></tr></table></figure>

<h5 id="3-3-12-查看节点状态"><a href="#3-3-12-查看节点状态" class="headerlink" title="3.3.12 查看节点状态"></a>3.3.12 查看节点状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 2] <span class="built_in">stat</span> /zookeeper</span><br><span class="line">cZxid = 0x0</span><br><span class="line">ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">mZxid = 0x0</span><br><span class="line">mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">pZxid = 0x0</span><br><span class="line">cversion = -2</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 2</span><br></pre></td></tr></table></figure>

<h5 id="3-3-13-日志的可视化"><a href="#3-3-13-日志的可视化" class="headerlink" title="3.3.13 日志的可视化"></a>3.3.13 日志的可视化</h5><ul>
<li><p>日志存储路径</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/Program/zk/<span class="built_in">log</span>/version-2</span><br></pre></td></tr></table></figure>
</li>
<li><p>日志都是以二进制文件存储的,需要使用命令行查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker拉取了最新镜像，需要4个jar包了</span></span><br><span class="line">$ ls | grep jar  </span><br><span class="line">log4j-1.2.17.jar</span><br><span class="line">slf4j-api-1.7.25.jar</span><br><span class="line">zookeeper-3.6.1.jar</span><br><span class="line">zookeeper-jute-3.6.1.jar</span><br><span class="line"><span class="comment"># 然后使用命令行查看</span></span><br><span class="line">$ java -classpath :./log4j-1.2.17.jar:slf4j-api-1.7.25.jar:zookeeper-3.6.1.jar:zookeeper-jute-3.6.1.jar org.apache.zookeeper.server.LogFormatter log.1</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="3-3-14-小结"><a href="#3-3-14-小结" class="headerlink" title="3.3.14 小结"></a>3.3.14 小结</h5><ul>
<li>ls 查看</li>
<li>help查看所有命令</li>
<li>create 路径 数据    -s 代表有序   -e 代临时</li>
<li>get 路径 查询</li>
<li>set 路径  新的数据</li>
<li>delete 路径 单一路径，没有子节点</li>
<li>rmr 路径 递归删除</li>
<li>stat 路径 查看节点状态</li>
<li>日志，依赖4个jar包</li>
</ul>
<h4 id="3-4-zookeeper的Java-Api介绍"><a href="#3-4-zookeeper的Java-Api介绍" class="headerlink" title="3.4 zookeeper的Java  Api介绍"></a>3.4 zookeeper的Java  Api介绍</h4><h5 id="3-4-1-ZooKeeper常用Java-API"><a href="#3-4-1-ZooKeeper常用Java-API" class="headerlink" title="3.4.1 ZooKeeper常用Java API"></a>3.4.1 ZooKeeper常用Java API</h5><ul>
<li><p>原生Java API</p>
<p>ZooKeeper 原生Java API位于org.apache.ZooKeeper包中</p>
<p>ZooKeeper-3.x.x. Jar 为官方提供的 java API</p>
</li>
<li><p><font color="blue"><strong>Apache Curator</strong></font></p>
<p>Apache Curator是 Apache ZooKeeper的Java客户端库。 </p>
<p>Curator.项目的目标是简化ZooKeeper客户端的使用。</p>
</li>
<li><p>ZkClient</p>
<p>开源的ZooKeeper客户端,zkclient-x.x.Jar也是在原生 api 基础之上进行扩展的开源 JAVA 客户端。</p>
</li>
</ul>
<h5 id="3-4-2-创建Java-Maven工程，导入依赖"><a href="#3-4-2-创建Java-Maven工程，导入依赖" class="headerlink" title="3.4.2 创建Java Maven工程，导入依赖"></a>3.4.2 创建Java Maven工程，导入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--zookeeper的依赖--&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--	zookeeper CuratorFramework 是Netflix公司开发一款连接zookeeper服务的框架，通过封装的一套高级API 简化了ZooKeeper的操作，提供了比较全面的功能，除了基础的节点的操作，节点的监听，还有集群的连接以及重试。--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--测试--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-4-3-CURD节点"><a href="#3-4-3-CURD节点" class="headerlink" title="3.4.3 CURD节点"></a>3.4.3 CURD节点</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestZookeeper</span> </span>&#123;</span><br><span class="line">  <span class="comment">//连接地址</span></span><br><span class="line">  String url = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line">  <span class="comment">//会话超时时间</span></span><br><span class="line">  <span class="keyword">int</span> sessionTimeoutMs = <span class="number">1000</span>;</span><br><span class="line">  <span class="comment">//连接超时时间</span></span><br><span class="line">  <span class="keyword">int</span> connectionTimeoutMs = <span class="number">1000</span>;</span><br><span class="line">  <span class="comment">//重试策略</span></span><br><span class="line">  RetryPolicy retryPolicy = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">//创建客户端</span></span><br><span class="line">  CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  String NodeName = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Before</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createLinkToZK</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//重试策略</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  RetryPolicy： 失败的重试策略的公共接口</span></span><br><span class="line"><span class="comment">     *  ExponentialBackoffRetry是 公共接口的其中一个实现类</span></span><br><span class="line"><span class="comment">     *      参数1： 初始化sleep的时间，用于计算之后的每次重试的sleep时间</span></span><br><span class="line"><span class="comment">     *      参数2：最大重试次数</span></span><br><span class="line"><span class="comment">            参数3（可以省略）：最大sleep时间，如果上述的当前sleep计算出来比这个大，那么sleep用这个时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//创建客户端</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 参数1：连接的ip地址和端口号</span></span><br><span class="line"><span class="comment">     * 参数2：会话超时时间，单位毫秒</span></span><br><span class="line"><span class="comment">     * 参数3：连接超时时间，单位毫秒</span></span><br><span class="line"><span class="comment">     * 参数4：失败重试策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    client = CuratorFrameworkFactory.newClient(url, sessionTimeoutMs, connectionTimeoutMs, retryPolicy);</span><br><span class="line">    <span class="comment">//启动客户端</span></span><br><span class="line">    client.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@After</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeLike</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (NodeName != <span class="keyword">null</span>) &#123;</span><br><span class="line">      requireNode(NodeName);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (NodeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">      System.out.println(<span class="string">"No Node"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//关闭客户端</span></span><br><span class="line">    client.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//1. 创建一个空节点(a)（只能创建一层节点）</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createOneLevelEmptyNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    NodeName = <span class="string">"/OneLevelEmptyNode"</span>;</span><br><span class="line">    client.create().forPath(NodeName);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//2. 创建一个有内容的b节点（只能创建一层节点）</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createOneLevelNodeWithMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    NodeName = <span class="string">"/OneLevelNodeWithMessage"</span>;</span><br><span class="line">    client.create().forPath(NodeName, <span class="string">"OneLevelNodeWithMessage"</span>.getBytes());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3. 创建持久节点，同时创建多层节点</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createMultilevelPersistentNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    NodeName = <span class="string">"/Multilevel/Persistent/Node"</span>;</span><br><span class="line">    client.create().creatingParentsIfNeeded().forPath(NodeName, <span class="string">"MultilevelPersistentNode"</span>.getBytes());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//4. 创建带有的序号的持久节点</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">creatPersistentNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//        NodeName = "/Persistent/Node";</span></span><br><span class="line">    client.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT_SEQUENTIAL).forPath(<span class="string">"/Persistent/Node"</span>, <span class="string">"PERSISTENT_SEQUENTIAL"</span>.getBytes());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//5. 创建临时节点（客户端关闭，节点消失），设置延时5秒关闭（Thread.sleep(5000)）</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">creatTempNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL).forPath(<span class="string">"/Temporary/Node"</span>, <span class="string">"Temporary Node"</span>.getBytes());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//6. 创建临时带序号节点（客户端关闭，节点消失），设置延时5秒关闭（Thread.sleep(5000)）</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">creatTempNodeWithSequenceNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL_SEQUENTIAL).forPath(<span class="string">"/TempNode/With/Sequence/Node"</span>, <span class="string">"creatTempNodeWithSequence"</span>.getBytes());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//修改节点描述</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNodeMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    NodeName = <span class="string">"/OneLevelNodeWithMessage"</span>;</span><br><span class="line">    client.setData().forPath(NodeName, <span class="string">"Update Node Message"</span>.getBytes());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//节点数据查询</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requireNode</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = client.getData().forPath(String.valueOf(s));</span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(bytes));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//删除单个节点</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteSingleNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    client.create().forPath(<span class="string">"/testAddForDelete"</span>);</span><br><span class="line">    client.delete().forPath(<span class="string">"/testAddForDelete"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//删除多个节点</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteMultiNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    client.create().creatingParentsIfNeeded().forPath(<span class="string">"/DeleteMultiNode/deleteMultiNode"</span>, <span class="string">"Create Multi NodeForDelete"</span>.getBytes());</span><br><span class="line">    client.delete().deletingChildrenIfNeeded().forPath(<span class="string">"/DeleteMultiNode"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//强制删除</span></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forceDelete</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//NodeName="/forceDelete/forceDelete";</span></span><br><span class="line">    client.create().creatingParentsIfNeeded().forPath(<span class="string">"/forceDelete/forceDelete"</span>, <span class="string">"Create Multi NodeForDelete"</span>.getBytes());</span><br><span class="line">    client.delete().guaranteed().deletingChildrenIfNeeded().forPath(<span class="string">"/forceDelete"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-4-4-小结"><a href="#3-4-4-小结" class="headerlink" title="3.4.4 小结"></a>3.4.4 小结</h5><ul>
<li><p>Curator是Appache封装操作Zookeeper的客户端, 操作zookeer数据变得更简单</p>
</li>
<li><p>使用步骤：</p>
<ul>
<li><p>创建重试策略</p>
</li>
<li><p>创建客户端  url:port</p>
</li>
<li><p>启动客户端</p>
</li>
<li><p>使用客户端对节点操作</p>
<p>– create forPath, creatingparent…….., withMode(持久，临时)</p>
<p>– setData 修改数据</p>
<p>– getData 查询数据</p>
<p>– delete 删除数据， deletingChildrenIfNeeded递归删除</p>
</li>
<li><p>关闭客户端</p>
</li>
</ul>
</li>
</ul>
<h4 id="3-5-watch机制"><a href="#3-5-watch机制" class="headerlink" title="3.5 watch机制"></a>3.5 watch机制</h4><p><img src="1573197592193.png" alt=""></p>
<h5 id="3-5-1-什么是watch机制"><a href="#3-5-1-什么是watch机制" class="headerlink" title="3.5.1 什么是watch机制"></a>3.5.1 什么是watch机制</h5><p>​    zookeeper作为一款成熟的分布式协调框架，订阅-发布功能是很重要的一个。订阅发布功能，就是观察者模式。观察者会订阅一些感兴趣的主题，然后这些主题一旦变化了，就会自动通知到这些观察者。</p>
<p>​    zookeeper的订阅发布也就是watch机制，是一个轻量级的设计。因为它采用了一种推拉结合的模式。一旦服务端感知主题变了，那么只会发送一个事件类型和节点信息给关注的客户端，而不会包括具体的变更内容，所以事件本身是轻量级的，这就是所谓的“推”部分。然后，收到变更通知的客户端需要自己去拉变更的数据，这就是“拉”部分。watche机制分为添加数据和监听节点。</p>
<p>​    Curator在这方面做了优化，Curator引入了Cache的概念用来实现对ZooKeeper服务器端进行事件监听。Cache是Curator对事件监听的包装，其对事件的监听可以近似看做是一个本地缓存视图和远程ZooKeeper视图的对比过程。而且Curator会自动的再次监听，我们就不需要自己手动的重复监听了。</p>
<p>Curator中的cache共有三种</p>
<ul>
<li>NodeCache（监听和缓存根节点变化） 只监听单一个节点(变化 添加，修改，删除)</li>
<li>PathChildrenCache（监听和缓存子节点变化） 监听这个节点下的所有子节点(变化 添加，修改，删除)</li>
<li>TreeCache（监听和缓存根节点变化和子节点变化） NodeCache+ PathChildrenCache 监听当前节点及其下的所有子节点的变化</li>
</ul>
<h5 id="3-5-2-NodeCache"><a href="#3-5-2-NodeCache" class="headerlink" title="3.5.2 NodeCache"></a>3.5.2 NodeCache</h5><ul>
<li><p>介绍</p>
<p>NodeCache是用来监听节点的数据变化的，当监听的节点的数据发生变化的时候就会回调对应的函数。</p>
</li>
<li><p>增加监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCuratorCache</span> </span>&#123;</span><br><span class="line">  <span class="comment">//连接地址</span></span><br><span class="line">  String url = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line">  <span class="comment">//会话超时时间</span></span><br><span class="line">  <span class="keyword">int</span> sessionTimeoutMs = <span class="number">1000</span>;</span><br><span class="line">  <span class="comment">//连接超时时间</span></span><br><span class="line">  <span class="keyword">int</span> connectionTimeoutMs = <span class="number">1000</span>;</span><br><span class="line">  <span class="comment">//重试策略</span></span><br><span class="line">  RetryPolicy retryPolicy = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">//创建客户端</span></span><br><span class="line">  CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Before</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createLinkToZK</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//重试策略</span></span><br><span class="line">    retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//创建客户端</span></span><br><span class="line">    client = CuratorFrameworkFactory.newClient(url, sessionTimeoutMs, connectionTimeoutMs, retryPolicy);</span><br><span class="line">    <span class="comment">//启动客户端</span></span><br><span class="line">    client.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@After</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeLike</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭客户端</span></span><br><span class="line">    client.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNodeCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    client.create().forPath(<span class="string">"/testNodeCache"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        *NodeCache(客户端, 被监听节点);</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    NodeCache nodeCache = <span class="keyword">new</span> NodeCache(client, <span class="string">"/testNodeCache"</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * true  得到数据</span></span><br><span class="line"><span class="comment">        * false 不能获取节点数据</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    nodeCache.start(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(nodeCache.getCurrentData().getData()));</span><br><span class="line"></span><br><span class="line">    client.setData().forPath(<span class="string">"/testNodeCache"</span>, <span class="string">"Update Node Cache"</span>.getBytes());</span><br><span class="line">    nodeCache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String data = <span class="keyword">new</span> String(nodeCache.getCurrentData().getData());</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">2</span>);</span><br><span class="line">        System.out.println(nodeCache.getCurrentData().getPath() + <span class="string">"  \t\t "</span> + data);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Thread.sleep(<span class="number">1000</span> * <span class="number">4</span>);</span><br><span class="line">    client.delete().forPath(<span class="string">"/testNodeCache"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
</li>
</ul>
<h5 id="3-5-3-PathChildrenCache"><a href="#3-5-3-PathChildrenCache" class="headerlink" title="3.5.3 PathChildrenCache"></a>3.5.3 PathChildrenCache</h5><ul>
<li><p>介绍</p>
<p>PathChildrenCache是用来监听指定节点 的子节点变化情况</p>
</li>
<li><p>增加监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPathChildrenCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  client.create().forPath(<span class="string">"/testPathChildrenCache"</span>);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * new PathChildrenCache(客户端, 节点 , 是/否得到数据);</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">  PathChildrenCache pathChildrenCache = <span class="keyword">new</span> PathChildrenCache(client, <span class="string">"/testPathChildrenCache"</span>, <span class="keyword">true</span>);</span><br><span class="line">  <span class="comment">///**</span></span><br><span class="line">  <span class="comment">// * NORMAL:  普通启动方式, 在启动时缓存子节点数据</span></span><br><span class="line">  <span class="comment">// * POST_INITIALIZED_EVENT：在启动时缓存子节点数据，提示初始化</span></span><br><span class="line">  <span class="comment">// * BUILD_INITIAL_CACHE: 在启动时什么都不会输出</span></span><br><span class="line">  <span class="comment">// *  在官方解释中说是因为这种模式会在start执行执行之前先执行rebuild的方法，而rebuild的方法不会发出任何事件通知。</span></span><br><span class="line">  <span class="comment">// */</span></span><br><span class="line">  pathChildrenCache.start(PathChildrenCache.StartMode.POST_INITIALIZED_EVENT);</span><br><span class="line"></span><br><span class="line">  System.out.println(pathChildrenCache.getCurrentData());</span><br><span class="line"></span><br><span class="line">  client.create().forPath(<span class="string">"/testPathChildrenCache/A"</span>);</span><br><span class="line">  client.setData().forPath(<span class="string">"/testPathChildrenCache/A"</span>, <span class="string">"Update Node Message"</span>.getBytes());</span><br><span class="line">  pathChildrenCache.getListenable().addListener(<span class="keyword">new</span> PathChildrenCacheListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework curatorFramework, PathChildrenCacheEvent pathChildrenCacheEvent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (pathChildrenCacheEvent.getType() == PathChildrenCacheEvent.Type.CHILD_UPDATED) &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"CHILD_UPDATED Node: "</span>+pathChildrenCacheEvent.getData().getPath());</span><br><span class="line">        System.out.println(<span class="string">"CHILD_UPDATED Node Date :"</span>+<span class="keyword">new</span> String(pathChildrenCacheEvent.getData().getPath()));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathChildrenCacheEvent.getType() == PathChildrenCacheEvent.Type.INITIALIZED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"Initialization"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathChildrenCacheEvent.getType() == PathChildrenCacheEvent.Type.CHILD_REMOVED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CHILD_REMOVED Node: "</span>+pathChildrenCacheEvent.getData().getPath());</span><br><span class="line">        System.out.println(<span class="string">"CHILD_REMOVED Node Date :"</span>+<span class="keyword">new</span> String(pathChildrenCacheEvent.getData().getPath()));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathChildrenCacheEvent.getType() == PathChildrenCacheEvent.Type.CHILD_ADDED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CHILD_ADDED Node: "</span>+pathChildrenCacheEvent.getData().getPath());</span><br><span class="line">        System.out.println(<span class="string">"CHILD_ADDED Node Date :"</span>+<span class="keyword">new</span> String(pathChildrenCacheEvent.getData().getPath()));</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathChildrenCacheEvent.getType() == PathChildrenCacheEvent.Type.CONNECTION_SUSPENDED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CONNECTION_SUSPENDED"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathChildrenCacheEvent.getType() == PathChildrenCacheEvent.Type.CONNECTION_RECONNECTED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CONNECTION_RECONNECTED"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pathChildrenCacheEvent.getType() == PathChildrenCacheEvent.Type.CONNECTION_LOST) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CONNECTION_LOST"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">client.delete().guaranteed().deletingChildrenIfNeeded().forPath(<span class="string">"/testPathChildrenCache"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="3-5-4-TreeCache"><a href="#3-5-4-TreeCache" class="headerlink" title="3.5.4 TreeCache"></a>3.5.4 TreeCache</h5><ul>
<li><p>介绍</p>
<p>TreeCache有点像上面两种Cache的结合体，NodeCache能够监听自身节点的数据变化（或者是创建该节点），PathChildrenCache能够监听自身节点下的子节点的变化，而TreeCache既能够监听自身节点的变化、也能够监听子节点的变化。</p>
</li>
<li><p>添加监听</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTreeCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  client.create().forPath(<span class="string">"/testTreeCache"</span>);</span><br><span class="line">  <span class="comment">//监听当前Node Data Tree</span></span><br><span class="line">  TreeCache treeCache = <span class="keyword">new</span> TreeCache(client, <span class="string">"/testTreeCache"</span>);</span><br><span class="line">  treeCache.start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  System.out.println(treeCache.getCurrentData(<span class="string">"/testTreeCache"</span>));</span><br><span class="line"></span><br><span class="line">  treeCache.getListenable().addListener(<span class="keyword">new</span> TreeCacheListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework curatorFramework, TreeCacheEvent treeCacheEvent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (treeCacheEvent.getType() == TreeCacheEvent.Type.NODE_ADDED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"NODE_ADDED: "</span>+treeCacheEvent.getData().getPath());</span><br><span class="line"></span><br><span class="line">        client.delete().deletingChildrenIfNeeded().forPath(<span class="string">"/testTreeCache/Test"</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (treeCacheEvent.getType() == TreeCacheEvent.Type.NODE_REMOVED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"NODE_REMOVED: "</span>+treeCacheEvent.getData().getPath());</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (treeCacheEvent.getType() == TreeCacheEvent.Type.NODE_UPDATED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"NODE_UPDATED: "</span>+treeCacheEvent.getData().getPath());</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (treeCacheEvent.getType() == TreeCacheEvent.Type.INITIALIZED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"INITIALIZED"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (treeCacheEvent.getType() == TreeCacheEvent.Type.CONNECTION_SUSPENDED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CONNECTION_SUSPENDED"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (treeCacheEvent.getType() == TreeCacheEvent.Type.CONNECTION_RECONNECTED) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CONNECTION_RECONNECTED"</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (treeCacheEvent.getType() == TreeCacheEvent.Type.CONNECTION_LOST) &#123;</span><br><span class="line">        System.out.println(<span class="string">"CONNECTION_LOST"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  client.delete().guaranteed().deletingChildrenIfNeeded().forPath(<span class="string">"/testTreeCache"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="3-5-5-小结"><a href="#3-5-5-小结" class="headerlink" title="3.5.5 小结"></a>3.5.5 小结</h5><ul>
<li><p>Zookeeper：分布小文件存储系统，树形层级数据结构，路径唯一</p>
<ul>
<li>动物管理员，管的是服务</li>
<li>应用：注册中心、配置中心、分布式锁、分布式队列、负载均衡</li>
</ul>
</li>
<li><p>配置zoo.cfg dataPath, 2181</p>
</li>
<li><p>节点类型：持久化（有序与无序 -s），临时（-e 临时， -s 有序与无序) crud</p>
</li>
<li><p>api: Curator 创建重试策略-&gt;客户端(url ip:port)-&gt;启动-&gt;使用client操作crud-&gt;关闭</p>
</li>
<li><p>Watch: 监听节点数据变化，一旦生变更（添加、修改、删除）时，服务端通知客户端（addListener)</p>
</li>
<li><p>NodeCache: 听监听单一节点变化</p>
<ul>
<li>PathChildrenCache: 监听节点下的子节点</li>
</ul>
</li>
<li><p>TreeCache: NodeCache+PathChildrenCache  </p>
</li>
</ul>
<h1 id="四-zookeeper集群搭建"><a href="#四-zookeeper集群搭建" class="headerlink" title="四.zookeeper集群搭建"></a>四.zookeeper集群搭建</h1><ul>
<li><p>目标</p>
<p>搭建Zookeeper集群</p>
</li>
<li><p>操作路径</p>
<ul>
<li><p>了解集群</p>
<ul>
<li>集群介绍</li>
<li>集群模式</li>
</ul>
</li>
<li><p>集群原理及架构图</p>
</li>
</ul>
</li>
<li><p>搭建集群（使用linux）</p>
<ul>
<li>集群中Leader选举机制</li>
</ul>
</li>
<li><p>测试集群</p>
</li>
</ul>
<h4 id="4-1-了解集群"><a href="#4-1-了解集群" class="headerlink" title="4.1 了解集群"></a>4.1 了解集群</h4><h5 id="4-1-1-集群介绍"><a href="#4-1-1-集群介绍" class="headerlink" title="4.1.1 集群介绍"></a>4.1.1 集群介绍</h5><p>Zookeeper 集群搭建指的是 ZooKeeper 分布式模式安装。 通常由 2n+1台 servers 组成 奇数。 这是因为为了保证 Leader 选举（基于 Paxos 算法的实现） 能或得到多数的支持，所以 ZooKeeper 集群的数量一般为奇数。</p>
<h5 id="4-1-2-集群模式"><a href="#4-1-2-集群模式" class="headerlink" title="4.1.2 集群模式"></a>4.1.2 集群模式</h5><ul>
<li>伪分布式集群搭建</li>
<li>完全分布式集群搭建</li>
</ul>
<h4 id="4-2-架构图"><a href="#4-2-架构图" class="headerlink" title="4.2 架构图"></a>4.2 架构图</h4><p><img src="1573475887256.png" alt=""></p>
<p>集群工作的核心<br>事务请求（写操作） 的唯一调度和处理者，保证集群事务处理的顺序性；<br>集群内部各个服务器的调度者。<br>对于 create， setData， delete 等有写操作的请求，则需要统一转发给leader 处理， leader 需要决定编号、执行操作，这个过程称为一个事务。</p>
<ul>
<li><p>Leader<strong>:</strong>Zookeeper(领导者):</p>
<p>集群工作的核心<br>事务请求（写操作） 的唯一调度和处理者，保证集群事务处理的顺序性；<br>集群内部各个服务器的调度者。<br>对于 create， setData， delete 等有写操作的请求，则需要统一转发给leader 处理， leader 需要决定编号、执行操作，这个过程称为一个事务。</p>
</li>
<li><p>Follower（跟随者）</p>
<p>处理客户端非事务（读操作） 请求，转发事务请求给 Leader；参与集群 Leader 选举投票 2n-1台可以做集群投票。</p>
</li>
<li><p>Observer:观察者角色</p>
<p>针对访问量比较大的 zookeeper 集群， 还可新增观察者角色。观察 Zookeeper 集群的最新状态变化并将这些状态同步过来，其对于非事务请求可以进行独立处理，对于事务请求，则会转发给 Leader服务器进行处理。<br>不会参与任何形式的投票只提供非事务服务，通常用于在不影响集群事务处理能力的前提下提升集群的非事务处理能力。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4></li>
</ul>
<h4 id="4-3-搭建过程"><a href="#4-3-搭建过程" class="headerlink" title="4.3 搭建过程"></a>4.3 搭建过程</h4><h5 id="4-3-1-配置zookeeper-compose-yml"><a href="#4-3-1-配置zookeeper-compose-yml" class="headerlink" title="4.3.1 配置zookeeper-compose.yml"></a>4.3.1 配置zookeeper-compose.yml</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'2'</span></span><br><span class="line">services:</span><br><span class="line">    zoo1:</span><br><span class="line">        image: zookeeper:3.4.14</span><br><span class="line">        restart: always</span><br><span class="line">        container_name: zoo1</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">"2181:2181"</span></span><br><span class="line">        environment:</span><br><span class="line">            ZOO_MY_ID: 1</span><br><span class="line">            ZOO_SERVERS: server.1=zoo1:2888:3888 server.2=zoo2:2888:3888 server.3=zoo3:2888:3888</span><br><span class="line"> </span><br><span class="line">    zoo2:</span><br><span class="line">        image: zookeeper:3.4.14</span><br><span class="line">        restart: always</span><br><span class="line">        container_name: zoo2</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">"2182:2181"</span></span><br><span class="line">        environment:</span><br><span class="line">            ZOO_MY_ID: 2</span><br><span class="line">            ZOO_SERVERS: server.1=zoo1:2888:3888 server.2=zoo2:2888:3888 server.3=zoo3:2888:3888</span><br><span class="line"> </span><br><span class="line">    zoo3:</span><br><span class="line">        image: zookeeper:3.4.14</span><br><span class="line">        restart: always</span><br><span class="line">        container_name: zoo3</span><br><span class="line">        ports:</span><br><span class="line">            - <span class="string">"2183:2181"</span></span><br><span class="line">        environment:</span><br><span class="line">            ZOO_MY_ID: 3</span><br><span class="line">            ZOO_SERVERS: server.1=zoo1:2888:3888 server.2=zoo2:2888:3888 server.3=zoo3:2888:3888</span><br></pre></td></tr></table></figure>

<p>这个配置文件会告诉 Docker 分别运行三个 zookeeper 镜像, 并分别将本地的 2181, 2182, 2183 端口绑定到对应的容器的2181端口上.<br><strong>ZOO_MY_ID</strong> 和 <strong>ZOO_SERVERS</strong> 是搭建 ZK 集群需要设置的两个环境变量, 其中 <strong>ZOO_MY_ID</strong> 表示 ZK 服务的 id, 它是1-255 之间的整数, 必须在集群中唯一. <strong>ZOO_SERVERS</strong> 是ZK 集群的主机列表.</p>
<h5 id="4-3-2-启动zookeeper"><a href="#4-3-2-启动zookeeper" class="headerlink" title="4.3.2 启动zookeeper"></a>4.3.2 启动zookeeper</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker-compose -f zookeeper-compose.yml up -d  </span><br><span class="line">Creating network <span class="string">"program_default"</span> with the default driver</span><br><span class="line">Creating zoo3 ... <span class="keyword">done</span></span><br><span class="line">Creating zoo2 ... <span class="keyword">done</span></span><br><span class="line">Creating zoo1 ... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h5 id="4-3-3-查看zookeeper状态"><a href="#4-3-3-查看zookeeper状态" class="headerlink" title="4.3.3 查看zookeeper状态"></a>4.3.3 查看zookeeper状态</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                        NAMES</span><br><span class="line">63dacd015bf9        zookeeper:3.4.14    <span class="string">"/docker-entrypoint.…"</span>   6 minutes ago       Up 6 minutes        2888/tcp, 0.0.0.0:2181-&gt;2181/tcp, 3888/tcp   zoo1</span><br><span class="line">2bfaa57664f9        zookeeper:3.4.14    <span class="string">"/docker-entrypoint.…"</span>   6 minutes ago       Up 6 minutes        2888/tcp, 3888/tcp, 0.0.0.0:2182-&gt;2181/tcp   zoo2</span><br><span class="line">4ff61abb0d2f        zookeeper:3.4.14    <span class="string">"/docker-entrypoint.…"</span>   6 minutes ago       Up 6 minutes        2888/tcp, 3888/tcp, 0.0.0.0:2183-&gt;2181/tcp   zoo3</span><br></pre></td></tr></table></figure>

<h4 id="4-4-leader选举"><a href="#4-4-leader选举" class="headerlink" title="4.4 leader选举"></a>4.4 leader选举</h4><p><strong>在领导者选举的过程中，如果某台ZooKeeper获得了超过半数的选票，则此ZooKeeper就可以成为Leader了。</strong></p>
<ul>
<li><p><strong>服务器1</strong>启动，给自己投票，然后发投票信息，由于其它机器还没有启动所以它收不到反馈信息，服务器1的状态一直属于Looking(选举状态)。</p>
</li>
<li><p><strong>服务器2</strong>启动，给自己投票，同时与之前启动的服务器1交换结果，</p>
<p>每个Server发出一个投票由于是初始情况，1和2都会将自己作为Leader服务器来进行投票，每次投票会包含所推举的服务器的myid和ZXID，使用(myid, ZXID)来表示，此时1的投票为(1, 0)，2的投票为(2, 0)，然后各自将这个投票发给集群中其他机器。<br>接受来自各个服务器的投票集群的每个服务器收到投票后，首先判断该投票的有效性，如检查是否是本轮投票、是否来自LOOKING状态的服务器</p>
<p>处理投票。针对每一个投票，服务器都需要将别人的投票和自己的投票进行PK，PK规则如下</p>
<p>　　　　· 优先检查ZXID。ZXID比较大的服务器优先作为Leader。</p>
<p>　　　　· 如果ZXID相同，那么就比较myid。myid较大的服务器作为Leader服务器</p>
<p>由于服务器2的编号大，更新自己的投票为(2, 0)，然后重新投票，对于2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次投票信息即可，此时集群节点状态为LOOKING。</p>
<p>统计投票。每次投票后，服务器都会统计投票信息，判断是否已经有过半机器接受到相同的投票信息</p>
</li>
<li><p><strong>服务器3</strong>启动，进行统计后，判断是否已经有过半机器接受到相同的投票信息，对于1、2、3而言，已统计出集群中已经有3台机器接受了(3, 0)的投票信息，此时投票数正好大于半数，便认为已经选出了Leader，</p>
<p>改变服务器状态。一旦确定了Leader，每个服务器就会更新自己的状态，如果是Follower，那么就变更为FOLLOWING，如果是Leader，就变更为LEADING</p>
<p>所以服务器3成为领导者，服务器1,2成为从节点。</p>
</li>
</ul>
<h4 id="4-5-测试集群"><a href="#4-5-测试集群" class="headerlink" title="4.5 测试集群"></a>4.5 测试集群</h4><p>测试使用任何一个IP都可以获取</p>
<p>测试如果有个机器宕机，（./zkServer.sh stop），会重新选取领导者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestZookeeperCluster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeLike</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//关闭客户端</span></span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">1</span>);</span><br><span class="line">        CuratorFramework client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2181"</span>, <span class="number">3000</span>, <span class="number">3000</span>, retryPolicy);</span><br><span class="line">        client.start();</span><br><span class="line">        client.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).forPath(<span class="string">"/createNode/Nodes"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//创建失败策略对象</span></span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">1</span>);</span><br><span class="line">        client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2182"</span>, <span class="number">1000</span>, <span class="number">1000</span>, retryPolicy);</span><br><span class="line">        client.start();</span><br><span class="line">        client.setData().forPath(<span class="string">"/createNode/Nodes"</span>, <span class="string">"Update Node"</span>.getBytes());</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getData</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">1</span>);</span><br><span class="line">        client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2183"</span>, <span class="number">1000</span>, <span class="number">1000</span>, retryPolicy);</span><br><span class="line">        client.start();</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = client.getData().forPath(<span class="string">"/createNode/Nodes"</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(bytes));</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">1</span>);</span><br><span class="line">        client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2183"</span>, <span class="number">1000</span>, <span class="number">1000</span>, retryPolicy);</span><br><span class="line">        client.start();</span><br><span class="line">        client.delete().deletingChildrenIfNeeded().forPath(<span class="string">"/createNode"</span>);</span><br><span class="line">        client.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-6-小结"><a href="#4-6-小结" class="headerlink" title="4.6 小结"></a>4.6 小结</h4><ul>
<li><p>什么是集群：把具有相同功能应用布署多个到网络中，聚集一起，实现数据的同步，一旦有应用服务挂了，集群中的其它应用服务可以顶上，保证应用的正常运作</p>
</li>
<li><p>Zookeeper集群架构</p>
<ul>
<li><p>Leader领导者 可以进行读写，写操作成功后会同步到各个从和观察者</p>
</li>
<li><p>Follower跟从者 只能读，如果有写操作时则转给Leader领导者处理 参与选举</p>
</li>
<li><p>Observer观察者 只能读，有写时也会转给Leader, 不参与Leader的选举</p>
</li>
<li><p>集群服务器个要为奇数2n+1，防止服务器down机，可以选举出新的leader</p>
</li>
</ul>
</li>
<li><p>Leader先举机制</p>
<p>  先投自己一票，票数相同时 票数&gt;zxid&gt;myid，其它zookeeper改为大者一票。集群中半数以上的票数才能成Leader</p>
</li>
</ul>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/06/15/Maven%20&%20Git/" rel="prev" title="Maven & Git">
      <i class="fa fa-chevron-left"></i> Maven & Git
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/06/19/Apache%20Dubbo%20%E5%88%9D%E8%AF%86/" rel="next" title="Apache Dubbo 初识">
      Apache Dubbo 初识 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-介绍zookeeper"><span class="nav-number">1.</span> <span class="nav-text">一. 介绍zookeeper</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-zookeeper概述"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">1.1 zookeeper概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-zookeeper被大量使用"><span class="nav-number">1.0.0.2.</span> <span class="nav-text">1.2 zookeeper被大量使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-什么是分布式"><span class="nav-number">1.0.0.3.</span> <span class="nav-text">1.3 什么是分布式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-1-集中式系统"><span class="nav-number">1.0.0.3.1.</span> <span class="nav-text">1.3.1 集中式系统</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-2-分布式系统"><span class="nav-number">1.0.0.4.</span> <span class="nav-text">1.3.2 分布式系统</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-3-3-小结"><span class="nav-number">1.0.0.4.1.</span> <span class="nav-text">1.3.3 小结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-zookeeper的应用场景"><span class="nav-number">1.0.0.5.</span> <span class="nav-text">1.4 zookeeper的应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-1-注册中心"><span class="nav-number">1.0.0.5.1.</span> <span class="nav-text">1.4.1 注册中心</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-2-配置中心"><span class="nav-number">1.0.0.5.2.</span> <span class="nav-text">1.4.2 配置中心</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-3-分布式锁——非公平锁"><span class="nav-number">1.0.0.5.3.</span> <span class="nav-text">1.4.3 分布式锁——非公平锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-4-分布式队列——公平锁"><span class="nav-number">1.0.0.5.4.</span> <span class="nav-text">1.4.4 分布式队列——公平锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-5-负载均衡"><span class="nav-number">1.0.0.5.5.</span> <span class="nav-text">1.4.5 负载均衡</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-4-6-小结"><span class="nav-number">1.0.0.5.6.</span> <span class="nav-text">1.4.6 小结</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-zookeeper环境搭建"><span class="nav-number">2.</span> <span class="nav-text">二.zookeeper环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-前提"><span class="nav-number">2.0.0.1.</span> <span class="nav-text">2.1 前提</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2安装zookeeper"><span class="nav-number">2.0.0.2.</span> <span class="nav-text">2.2安装zookeeper</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-下载"><span class="nav-number">2.0.0.2.1.</span> <span class="nav-text">2.2.1 下载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-2-修改配置文件"><span class="nav-number">2.0.0.2.2.</span> <span class="nav-text">2.2.2 修改配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-3-启动zookeeper"><span class="nav-number">2.0.0.2.3.</span> <span class="nav-text">2.2.3 启动zookeeper</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-4-启动客户端测试"><span class="nav-number">2.0.0.2.4.</span> <span class="nav-text">2.2.4 启动客户端测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-5-小结"><span class="nav-number">2.0.0.2.5.</span> <span class="nav-text">2.2.5 小结</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-zookeeper基本操作"><span class="nav-number">3.</span> <span class="nav-text">三.zookeeper基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-zookeeper数据结构"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">3.1 zookeeper数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-节点的分类"><span class="nav-number">3.0.0.2.</span> <span class="nav-text">3.2 节点的分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-客户端命令"><span class="nav-number">3.0.0.3.</span> <span class="nav-text">3.3 客户端命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-1-查询所有命令"><span class="nav-number">3.0.0.3.1.</span> <span class="nav-text">3.3.1 查询所有命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-2-查询根路径下的节点"><span class="nav-number">3.0.0.3.2.</span> <span class="nav-text">3.3.2 查询根路径下的节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-3-创建普通永久节点"><span class="nav-number">3.0.0.3.3.</span> <span class="nav-text">3.3.3 创建普通永久节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-4-创建带序号永久节点"><span class="nav-number">3.0.0.3.4.</span> <span class="nav-text">3.3.4 创建带序号永久节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-5-创建普通临时节点"><span class="nav-number">3.0.0.3.5.</span> <span class="nav-text">3.3.5 创建普通临时节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-6-创建带序号临时节点"><span class="nav-number">3.0.0.3.6.</span> <span class="nav-text">3.3.6 创建带序号临时节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-7-查询节点数据"><span class="nav-number">3.0.0.3.7.</span> <span class="nav-text">3.3.7 查询节点数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-8-修改节点数据"><span class="nav-number">3.0.0.3.8.</span> <span class="nav-text">3.3.8 修改节点数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-9-创建子节点"><span class="nav-number">3.0.0.3.9.</span> <span class="nav-text">3.3.9 创建子节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-10-删除节点"><span class="nav-number">3.0.0.3.10.</span> <span class="nav-text">3.3.10 删除节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-11-递归删除节点"><span class="nav-number">3.0.0.3.11.</span> <span class="nav-text">3.3.11 递归删除节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-12-查看节点状态"><span class="nav-number">3.0.0.3.12.</span> <span class="nav-text">3.3.12 查看节点状态</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-13-日志的可视化"><span class="nav-number">3.0.0.3.13.</span> <span class="nav-text">3.3.13 日志的可视化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-3-14-小结"><span class="nav-number">3.0.0.3.14.</span> <span class="nav-text">3.3.14 小结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-zookeeper的Java-Api介绍"><span class="nav-number">3.0.0.4.</span> <span class="nav-text">3.4 zookeeper的Java  Api介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-1-ZooKeeper常用Java-API"><span class="nav-number">3.0.0.4.1.</span> <span class="nav-text">3.4.1 ZooKeeper常用Java API</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-2-创建Java-Maven工程，导入依赖"><span class="nav-number">3.0.0.4.2.</span> <span class="nav-text">3.4.2 创建Java Maven工程，导入依赖</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-3-CURD节点"><span class="nav-number">3.0.0.4.3.</span> <span class="nav-text">3.4.3 CURD节点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-4-小结"><span class="nav-number">3.0.0.4.4.</span> <span class="nav-text">3.4.4 小结</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-watch机制"><span class="nav-number">3.0.0.5.</span> <span class="nav-text">3.5 watch机制</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-5-1-什么是watch机制"><span class="nav-number">3.0.0.5.1.</span> <span class="nav-text">3.5.1 什么是watch机制</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-5-2-NodeCache"><span class="nav-number">3.0.0.5.2.</span> <span class="nav-text">3.5.2 NodeCache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-5-3-PathChildrenCache"><span class="nav-number">3.0.0.5.3.</span> <span class="nav-text">3.5.3 PathChildrenCache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-5-4-TreeCache"><span class="nav-number">3.0.0.5.4.</span> <span class="nav-text">3.5.4 TreeCache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-5-5-小结"><span class="nav-number">3.0.0.5.5.</span> <span class="nav-text">3.5.5 小结</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-zookeeper集群搭建"><span class="nav-number">4.</span> <span class="nav-text">四.zookeeper集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-了解集群"><span class="nav-number">4.0.0.1.</span> <span class="nav-text">4.1 了解集群</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-集群介绍"><span class="nav-number">4.0.0.1.1.</span> <span class="nav-text">4.1.1 集群介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-2-集群模式"><span class="nav-number">4.0.0.1.2.</span> <span class="nav-text">4.1.2 集群模式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-架构图"><span class="nav-number">4.0.0.2.</span> <span class="nav-text">4.2 架构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">4.0.0.3.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-搭建过程"><span class="nav-number">4.0.0.4.</span> <span class="nav-text">4.3 搭建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-1-配置zookeeper-compose-yml"><span class="nav-number">4.0.0.4.1.</span> <span class="nav-text">4.3.1 配置zookeeper-compose.yml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-2-启动zookeeper"><span class="nav-number">4.0.0.4.2.</span> <span class="nav-text">4.3.2 启动zookeeper</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-3-3-查看zookeeper状态"><span class="nav-number">4.0.0.4.3.</span> <span class="nav-text">4.3.3 查看zookeeper状态</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-leader选举"><span class="nav-number">4.0.0.5.</span> <span class="nav-text">4.4 leader选举</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-5-测试集群"><span class="nav-number">4.0.0.6.</span> <span class="nav-text">4.5 测试集群</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-6-小结"><span class="nav-number">4.0.0.7.</span> <span class="nav-text">4.6 小结</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description">学习笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">102</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
